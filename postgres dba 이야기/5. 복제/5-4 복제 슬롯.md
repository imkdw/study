## 복제 슬롯
- 복제 진행 상태를 기록하기 위해 사용하는 구조체
- 물리, 논리 모두 사용이 가능하지만 노리에서는 반드시 필요함
- 복제를 재구성하는 작업은 시간이 많이 소요되므로 복제 대상 WAL 파일을 유지하는것은 매우 중요함
- 슬롯을 사용하면 복제 대상 WAL 파일이 삭제되는걸 방지할 수 있으므로 안정성을 확보할 때 매우 중요한 도구임

<br>

### 복제 슬롯이 필요한 이유
- 복제 슬롯 내부에 진행 완료 위치를 기록하고 아직 미전송된 WAL 파일이 삭제되지 않도록 보존해줌
- 논리 복제를 재개할 때 복제 시작 위치를 정확히 확인할 수 있음

<br>

## 미사용 슬롯으의 문제점
- 슬롯을 사용하면 WAL 파일이 WAL 디스크 볼륨에 보존된다는 장점이 있음
- 하지만 WAL 디스크 볼륨이 가득 차서 인스턴스가 비정상적으로 종료되는 문제가 발생할 수 있음
- 복제 안정성을 위한 복제 슬롯이 오히려 서비스의 가용성을 떨어트릴수 있기때문에 지속적인 모니터링이 매우 중요함

<br>

### 슬롯 상태 확인
- 정상적인 경우 active 슬롯은 `t` 값을 가지며 active_pid 컬럼에는 연결된 walsender 프로세스의 PID를 가짐
- 현재 LSN과 `confirmed_flush_lsn` 값의 차이를 통해서 복제 지연 상태를 확인할 수 있음
  - 복제가 끝나면 해당 값은 0이됨
```sql
postgres=# select slot_name, active, active_pid, confirmed_flush_lsn, pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn)) as flush_lag_sz
from pg_replication_slots;
                slot_name                | active | active_pid | confirmed_flush_lsn | flush_lag_sz 
-----------------------------------------+--------+------------+---------------------+--------------
 sub_svc_tb1                             | t      |       2234 | 0/187D088           | 0 bytes
 pg_16407_sync_16389_7568446880728596519 | f      |            | 0/187C858           | 2096 bytes
 sub_from_db1                            | t      |       2235 | 0/187D088           | 0 bytes
(3 rows)
```

<br>

## WAL 디스크 볼륨 공간 부족으로 인스턴스 비정상 종료시 조치 방법
- 비정상 종료시에 서비스를 정상화 하는게 우선이다
- 인스턴스 복구에 필요한 WAL만 남겨두고 나머지는 삭제 처리한다
- 이 때 인스턴스 복구에 필요한 WAL은 마지막 체크포인트 이후에 생성된 WAL 이다

<br>

### 마지막 체크포인트 파일 확인
```bash
root@b20fa9478609:/# pg_controldata
# ...
Latest checkpoint's REDO WAL file:    000000010000000000000001
# ...
```

<br>

### 이후 작업
- 위 체크포인트 파일만 남겨두고 WAL 전용 디스크 볼륨에서 나머지는 삭제한다
- 이후에 `select pg_drop_replication_slot(<slot_name>)`을 통해서 미사용 슬롯을 삭제한다

<br>

## max_slot_wal_keep_size 파라미터를 이용한 장애 방지 방안
- 해당 파라미터는 복제 슬롯을 유지할 WAL 파일의 최대 크기를 제한한다
- 내부적으로 `wal_keep_size` 파라미터와 비교해서 더 큰 사이즈가 WAL 파일의 최대 크기가 된다
- 위 파라미터들을 WAL 볼륨 크기보다 작게 설정하면 복제 슬롯으로 인한 장애를 사전에 방지할 수 있다
- 일반적으로는 WAL 디스크 볼륨의 `80%` 정도로 설정하는 것이 적절하다