## 물리 백업과 복구
- 물리 백업은 디비 클러스터를 구성하는 파일 단위의 백업을 의미함
- 디비 가동중에 수행하는 온라인 백업과 종료하고 수행하는 오프라인 백업으로 구분된다
- 물리 백업의 가장 큰 장점은 장애 시점까지의 완벽한 복구를 지원한다는 점이다
- 또한 유저의 실수로 데이터가 삭제되어도 손실 직전 시점까지 복구할 수 있는 시점 복구 기능도 함께 제공함

<br>

### 명령어
- `pg_basebackup` 또는 `pg_backup_start`, `pg_backup_end` 함수를 이용해서 수행이 가능하다
- 여기서 가장 강력한 백업 및 복구 기능을 제공하는 도구는 `pgBackRest` 이다

<br>

## 백업 및 복구 개요
- 복구의 목표는 트랜잭션 유실이 없는 `완벽한 복구`를 실현하는데 있다
- 이를 위해서는 단순히 백업을 수행하는 것뿐만 아니라 백업 주기, 보관 기간 등 백업 전반에 대한 전략을 사전에 마련하는게 중요하다

<br>

### 일반적인 백업 유형
- 전체 백업 : 클러스터 내의 모든 파일을 백업한다
- 증분 백업 : 마지막 증분 백업 이후에 변경된 내용만 백업한다
- 차등 백업 : 마지막 전체 백업 이후에 변경된 내용만 백업한다

<br>

### 완벽한 복구를 위한 백업 데이터 세트
- 완벽한 복구를 수행하기 위해서는 장애 시점까지 생성된 모든 WAL 파일이 필요하다
- 증분 백업을 수행한 경우 마지막 전체 백업, 모든 증분 백업, 마지막 증분 백업 이후의 WAL 파일이 필요하다
- 차등 백업을 수행한 경우 마지막 전체 백업, 마지막 차등 백업, 해당 시점 이후의 WAL 파일이 필요하다
- 증분의 경우 백업 속도는 빠르지만 전체 백업 주기가 길수록 복구 대상이 많아지고 그에 따라 복구 시간이 늘어날 수 있다
- 차등 백업은 전체 백업 이후의 변경분을 백업하므로 일반적으로 복구 속도 측면에서는 차등 백업 방식이 더 유리하다

<br>

### 백업 주기
- 복구 시간 관점에서 보면 전체 백업을 매일 수행하는게 가장 이상적이다
- 매일 전체 백업을 수행할 수 있는 시스템 환경이라면 전체 백업만으로 운영하는게 가장 효율적이다
- 만약 어려운 경우는 전체 백업은 주 1회, 차등/증분 백업을 매일 수행하는 방식으로 하는게 일반적이다

<br>

### 백업 파일 보관 기간
- 백업 파일을 장기간 보관할 필요는 없지만 다양한 상황을 고려해 보관 기간을 더 길게 설정하는 경우가 많다
- 만먁 1주일 전 상태로 되돌려야 한다면 해당 시점의 백업 파일이 반드시 있어야한다
- 위 같은 이유로 일반적으로 1주 ~ 1달 범위 내에서 백업 파일 보관 기간을 설정한다

<br>

### 백업 툴 선정
- 버전 16 까지는 `pgBackRest`를 사용하는게 모든 측면에서 유리하다
- 하지만 버전 17 부터는 `pg_basebackup`이 강력한 `증분 백업`을 지원해서 적절한 툴을 선택하면된다
- `pgRestBack`도 증분 백업을 제공하지만 이는 변경된 파일 단위의 증분 백업이다
  - 1GB 파일에서 1B만 변경되도 1GB 파일을 다시 백업해야한다
- `pg_basebackup`의 증분 백업은 변경된 블록 단위로 동작하므로 백업 시간/용량을 모두 줄일 수 있다
- 증분 백업 방식을 제외한 모든 항목은 `pgBackRest`가 우수하다
- 델타 복구가 매우 중요한데 PG는 데이터 파일중 하나라도 손실되면 전체를 복구해야하는데 델타 복구를 통해서 손상된 파일만 복원하고 복구 작업 진행이 가능하다

<br>

## pgBackRest 설치 및 환경 파일 설정
이후 실제 복구 과정은 생략