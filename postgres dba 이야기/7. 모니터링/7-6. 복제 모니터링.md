## 복제 모니터링
- 복제는 일반적으로 비동기 방식을 사용함
- 대량의 트랜잭션이 발생하면 복제 지연 현상이 발생하게된다
- 복제 지연이 발생하는 경우 복제 지연된 WAL 용량과 복제 지연 시간을 함께 분석이 필요하다
- 또한 각 단계별 지연 정도도 확인이 필요한데 `pg_stat_replication` 뷰를 통해서 확인이 가능함

<br>

## pg_stat_replication 뷰를 이용한 복제 지연 분석
- 복제 지연 시간은 `_lag`로 끝나는 3개의 컬럼을 통해서 확인이 가능함
- 각 단계별로 LSN 값의 차이를 통해서 복제 지연 용량도 확인이 가능함
- `pg_wal_lsn_diff` 함수를 통해서 차이를 계산할 수 있음

<br>

### pg_stat_replication 뷰
- 내부에는 다양한 lsn 관련된 컬럼과 지연 시간 컬럼이 존재함

```sql
postgres=# \d pg_stat_replication;
                    View "pg_catalog.pg_stat_replication"
      Column      |           Type           | Collation | Nullable | Default 
------------------+--------------------------+-----------+----------+---------
 pid              | integer                  |           |          | 
 usesysid         | oid                      |           |          | 
 usename          | name                     |           |          | 
 application_name | text                     |           |          | 
 client_addr      | inet                     |           |          | 
 client_hostname  | text                     |           |          | 
 client_port      | integer                  |           |          | 
 backend_start    | timestamp with time zone |           |          | 
 backend_xmin     | xid                      |           |          | 
 state            | text                     |           |          | 
 sent_lsn         | pg_lsn                   |           |          | 
 write_lsn        | pg_lsn                   |           |          | 
 flush_lsn        | pg_lsn                   |           |          | 
 replay_lsn       | pg_lsn                   |           |          | 
 write_lag        | interval                 |           |          | 
 flush_lag        | interval                 |           |          | 
 replay_lag       | interval                 |           |          | 
 sync_priority    | integer                  |           |          | 
 sync_state       | text                     |           |          | 
 reply_time       | timestamp with time zone |           |          | 
```