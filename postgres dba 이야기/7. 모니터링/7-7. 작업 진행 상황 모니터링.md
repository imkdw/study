## 작업 진행 상황 모니터링
- PG는 `progress` 뷰들을 통해서 인덱스 생성, 바큠 등 작업의 진행 상황을 실시간 모니터링이 가능하다
- 이런 뷰들은 대용량 작업의 자완료 시점을 예측하거나 작업이 정상적으로 수행되는지 확인하는데 유용하다

<br>

## 인덱스 진행 상황 모니터링
- `pg_stat_progress_create_index` 뷰를 통해서 인덱스 생성 작업의 현재 상태를 실시간으로 확인이 가능하다
- `phase` 컬럼을 통해서 인덱스 생성 단계별로 진행률 확인이 가능하다.
  - scanning table
  - sorting live tuples
  - loading tuples in tree

```sql
postgres=# \d pg_stat_progress_create_index;
        View "pg_catalog.pg_stat_progress_create_index"
       Column       |  Type   | Collation | Nullable | Default 
--------------------+---------+-----------+----------+---------
 pid                | integer |           |          | 
 datid              | oid     |           |          | 
 datname            | name    |           |          | 
 relid              | oid     |           |          | 
 index_relid        | oid     |           |          | 
 command            | text    |           |          | 
 phase              | text    |           |          | 
 lockers_total      | bigint  |           |          | 
 lockers_done       | bigint  |           |          | 
 current_locker_pid | bigint  |           |          | 
 blocks_total       | bigint  |           |          | 
 blocks_done        | bigint  |           |          | 
 tuples_total       | bigint  |           |          | 
 tuples_done        | bigint  |           |          | 
 partitions_total   | bigint  |           |          | 
 partitions_done    | bigint  |           |          | 
```

<br>

## Vacuum 진행 상황 모니터링
- 수동 및 Autovacuum 작업의 진행 상황은 `pg_stat_progress_vacuum` 뷰를 통해서 실시간으로 확인이 가능하다
- 대용량 테이블에 대한 바큠 작업은 인덱스 정리 단계에서 특히 시간이 오래걸릴수도 있다
- 작업 진행률뿐만 아니라 `maintenance_work_mem` 값이 적절한지도 판단이 가능하다
- 실무에서는 매우 우용한 모니터링 도구로 활용된다

```sql
postgres=# \d pg_stat_progress_vacuum;
            View "pg_catalog.pg_stat_progress_vacuum"
        Column        |  Type   | Collation | Nullable | Default 
----------------------+---------+-----------+----------+---------
 pid                  | integer |           |          | 
 datid                | oid     |           |          | 
 datname              | name    |           |          | 
 relid                | oid     |           |          | 
 phase                | text    |           |          | 
 heap_blks_total      | bigint  |           |          | 
 heap_blks_scanned    | bigint  |           |          | 
 heap_blks_vacuumed   | bigint  |           |          | 
 index_vacuum_count   | bigint  |           |          | 
 max_dead_tuple_bytes | bigint  |           |          | 
 dead_tuple_bytes     | bigint  |           |          | 
 num_dead_item_ids    | bigint  |           |          | 
 indexes_total        | bigint  |           |          | 
 indexes_processed    | bigint  |           |          | 
```

<br>

## Vacuum Full 진행 상황 모니터링
- Vacuum Full의 진행 상황 모니터링은 `pg_stat_progress_cluster` 뷰를 통해서 가능하다
- 이런 작업은 락 경합 문제로 인해서 일반적으로 정기 점검처럼 서비스 중단이 가능한 시점에 수행한다
- 그래서 제한된 시간 내에 작업 완료 가능 여부를 판단하기 위해서 현재 수행 단계와 전체 진행률을 모니터링 하는게 중요하다

```sql
postgres=# \d pg_stat_progress_cluster;
           View "pg_catalog.pg_stat_progress_cluster"
       Column        |  Type   | Collation | Nullable | Default 
---------------------+---------+-----------+----------+---------
 pid                 | integer |           |          | 
 datid               | oid     |           |          | 
 datname             | name    |           |          | 
 relid               | oid     |           |          | 
 command             | text    |           |          | 
 phase               | text    |           |          | 
 cluster_index_relid | oid     |           |          | 
 heap_tuples_scanned | bigint  |           |          | 
 heap_tuples_written | bigint  |           |          | 
 heap_blks_total     | bigint  |           |          | 
 heap_blks_scanned   | bigint  |           |          | 
 index_rebuild_count | bigint  |           |          | 
```

<br>

## COPY 진행 상황 모니터링
- 진행 상황은 `pg_stat_progress_copy` 뷰를 통해서 가능하다
- 이 때 `\copy` 및 `COPY` 명령어에 대해서 차이점은 크게 존재하지 않는다
- 하지만 `bytes_total(처리 대상 파일의 전체 크기)`는 `COPY` 명령어만 확인이 가능하다

```sql
postgres=# \d pg_stat_progress_copy;
           View "pg_catalog.pg_stat_progress_copy"
      Column      |  Type   | Collation | Nullable | Default 
------------------+---------+-----------+----------+---------
 pid              | integer |           |          | 
 datid            | oid     |           |          | 
 datname          | name    |           |          | 
 relid            | oid     |           |          | 
 command          | text    |           |          | 
 type             | text    |           |          | 
 bytes_processed  | bigint  |           |          | 
 bytes_total      | bigint  |           |          | 
 tuples_processed | bigint  |           |          | 
 tuples_excluded  | bigint  |           |          | 
 tuples_skipped   | bigint  |           |          | 
```