# 파일 관리 업무 자동화 에이전트
- FileManagementToolkit을 사용하면 파일을 생성하거나 읽는 등 여러 작업을 일일히 도구로 만들 필요 없이 기존 툴킷을 가져와서 활용이 가능함

<br>

# 기본 사용법
```python
import os
from langchain_community.agent_toolkits import FileManagementToolkit


if not os.path.exists("tmp"):
    os.mkdir("tmp")

working_directory = "tmp"

# FileManagementToolkit 인스턴스를 생성하면서 경로를 tmp로 지정
toolkit = FileManagementToolkit(root_dir=str(working_directory))

# 사용가능한 도구 로딩
available_tools = toolkit.get_tools()

# 도구 중 일부만 지정하여 선택하는 것도 가능
tools = FileManagementToolkit(
    root_dir=str(working_directory),
    selected_tools=["read_file", "file_delete", "write_file", "list_directory"],
).get_tools()

read_tool, delete_tool, write_tool, list_tool = tools

# File written successfully to example.txt.
print(write_tool.invoke({"file_path": "example.txt", "text": "Hello World!"}))

# example.txt
print(list_tool.invoke({}))

# File deleted successfully: example.txt.
print(delete_tool.invoke({"file_path": "example.txt"}))

# No files found in directory .
print(list_tool.invoke({}))
```

<br>

# 구글 최신 뉴스 조회해서 파일로 저장하기
```python
import os
from langchain_community.agent_toolkits import FileManagementToolkit
from langchain.tools import tool
from typing import List, Dict
from langchain_teddynote.tools import GoogleNews
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from langchain.agents import create_tool_calling_agent, AgentExecutor
from langchain_community.chat_message_histories import ChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_teddynote.messages import AgentStreamParser


if not os.path.exists("tmp"):
    os.mkdir("tmp")

working_directory = "tmp"


@tool
def latest_news(k: int = 5) -> List[Dict[str, str]]:
    """Look up latest news"""
    news_tool = GoogleNews()
    return news_tool.search_latest(k=k)


def get_session_history(session_ids):
    if session_ids not in store:
        store[session_ids] = ChatMessageHistory()
    return store[session_ids]


tools = FileManagementToolkit(
    root_dir=str(working_directory),
).get_tools()

tools.append(latest_news)


store = {}

prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "You are a helpful assistant. "
            "Make sure to use the `latest_news` tool to find latest news. "
            "Make sure to use the `file_management` tool to manage files. ",
        ),
        ("placeholder", "{chat_history}"),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ]
)

llm = ChatOpenAI(model="gpt-4o-mini")

agent = create_tool_calling_agent(llm, tools, prompt)

agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=False,
    handle_parsing_errors=True,
)

agent_with_chat_history = RunnableWithMessageHistory(
    agent_executor,
    get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history",
)

agent_stream_parser = AgentStreamParser()

session_id = "dongwoo"

result = agent_with_chat_history.stream(
    {
        "input": "최신 뉴스 5개를 검색하고, 각 뉴스의 제목을 파일명으로 가지는 파일을 생성하고(.txt), "
        "파일의 내용은 뉴스의 내용과 url을 추가하세요. "
    },
    config={"configurable": {"session_id": session_id}},
)

for step in result:
    agent_stream_parser.process_agent_steps(step)

result = agent_with_chat_history.stream(
    {
        "input": "이전에 생성한 모든 파일을 `news` 폴더를 생성한 뒤 해당 폴더에 모든 파일을 복사하세요. "
        "내용도 동일하게 복사하세요. "
    },
    config={"configurable": {"session_id": session_id}},
)

for step in result:
    agent_stream_parser.process_agent_steps(step)

result = agent_with_chat_history.stream(
    {"input": "news 폴더를 제외한 모든 .txt 파일을 삭제하세요."},
    config={"configurable": {"session_id": session_id}},
)

for step in result:
    agent_stream_parser.process_agent_steps(step)
```
