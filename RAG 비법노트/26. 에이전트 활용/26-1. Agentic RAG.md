# Agentic RAG
- 에이전트를 활용해서 RAG 시스템의 유연성과 효율성을 향상시키는 방법론
- 전통적인 RAG 시스템은 고정된 절차에 따라 문서 검색을 수행함
- Agentic RAG를 통해 에이전트에게 다양한 도구를 활용할 수 있는능력을 부여하고 상황에 맞게 최적의 도구를 선택하고 활용하게 할 수 있음

<br>

# 에이전트가 활용할 도구 지정하기
```python
from langchain_community.tools.tavily_search import TavilySearchResults
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings
from langchain.document_loaders import PyPDFLoader
from langchain.tools.retriever import create_retriever_tool
from langchain.agents import create_tool_calling_agent
from langchain.agents import AgentExecutor
from langchain_teddynote.messages import AgentStreamParser
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate


# 외부 검색 도구 선언
def get_web_search_tool():
    return TavilySearchResults(k=3)


# PDF 검색 도구 선언
def get_pdf_search_tool():
    loader = PyPDFLoader(
        "/Users/imkdw/study/RAG 비법노트/22. RAGAS로 답변 평가하기/SPRI_AI_Brief_2023년12월호_F.pdf"
    )
    text_splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=100)
    split_docs = loader.load_and_split(text_splitter)
    vector = FAISS.from_documents(split_docs, OpenAIEmbeddings())
    retriever = vector.as_retriever()

    return create_retriever_tool(
        retriever,
        name="pdf_search",
        description="use this tool to search information from the PDF document",
    )


web_search_tool = get_web_search_tool()
pdf_search_tool = get_pdf_search_tool()

tools = [web_search_tool, pdf_search_tool]

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)

prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "You are a helpful assistant. "
            "Make sure to use the `pdf_search` tool for searching information from the PDF document. "
            "If you can't find the information from the PDF document, use the `search` tool for searching information from the web.",
        ),
        ("placeholder", "{chat_history}"),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ]
)


agent = create_tool_calling_agent(llm, tools, prompt)

agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=False)

agent_stream_parser = AgentStreamParser()

result = agent_executor.stream(
    {"input": "2024년 프로야구 플레이오프 진출한 5개 팀을 검색하여 알려주세요."}
)

# 2024년 프로야구 포스트시즌에 진출한 팀은 다음과 같습니다:

# 1. KIA 타이거즈
# 2. 삼성 라이온즈
# 3. LG 트윈스
# 4. 두산 베어스
# 5. KT 위즈

# 이 팀들은 정규 시즌 성적에 따라 포스트시즌에 진출하였으며, 포스트시즌은 10월 2일부터 시작됩니다.
for step in result:
    agent_stream_parser.process_agent_steps(step)

result = agent_executor.stream(
    {"input": "삼성전자가 자체 개발한 생성형 AI 관련된 정보를 문서에서 찾아주세요."}
)

# [최종 답변]
# 삼성전자가 자체 개발한 생성형 AI 모델 '삼성 가우스'에 대한 정보는 다음과 같습니다:

# 1. **모델 구성**: 삼성 가우스는 언어, 코드, 이미지의 3개 모델로 구성되어 있습니다.
#    - **언어 모델**: 메일 작성, 문서 요약, 번역 업무 등을 지원합니다.
#    - **코드 모델**: AI 코딩 어시스턴트 '코드아이(code.i)'를 통해 대화형 인터페이스로 서비스를 제공하며, 사내 소프트웨어 개발에 최적화되어 있습니다.
#    - **이미지 모델**: 창의적인 이미지를 생성하고 기존 이미지를 원하는 대로 변경할 수 있으며, 저해상도 이미지를 고해상도로 전환하는 기능도 지원합니다.

# 2. **온디바이스 작동**: 삼성 가우스는 온디바이스에서 작동하도록 설계되어 있어, 사용자 정보가 외부로 유출될 위험이 없다는 장점이 있습니다. 이는 안전한 데이터로 학습되었으며, 라이선스나 개인정보를 침해하지 않는 방식으로 운영됩니다.

# 3. **제품 탑재 계획**: 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획을 가지고 있습니다.

# 4. **공식 발표**: 삼성 가우스는 2023년 11월 8일 열린 '삼성 AI 포럼 2023'에서 최초로 공개되었습니다.

# 이 정보는 삼성전자가 AI 기술을 통해 경쟁력을 강화하고, 사용자 개인정보 보호를 중시하는 방향으로 발전하고 있음을 보여줍니다.
for step in result:
    agent_stream_parser.process_agent_steps(step)
```

<br>

# 이전 대화 내용을 기억하는 에이전트
```python
from langchain_community.tools.tavily_search import TavilySearchResults
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings
from langchain.document_loaders import PyPDFLoader
from langchain.tools.retriever import create_retriever_tool
from langchain.agents import create_tool_calling_agent
from langchain.agents import AgentExecutor
from langchain_teddynote.messages import AgentStreamParser
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_community.chat_message_histories import ChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory

store = {}


def get_session_history(session_ids):
    if session_ids not in store:
        store[session_ids] = ChatMessageHistory()
    return store[session_ids]


# 외부 검색 도구 선언
def get_web_search_tool():
    return TavilySearchResults(k=3)


# PDF 검색 도구 선언
def get_pdf_search_tool():
    loader = PyPDFLoader(
        "/Users/imkdw/study/RAG 비법노트/22. RAGAS로 답변 평가하기/SPRI_AI_Brief_2023년12월호_F.pdf"
    )
    text_splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=100)
    split_docs = loader.load_and_split(text_splitter)
    vector = FAISS.from_documents(split_docs, OpenAIEmbeddings())
    retriever = vector.as_retriever()

    return create_retriever_tool(
        retriever,
        name="pdf_search",
        description="use this tool to search information from the PDF document",
    )


web_search_tool = get_web_search_tool()
pdf_search_tool = get_pdf_search_tool()

tools = [web_search_tool, pdf_search_tool]

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)

prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "You are a helpful assistant. "
            "Make sure to use the `pdf_search` tool for searching information from the PDF document. "
            "If you can't find the information from the PDF document, use the `search` tool for searching information from the web.",
        ),
        ("placeholder", "{chat_history}"),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ]
)


agent = create_tool_calling_agent(llm, tools, prompt)

agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=False)

agent_stream_parser = AgentStreamParser()


agent_with_chat_history = RunnableWithMessageHistory(
    agent_executor,
    get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history",
)

session_id = "dongwoo"
response = agent_with_chat_history.stream(
    {"input": "삼성전자가 개발한 생성형 AI 관련된 정보를 문서에서 찾아주세요."},
    config={"configurable": {"session_id": session_id}},
)

# [최종 답변]
# 삼성전자가 개발한 생성형 AI에 대한 정보는 다음과 같습니다:

# - **모델 이름**: 삼성 가우스(Samsung Gauss)
# - **발표일**: 2023년 11월 8일, '삼성 AI 포럼 2023'에서 최초 공개됨.
# - **구성**: 삼성 가우스는 언어, 코드, 이미지의 3개 모델로 구성되어 있습니다.
#   - **언어 모델**: 메일 작성, 문서 요약, 번역 업무 등을 지원하며, 클라우드와 온디바이스에서 작동할 수 있는 다양한 모델이 포함됩니다.
#   - **코드 모델**: AI 코딩 어시스턴트 '코드아이(code.i)'를 통해 대화형 인터페이스로 서비스를 제공하며, 사내 소프트웨어 개발에 최적화되어 있습니다.
#   - **이미지 모델**: 창의적인 이미지를 생성하고 기존 이미지를 수정할 수 있으며, 저해상도 이미지를 고해상도로 변환하는 기능도 지원합니다.

# - **온디바이스 작동**: 삼성 가우스는 온디바이스에서 작동하도록 설계되어 있어, 사용자 정보가 외부로 유출될 위험이 없다는 장점이 있습니다. 이는 안전한 데이터로 학습되었으며, 라이선스나 개인정보를 침해하지 않는 방식으로 운영됩니다.

# - **향후 계획**: 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획을 가지고 있습니다. 2024년부터 가우스를 탑재한 삼성 스마트폰이 메타의 라마(Llama)2를 탑재한 퀄컴 기기 및 구글 어시스턴트를 적용한 구글 픽셀과 경쟁할 것으로 예상됩니다.

# 이 정보는 삼성전자가 AI 기술을 통해 사용자 경험을 향상시키고, 데이터 보안을 강화하려는 노력을 보여줍니다.
for step in response:
    agent_stream_parser.process_agent_steps(step)

response = agent_with_chat_history.stream(
    {"input": "이전의 답변을 영어로 번역해 주세요."},
    config={"configurable": {"session_id": session_id}},
)

# Here is the translation of the previous response into English:

# - **Model Name**: Samsung Gauss
# - **Announcement Date**: First unveiled on November 8, 2023, at the 'Samsung AI Forum 2023'.
# - **Components**: Samsung Gauss consists of three models: language, code, and image.
#   - **Language Model**: Supports tasks such as email writing, document summarization, and translation, with various models that can operate both in the cloud and on-device.
#   - **Code Model**: Provides a coding assistant called 'code.i' through an interactive interface, optimized for in-house software development.
#   - **Image Model**: Capable of generating creative images and modifying existing ones, as well as enhancing low-resolution images to high resolution.

# - **On-Device Operation**: Samsung Gauss is designed to operate on-device, which minimizes the risk of user information being leaked externally. It is trained on secure data and operates in a manner that does not infringe on licenses or personal information.

# - **Future Plans**: Samsung Electronics plans to gradually integrate Samsung Gauss into various products. Starting in 2024, smartphones equipped with Gauss are expected to compete with Qualcomm devices featuring Meta's Llama 2 and Google Pixel devices using Google Assistant.

# This information demonstrates Samsung's efforts to enhance user experience through AI technology while strengthening data security.
for step in response:
    agent_stream_parser.process_agent_steps(step)
```