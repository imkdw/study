# SQLite에 대화내용 저장하기
- SQLite는 SQL을 이용해서 데이터를 저장하고 관리하는 가벼운 DBMS임
- 사용자가 떠날 떄 대화 기록을 유지하지 않고 그냥 삭제해도 된다면 인메모리 방식을 사용해도 무관함
- 하지만 사용자가 다시 돌아와서 이전 대화기록을 이어나가면서 대화가 필요하다면 대화 내용을 디비에 기록해야함

<br>

# SQLChatMessageHistory 설정
```python
from dotenv import load_dotenv
from langchain_teddynote import logging

load_dotenv()
logging.langsmith("langchain_test")

# ========================================================================

from langchain_community.chat_message_histories import SQLChatMessageHistory

# SQLite 설정
chat_message_history = SQLChatMessageHistory(
    session_id="sql_history", connection="sqlite:///sqlite.db"
)

# 저장할 메세지 추가
chat_message_history.add_user_message(
    "안녕? 만나서 반가워. 내 이름은 동우야. 나는 Node.js 개발자야. 앞으로 잘 부탁해!"
)

# AI 메세지 추가
chat_message_history.add_ai_message("안녕 동우, 만나서 반가워. 나도 잘 부탁해!")

# [
#     HumanMessage(
#         content="안녕? 만나서 반가워. 내 이름은 동우야. 나는 Node.js 개발자야. 앞으로 잘 부탁해!",
#         additional_kwargs={},
#         response_metadata={},
#     ),
#     AIMessage(
#         content="안녕 동우, 만나서 반가워. 나도 잘 부탁해!",
#         additional_kwargs={},
#         response_metadata={},
#     ),
# ]
print(chat_message_history.messages)
```

<br>

# 체인에 연동하기
```python
from dotenv import load_dotenv
from langchain_teddynote import logging

load_dotenv()
logging.langsmith("langchain_test")

# ========================================================================

from langchain_community.chat_message_histories import SQLChatMessageHistory
from langchain_core.prompts import (
    ChatPromptTemplate,
    MessagesPlaceholder,
)
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables.utils import ConfigurableFieldSpec


# SQLite에서 대화 기록을 가져오는 함수
def get_chat_history(user_id, conversation_id):
    return SQLChatMessageHistory(
        table_name=user_id,
        session_id=conversation_id,
        connection="sqlite:///sqlite.db",
    )


# SQLite 설정
chat_message_history = SQLChatMessageHistory(
    session_id="sql_history", connection="sqlite:///sqlite.db"
)

# 저장할 메세지 추가
chat_message_history.add_user_message(
    "안녕? 만나서 반가워. 내 이름은 동우야. 나는 Node.js 개발자야. 앞으로 잘 부탁해!"
)

# AI 메세지 추가
chat_message_history.add_ai_message("안녕 동우, 만나서 반가워. 나도 잘 부탁해!")

prompt = ChatPromptTemplate.from_messages(
    [
        ("system", "You are a helpful assistant."),
        MessagesPlaceholder(variable_name="chat_history"),
        ("human", "{question}"),
    ]
)

chain = prompt | ChatOpenAI(model_name="gpt-4.1-mini") | StrOutputParser()

config_fields = [
    ConfigurableFieldSpec(
        id="user_id",
        annotation=str,
        name="User ID",
        description="Unique identifier for a user.",
        default="",
        is_shared=True,
    ),
    ConfigurableFieldSpec(
        id="conversation_id",
        annotation=str,
        name="Conversation ID",
        description="Unique identifier for a conversation.",
        default="",
        is_shared=True,
    ),
]

chain_with_history = RunnableWithMessageHistory(
    chain,
    get_chat_history,  # 대화 기록을 가져오는 함수를 설정
    input_messages_key="question",  # 입력 메시지의 키를 "question"으로 설정
    history_messages_key="chat_history",  # 대화 기록 메시지의 키를 "history"로 설정
    history_factory_config=config_fields,  # 대화 기록 조회시 참고할 파라미터를 설정
)

config = {"configurable": {"user_id": "user1", "conversation_id": "conversation1"}}

# 질문하기
print(chain_with_history.invoke({"question": "안녕 반가워, 내 이름은 동우야"}, config))

# 중간 대화 기록
# [
#     HumanMessage(
#         content="안녕 반가워, 내 이름은 동우야",
#         additional_kwargs={},
#         response_metadata={},
#     ),
#     AIMessage(
#         content="안녕하세요 동우님! 만나서 반가워요. 무엇을 도와드릴까요?",
#         additional_kwargs={},
#         response_metadata={},
#     ),
# ]
print(get_chat_history("user1", "conversation1").messages)

# 당신의 이름은 동우라고 하셨어요. 어떻게 도와드릴까요?
print(chain_with_history.invoke({"question": "내 이름이 뭐라고?"}, config))
```