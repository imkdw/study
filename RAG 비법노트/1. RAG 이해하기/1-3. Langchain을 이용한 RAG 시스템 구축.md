# Langchain을 이용한 RAG 시스템 구축
- 랭체인은 LLM로 구동되는 앱을 개발하기 위한 프레임워크임
- GPT 같은 LLM과 만들고자 하는 서비스나 프로세스를 쉽게 연결해주는 도구임
- 대표적으로는 LLM을 통한 Q&A 시스템을 만들때 문서를 따로 전달해야하는데 이러한 작업을 쉽게 해줌

<br>

# Langchain으로 구현할 RAG 시스템 전체 프로세스
- GPT 자체도 RAG 시스템을 가지고있지만 사용자가 커스텀하기 쉽지 않다는 단점이 존재함
- 결국 랭체인을 통해서 `튜닝`을 진행하는데 원하는 답을 얻을때까지 이러한 과정을 개선하고 최적화하는 것이 목적임

<br>

# RAG 프로세스의 사전 단계 이해하기
- GPT에게 무언가 질문했을때 사전에 전달된 컨텍스트가 없다면 학습된 내용만으로 답변하게됨
- 학습된 내용이 오래된 내용이라면 결국 환각현상이 발생하게됨
- RAG의 경우는 미리 참고할 정보를 미리 저장해놓고 사용자가 질문을 입력하면 프롬프트에 관련된 내용을 함께 담아줌
- 하지만 프롬프트에 모든 내용을 전달하는건 효율적이지 않으므로 관련성 있는 정보만 골라서 검색기에 전달하는게 효과적임

<br>

### 사전 단계의 과정
- 문서 로드 : 외부 소스에서 필요한 문서를 불러와서 초기 처리를 진행함
- 텍스트 분할 : 로드된 문서를 처리 가능한 작은 단위인 `청크`로 분할함. 이는 책의 파트/챕터와 비슷함
- 임베딩 : 분할된 청크를 벡터 형태로 분석해서 문서의 의미를 수치화함. 자연어를 컴퓨터가 이해할 수 있게 변환하는 과정임
- 벡터 스토어 저장 : 임베딩된 청크를 디비에 저장하는데 이는 요약된 키워드를 인덱싱해서 나중에 빠르게 찾을 수 있게 정리하는 과정임

<br>

### 문서 로드
- PDF, Excel, Word 등 문서를 로드함
- 예를 들면 PDF를 가져온다고 하면 그 내부에 있는 텍스트를 긁어오는 작업을 뜻함

<br>

### 텍스트 분할
- 특정 질문을 하게되면 특정 문서의 일부 내용만을 가져옴
- 전체 내용을 프롬프트에 쓰지 않고 청크라는 단위로 내용을 분할학됨
- 토큰 수를 기준으로 청크 크기를 지정하면 해당 분량의 청크로 분할됨
- 이후에 질문을 기반으로 각각의 청크에 대해 유사도 계산을 통해서 가장 관련성이 높은 청크를 뽑아내는 작업을 수행함

<br>

### 임베딩
- 유사도를 계산하기 위해서는 각 청크의 값을 수학적인 표현으로 바꿔야하는데 이러한 작업을 `임베딩`이라고 부름
- 임베딩은 여러 숫자의 좌표 집합인 `벡터`로 표현되는데 벡터에는 차원이 존재함
- OpenAI의 임베딩 벡터는 1536 차원으로 한 단어든 문장이든 이를 나타내는 벡터 값에 1536개의 숫자가 들어간다는 뜻임
- 표현이 풍부할수록 정교한 유사도 분석이 가능하지만 그 대신 리소스를 더 많이 소모하게됨

<br>

#### 청크 오버랩
- 보통 분할된 청크 끝부분에서 맥락이 이어질 수 있도록 일부를 겹쳐서 분할하는데 이를 `청크 오버랩`이라고 부름

<br>

### 벡터 스토어
- LLM이 질문/답변을 처리할 떄와 마찬가지로 임베딩시에도 비용이 소모됨
- 그래서 각 청크에 임베딩된 값을 `벡터 스토어`에 저장해놓고 디비에 검색어로 쿼리를 요청할 때 마다 가져올 수 있게함
- 위 같은 모든 과정을 통틀어서 `전처리 과정`이라고 부름

<br>

# RAG 프로세스의 실행 단계 이해
- 리트리버 : 질문이 주어지면 이와 관련된 벡터를 디비에서 검색
- 프롬프트 : 검색된 정보를 바탕으로 언어 모델을 위한 질문을 구성함. 이는 정보를 바탕으로 어떻게 질문할 지 결정하는 과정
- LLM : 구성된 프롬프트를 통해서 언어 모델이 답변을 생성함
- 체인 생성 : 이전의 모든 과정을 하나의 파이프라인으로 묶어주는 `체인`을 생성하게됨

<br>

### 리트리버
- 벡터 디비에서 사용자 질문과 관련된 문서를 검색하는 핵심 과정임
- 질문이 들어오면 이를 임베딩으로 변환하고, 이를 통해서 질문과 가장 관련이 깊은 단락을 선별함
- 이렇게 찾아 낸 문서의 내용과 메타데이터는 프롬프트 생성으로 전달됨

<br>

### 프롬프트
- 리트리버가 검색한 문서들을 바탕으로 언어 모델이 사용할 질문이나 명령을 만드는 과정
- 잘 구성된 프롬프트는 모델이 더 정확하고 관련성 높은 답변을 만들어 낼 수 있는 중요한 토대가 됨

<br>

### LLM
- 구성된 프롬프트를 입력으로 받아서 LLM을 통해서 실제 응답을 생성함
- 이는 모든 과정을 결과물을 실제 사용자가 이해할 수 있는 형태로 변환하는 최종 관문임

<br>

### 체인 생성
- LCEL(Langchain Expression Language) 문법을 통해서 모든 7개의 단계를 모두 묶어서 완전한 RAG 파이프라인으로 조립하는 단계
- 