# CSV 로더와 데이터프레임 로더
- CSV는 쉼표로 구분된 값을 저장하는 텍스트 파일
- CSVLoader를 통해서 쉽게 로드가 가능한데 종종 바로 임베딩하는 경우가 존재함
- 이 때 CSVLoader로 그대로 로드하기보다 XML 형식으로 데이터를 구조화하면 검색 및 처리가 쉬워짐

<br>

# CSVLoader
```python
from langchain_community.document_loaders.csv_loader import CSVLoader

# CSV 로더 생성
loader = CSVLoader(file_path="/Users/imkdw/study/RAG 비법노트/example/titanic.csv")

# 데이터 로드
docs = loader.load()

# 20
print(len(docs))

# {'source': '/Users/imkdw/study/RAG 비법노트/example/titanic.csv', 'row': 0}
print(docs[0].metadata)

# PassengerId: 2
# Survived: 1
# Pclass: 1
# Name: Cumings, Mrs. John Bradley (Florence Briggs Thayer)
# Sex: female
# Age: 38
# SibSp: 1
# Parch: 0
# Ticket: PC 17599
# Fare: 71.2833
# Cabin: C85
# Embarked: C
print(docs[1].page_content)
```

<br>

# CSV 파싱 및 로딩 커스텀
- 원하는 형식으로 구분자, 인용 부호 문자, 필드명 등 수정이 가능함
```python
from langchain_community.document_loaders.csv_loader import CSVLoader

# CSV 파일 경로
loader = CSVLoader(
    file_path="/Users/imkdw/study/RAG 비법노트/example/titanic.csv",
    csv_args={
        "delimiter": ",",  # 구분자
        "quotechar": '"',  # 인용 부호 문자
        "fieldnames": [
            "PassengerId",
            "Survived",
            "Pclass",
            "Name",
            "Sex",
            "Age",
            "SibSp",
            "Parch",
            "Ticket",
            "Fare",
            "Cabin",
            "Embarked",
        ],
    },
)

docs = loader.load()

# PassengerId: 1
# Survived: 0
# Pclass: 3
# Name: Braund, Mr. Owen Harris
# Sex: male
# Age: 22
# SibSp: 1
# Parch: 0
# Ticket: A/5 21171
# Fare: 7.25
# Cabin: 
# Embarked: S
print(docs[1].page_content)
```

<br>

# XML 문서로 처리하기
- 0번째 문서는 컬럼 정보라서 패스하고 실제 본문만 파싱함

```python
from langchain_community.document_loaders.csv_loader import CSVLoader

# CSV 파일 경로
loader = CSVLoader(
    file_path="/Users/imkdw/study/RAG 비법노트/example/titanic.csv",
)

docs = loader.load()

# <row><PassengerId>1</PassengerId><Survived>0</Survived><Pclass>3</Pclass><Name>Braund, Mr. Owen Harris</Name><Sex>male</Sex><Age>22</Age><SibSp>1</SibSp><Parch>0</Parch><Ticket>A/5 21171</Ticket><Fare>7.25</Fare><Cabin></Cabin><Embarked>S</Embarked></row>
# <row><PassengerId>2</PassengerId><Survived>1</Survived><Pclass>1</Pclass><Name>Cumings, Mrs. John Bradley (Florence Briggs Thayer)</Name><Sex>female</Sex><Age>38</Age><SibSp>1</SibSp><Parch>0</Parch><Ticket>PC 17599</Ticket><Fare>71.2833</Fare><Cabin>C85</Cabin><Embarked>C</Embarked></row>
# <row><PassengerId>3</PassengerId><Survived>1</Survived><Pclass>3</Pclass><Name>Heikkinen, Miss. Laina</Name><Sex>female</Sex><Age>26</Age><SibSp>0</SibSp><Parch>0</Parch><Ticket>STON/O2. 3101282</Ticket><Fare>7.925</Fare><Cabin></Cabin><Embarked>S</Embarked></row>
# ...
for doc in docs[1:]:
    row = doc.page_content.split("\n")
    row_str = "<row>"
    for element in row:
        splitted_element = element.split(":")
        value = splitted_element[-1]
        col = ":".join(splitted_element[:-1])
        row_str += f"<{col}>{value.strip()}</{col}>"
    row_str += "</row>"
    print(row_str)
```

<br>

# 특정 컬럼을 문서의 출처로 지정하기
- 이는 CSV 파일에서 로드된 문서를 출처를 사용해서 질답하는 체인에 유용함
```python
from langchain_community.document_loaders.csv_loader import CSVLoader


loader = CSVLoader(
    file_path="/Users/imkdw/study/RAG 비법노트/example/titanic.csv",
    source_column="PassengerId",
)

docs = loader.load()

# page_content='PassengerId: 2
# Survived: 1
# Pclass: 1
# Name: Cumings, Mrs. John Bradley (Florence Briggs Thayer)
# Sex: female
# Age: 38
# SibSp: 1
# Parch: 0
# Ticket: PC 17599
# Fare: 71.2833
# Cabin: C85
# Embarked: C' metadata={'source': '2', 'row': 1}
print(docs[1])
```

<br>

# UnstructedCSVLoader
- UnstructedCSVLoader를 사용해서 테이블 데이터를 로드할 수 있음
- 의존성이 높은 라이브러리를 사용하지만 번거로운 XML 변환 작업을 줄일 수 있는 장점이 있음

```python
from langchain_community.document_loaders.csv_loader import UnstructuredCSVLoader

# 비구조화 CSV 로더 인스턴스 생성
loader = UnstructuredCSVLoader(
    file_path="/Users/imkdw/study/RAG 비법노트/example/titanic.csv", mode="elements"
)

# 문서 로드
docs = loader.load()

# <table><tr><td>PassengerId</td><td>Survived</td><td>Pclass</td><td>Name</td><td>Sex</td><td>Age</td><td>SibSp</td><td>Parch</td><td>Ticket</td><td>Fare</td><td>Cabin</td><td>Embarked</td></tr><tr><td>1</td><td>0</td><td>3</td><td>Braund, Mr. Owen Harris</td><td>male</td><td>22</td><td>1</td><td>0</td><td>A/5 21171</td><td>7.25</td><td/><td>S</td></tr><tr><td>2</td><td>1</td><td>1</td><td>Cumings, Mrs. John Bradley (Florence Briggs Thayer)</td><td>female</td><td>38</td><td>1</td><td>0</td><td>PC 17599</td><td>71.2833</td><td>C85</td><td>C</td></tr><tr><td>3</td><td>1</td><td>3</td><td>Heikkinen, Miss. Laina</td><td>female</td><td>26</td><td>0</td><td>0</td><td>STON/O2. 3101282</td><td>7.925</td><td/><td>S</td></tr><tr><td>4</td><td>1</td><td>1</td><td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td><td>female</td><td>35</td><td>1</td><td>0</td><td>113803</td><td>53.1</td><td>C123</td><td>S</td></tr><tr><td>5</td><td>0</td><td>3</td><td>Allen, Mr. William Henry</td><td>male</td><td>35</
print(docs[0].metadata["text_as_html"][:1000])
```

<br>

# DataFrameLoader
- pandas 데이터프레임을 문서 형식으로 변환할려면 `DataFrameLoader`를 사용하면됨
```python
import pandas as pd
from langchain_community.document_loaders import DataFrameLoader

df = pd.read_csv("/Users/imkdw/study/RAG 비법노트/example/titanic.csv")

df.head()

loader = DataFrameLoader(df, page_content_column="Name")

docs = loader.load()

# Braund, Mr. Owen Harris
print(docs[0].page_content)

# {'PassengerId': 1, 'Survived': 0, 'Pclass': 3, 'Sex': 'male', 'Age': 22.0, 'SibSp': 1, 'Parch': 0, 'Ticket': 'A/5 21171', 'Fare': 7.25, 'Cabin': nan, 'Embarked': 'S'}
# page_content='Braund, Mr. Owen Harris' metadata={'PassengerId': 1, 'Survived': 0, 'Pclass': 3, 'Sex': 'male', 'Age': 22.0, 'SibSp': 1, 'Parch': 0, 'Ticket': 'A/5 21171', 'Fare': 7.25, 'Cabin': nan, 'Embarked': 'S'}
print(docs[0].metadata)

for row in loader.lazy_load():
    print(row)
```

<br>

# 지연로드
- 큰 데이터를 한 번에 로드하지 않고 한 행씩 지연 로드 방식으로 처리가 가능함
- 이는 메모리에 부담을 줄이면서 데이터를 한 행씩 처리가 가능함
```python
import pandas as pd
from langchain_community.document_loaders import DataFrameLoader

df = pd.read_csv("/Users/imkdw/study/RAG 비법노트/example/titanic.csv")

df.head()

loader = DataFrameLoader(df, page_content_column="Name")

for row in loader.lazy_load():
    print(row)
```