# RunnableBranch, RunnableLambda를 활용한 라우팅
- 실제 서비스 개발에서 원하는 방식으로 라우팅하는 데 유용한 기능임
- 라우팅이란 질문이 들어왔을 때 분기 처리를 하는것임
- 여러 개의 체인을 만들어 놓고 입력한 데이터의 특성에 따라서 서로 다른 체인으로 처리 경로를 유연하게 정의가 가능함
- RunnableBranch, RunnableLambda를 활용해서 라우팅을 구현할 수 있는데 공식문서에서는 RunnableLambda 사용을 권장함

<br>

# 기본적인 분류 프롬프팅
```python
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import PromptTemplate

prompt = PromptTemplate.from_template(
    """주어진 사용자 질문을 `수학`, `과학`, 또는 `기타` 중 하나로 분류하세요. 한 단어 이상으로 응답하지 마세요.

<question>
{question}
</question>

Classification:"""
)

chain = prompt | ChatOpenAI(model="gpt-4o-mini") | StrOutputParser()

# 수학
print(chain.invoke({"question": "2+2 는 무엇인가요?"}))

# 과학
print(chain.invoke({"question": "작용 반작용의 법칙은 무엇인가요?"}))

# 기타
print(chain.invoke({"question": "Google은 어떤 회사인가요?"}))
```

<br>

# RunnableLambda로 라우팅 처리하기
```python
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import PromptTemplate
from operator import itemgetter
from langchain_core.runnables import RunnableLambda

prompt = PromptTemplate.from_template(
    """주어진 사용자 질문을 `수학`, `과학`, 또는 `기타` 중 하나로 분류하세요. 한 단어 이상으로 응답하지 마세요.

<question>
{question}
</question>

Classification:"""
)

chain = prompt | ChatOpenAI(model="gpt-4o-mini") | StrOutputParser()

math_chain = (
    PromptTemplate.from_template(
        """You are an expert in math. \
Always answer questions starting with "깨봉선생님께서 말씀하시기를..". \
Respond to the following question:

Question: {question}
Answer:"""
    )
    | ChatOpenAI(model="gpt-4o-mini")
)

science_chain = (
    PromptTemplate.from_template(
        """You are an expert in science. \
Always answer questions starting with "아이작 뉴턴 선생님께서 말씀하시기를..". \
Respond to the following question:

Question: {question}
Answer:"""
    )
    | ChatOpenAI(model="gpt-4o-mini")
)

general_chain = (
    PromptTemplate.from_template(
        """Respond to the following question concisely:

Question: {question}
Answer:"""
    )
    | ChatOpenAI(model="gpt-4o-mini")
)


# 토픽에 따른 체인 분기처리
def route(info):
    if "수학" in info["topic"].lower():
        return math_chain
    elif "과학" in info["topic"].lower():
        return science_chain
    else:
        return general_chain


full_chain = (
    {"topic": chain, "question": itemgetter("question")}
    | RunnableLambda(route)
    | StrOutputParser()
)

# 깨봉선생님께서 말씀하시기를, 미적분학은 수학의 한 분야로, 함수의 변화와 기울기, 면적 등을 다루는 학문입니다. 미적분은 두 가지 주요 개념으로 구성되어 있습니다: 미분과 적분입니다.

# 1. **미분**: 함수의 변화율을 측정하는 도구로, 어떤 함수의 기울기를 찾는 과정입니다. 예를 들어, 물체의 빠르기를 알고 싶다면 위치 함수의 미분을 통해 빠르기를 구할 수 있습니다.

# 2. **적분**: 함수의 면적을 구하는 과정으로, 미분과는 반대의 개념입니다. 특정 구간에서의 함수 아래의 면적을 계산하는 데 사용되며, 이는 물리적 상황에서도 유용합니다. 예를 들어, 속도를 적분하면 이동한 거리를 구할 수 있습니다.
print(full_chain.invoke({"question": "미적분의 개념에 대해 말씀해 주세요."}))

# 이 두 가지는 서로 밀접한 관계가 있으며, 그 관계를 설명한 것이 바로 '미적분학 기본 정리'입니다. 이 정리에 따르면 미분과 적분은 서로의 역 연산이 성립합니다. 이처럼 미적분은 자연과학, 공학, 경제학 등 다양한 분야에서 활용됩니다.
# 아이작 뉴턴 선생님께서 말씀하시기를, 중력은 질량을 가진 두 물체 사이에 작용하는 힘으로, 물체의 질량이 클수록 또는 두 물체 간의 거리가 가까울수록 그 힘이 강해진다고 하십니다. 뉴턴의 만유인력 법칙에 따르면, 두 물체 간의 중력은 그들의 질량의 곱에 비례하고, 거리의 제곱에 반비례하여 나타납니다. 즉, G * (m1 * m2) / r^2의 공식으로 표현되며, 여기서 G는 공유되는 만유인력 상수입니다. 이 법칙은 지구와 같은 큰 물체가 다른 물체를 끌어당기는 방식으로, 우리가 경험하는 중력의 본질을 설명하는 중요한 원리입니다.
print(full_chain.invoke({"question": "중력은 어떻게 작용하나요?"}))

# RAG(여과 증강 생성)은 정보 검색과 자연어 생성 기술을 결합한 모델로, 외부 지식 기반에서 관련 정보를 검색한 후, 이를 바탕으로 텍스트를 생성하는 방식입니다. 이 방식은 정확성과 풍부한 내용을 제공하여, 질문에 대한 답변이나 문서 생성을 더욱 효율적으로 만듭니다.
print(
    full_chain.invoke({"question": "RAG(Retrieval Augmented Generation)은 무엇인가요?"})
)
```

<br>

# RunnableBranch로 라우팅하기
```python
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import PromptTemplate
from langchain_core.runnables import RunnableBranch, RunnableLambda
from langchain_openai import ChatOpenAI
from operator import itemgetter

prompt = PromptTemplate.from_template(
    """주어진 사용자 질문을 `수학`, `과학`, 또는 `기타` 중 하나로 분류하세요. 한 단어 이상으로 응답하지 마세요.

<question>
{question}
</question>

Classification:"""
)

chain = prompt | ChatOpenAI(model="gpt-4o-mini") | StrOutputParser()

math_chain = (
    PromptTemplate.from_template(
        """You are an expert in math. \
Always answer questions starting with "깨봉선생님께서 말씀하시기를..". \
Respond to the following question:

Question: {question}
Answer:"""
    )
    | ChatOpenAI(model="gpt-4o-mini")
)

science_chain = (
    PromptTemplate.from_template(
        """You are an expert in science. \
Always answer questions starting with "아이작 뉴턴 선생님께서 말씀하시기를..". \
Respond to the following question:

Question: {question}
Answer:"""
    )
    | ChatOpenAI(model="gpt-4o-mini")
)

general_chain = (
    PromptTemplate.from_template(
        """Respond to the following question concisely:

Question: {question}
Answer:"""
    )
    | ChatOpenAI(model="gpt-4o-mini")
)


# 토픽에 따른 체인 분기처리
def route(info):
    if "수학" in info["topic"].lower():
        return math_chain
    elif "과학" in info["topic"].lower():
        return science_chain
    else:
        return general_chain


full_chain = (
    {"topic": chain, "question": itemgetter("question")}
    | RunnableLambda(route)
    | StrOutputParser()
)


branch = RunnableBranch(
    (lambda x: "수학" in x["topic"].lower(), math_chain),
    (lambda x: "과학" in x["topic"].lower(), science_chain),
    general_chain,
)

full_chain = (
    {"topic": chain, "question": itemgetter("question")} | branch | StrOutputParser()
)

# 깨봉선생님께서 말씀하시기를, 미적분은 수학의 한 분야로, 함수의 변화와 그에 따른 기울기, 면적 등을 다루는 방법론입니다. 주로 미분과 적분으로 나뉘며, 미분은 함수의 순간적인 변화율을 분석하고, 적분은 함수의 면적을 구하는 데에 사용됩니다. 이를 통해 우리는 물체의 움직임, 변화를 이해할 수 있고, 여러 자연 현상을 수학적으로 모델링하는 데 중요한 도구가 됩니다. 미적분은 과학, 공학, 경제학 등 많은 분야에서 필수적인 기초 지식으로 자리잡고 있습니다.
print(full_chain.invoke({"question": "미적분의 개념에 대해 말씀해 주세요."}))

# 아이작 뉴턴 선생님께서 말씀하시기를, 중력 가속도는 물체가 지구의 중력에 의해 하강할 때 받는 가속도를 의미하며, 이를 계산하기 위해서는 만유인력의 법칙을 이용할 수 있습니다. 만유인력의 법칙에 따르면, 두 물체 사이의 인력은 각 물체의 질량에 비례하고, 그들 사이의 거리의 제곱에 반비례합니다.

# 가벼운 물체가 지구의 표면에서 느끼는 중력 가속도 \( g \)는 다음과 같은 공식으로 표현할 수 있습니다:

# \[
# g = \frac{GM}{r^2}
# \]

# 여기서 \( G \)는 만유인력 상수(약 \( 6.674 \times 10^{-11} \, \text{m}^3/\text{kg} \cdot \text{s}^2 \)), \( M \)은 지구의 질량(약 \( 5.972 \times 10^{24} \, \text{kg} \)), \( r \)은 지구의 반지름(약 \( 6.371 \times 10^6 \, \text{m} \))입니다. 이 공식을 통해 지구 표면에서의 중력 가속도는 약 \( 9.81 \, \text{m/s}^2 \)로 계산됩니다.
print(full_chain.invoke({"question": "중력 가속도는 어떻게 계산하나요?"}))

# RAG( Retrieval Augmented Generation)는 정보 검색과 자연어 생성 기술을 결합한 모델로, 외부 데이터베이스에서 관련 정보를 검색한 후 이를 활용해 더 풍부하고 정확한 응답을 생성하는 방법입니다. 주로 질문에 대한 답변 생성이나 대화형 시스템에서 사용됩니다.
print(
    full_chain.invoke({"question": "RAG(Retrieval Augmented Generation)은 무엇인가요?"})
)
```