# config로 LLM이나 프롬프트를 동적으로 변경
- gpt-4o를 쓰다가 gpt-4o-mini를 쓸려면 체인을 새로 생성해야함
- 하지만 두 모델 옵션을 config로 미리 설정해두면 그때그때 옵션을 바꿔 가며 체인 시행이 가능함
- 또한 프롬프트도 여러 옵션을 두고 필요에 따라 다른 프롬프트를 지정해 실행이 가능함

<br>

# ConfigurableField를 통한 동적 속성 지정
```python
from langchain.prompts import PromptTemplate
from langchain_core.runnables import ConfigurableField
from langchain_openai import ChatOpenAI

model = ChatOpenAI(temperature=0).configurable_fields(
    model_name=ConfigurableField(
        id="gpt_version",
        name="Version of GPT",
        description="Official model name of GPTs. ex) gpt-4o, gpt-4o-mini",
    )
)

# gpt-3.5-turbo
# 대한민국의 수도는 서울이다.
print(
    model.invoke(
        "대한민국의 수도는 어디야?",
        config={"configurable": {"gpt_version": "gpt-3.5-turbo"}},
    ).__dict__["content"]
)

# gpt-4o-mini
# 대한민국의 수도는 서울입니다.
print(
    model.invoke(
        "대한민국의 수도는 어디야?",
        config={"configurable": {"gpt_version": "gpt-4o-mini"}},
    ).__dict__["content"]
)
```

<br>

# with_config를 통한 동적 속성 지정
```python
from langchain.prompts import PromptTemplate
from langchain_core.runnables import ConfigurableField
from langchain_openai import ChatOpenAI

model = ChatOpenAI(temperature=0).configurable_fields(
    model_name=ConfigurableField(
        id="gpt_version",
        name="Version of GPT",
        description="Official model name of GPTs. ex) gpt-4o, gpt-4o-mini",
    )
)


prompt = PromptTemplate.from_template("{x} 보다 큰 위의 난수를 선택합니다.")

chain = prompt | model

"""
위의 요청에 따라 0보다 큰 난수를 선택하려면 프로그래밍 언어를 사용하여 난수를 생성할 수 있습니다. 예를 들어, 파이썬에서는 `random` 모듈을 사용하여 다음과 같이 난수를 생성할 수 있습니다:

import random

# 0보다 큰 난수 생성
random_number = random.uniform(0.0001, 1.0)
print(random_number)

이 코드는 0과 1 사이의 난수를 생성하지만, 0은 포함하지 않습니다. 원하는 범위에 따라 `random.uniform(a, b)`의 `a`와 `b` 값을 조정할 수 있습니다.
"""
print(
    chain.with_config(configurable={"gpt_version": "gpt-4o"})
    .invoke({"x": 0})
    .__dict__["content"]
)


# 5
print(
    chain.with_config(configurable={"gpt_version": "gpt-3.5-turbo"})
    .invoke({"x": 0})
    .__dict__["content"]
)
```

<br>

# HubRunnable로 랭체인 허브의 설정 변경
```python
from langchain.runnables.hub import HubRunnable

prompt = HubRunnable("teddynote/rag-prompt-korean").configurable_fields(
    owner_repo_commit=ConfigurableField(
        id="hub_commit",
        name="Hub Commit",
        description="Korean RAG prompt by teddynote",
    )
)

# [
#     SystemMessage(
#         content="당신은 질문-답변(Question-Answering)을 수행하는 친절한 AI 어시스턴트입니다. 당신의 임무는 주어진 문맥(context) 에서 주어진 질문(question) 에 답하는 것입니다.\n검색된 다음 문맥(context) 을 사용하여 질문(question) 에 답하세요. 만약, 주어진 문맥(context) 에서 답을 찾을 수 없다면, 답을 모른다면 `주어진 정보에서 질문에 대한 정보를 찾을 수 없습니다` 라고 답하세요.\n한글로 답변해 주세요. 단, 기술적인 용어나 이름은 번역하지 않고 그대로 사용해 주세요. Don't narrate the answer, just answer the question. Let's think step-by-step.",
#         additional_kwargs={},
#         response_metadata={},
#     ),
#     HumanMessage(
#         content="#Question: \nHello \n\n#Context: \nWorld \n\n#Answer:",
#         additional_kwargs={},
#         response_metadata={},
#     ),
# ]
print(prompt.invoke({"question": "Hello", "context": "World"}).messages)

# messages = [
#     HumanMessage(
#         content="주어진 내용을 바탕으로 다음 문장을 요약하세요. 답변은 반드시 한글로 작성하세요\n\nCONTEXT: Hello\n\nSUMMARY:",
#         additional_kwargs={},
#         response_metadata={},
#     )
# ]
print(
    prompt.with_config(
        configurable={"hub_commit": "teddynote/simple-summary-korean"}
    ).invoke({"context": "Hello"})
)
```

<br>

# Configurable Alternatives로 Runnable 객체 자체의 대안 설정
- 특정 작업에서 사용할 모델이나 구성 요소의 대안을 정의하는 것
- 하나의 LLM 객체에서 여러 모델을 유연하게 선택할 수 있음
- `configurable_fields()`는 모델 안에 있는 매개변수를 바꿧다면 `configurable_alternatives()`는 모델 자체를 바꿈

```python
from langchain.prompts import PromptTemplate
from langchain_core.runnables import ConfigurableField
from langchain_openai import ChatOpenAI
from langchain_ollama import ChatOllama

llm = ChatOllama(temperature=0, model="exaone3.5:7.8b").configurable_alternatives(
    ConfigurableField(id="llm"),
    default_key="ollama",
    openai=ChatOpenAI(model="gpt-4o-mini"),
    gpt4o=ChatOpenAI(model="gpt-4o"),
)

prompt = PromptTemplate.from_template("{topic} 에 대해 간단히 설명해주세요.")

chain = prompt | llm

# 뉴진스(NewJeans)는 2022년 데뷔한 한국의 여자 아이돌 그룹으로, 하이브(HYBE) 소속의 레이블 ADOR에서 관리하고 있습니다. 그룹은 다섯 명의 멤버로 구성되어 있으며, 그들의 데뷔 앨범인 'New Jeans'는 혁신적이고 다채로운 음악 스타일로 주목받았습니다. 뉴진스는 90년대와 2000년대 초반의 레트로 감성을 현대적 해석으로 재현하면서, 젊은 세대의 감성을 대변하고 있습니다. 그들의 음악과 비주얼은 신선하고 독창적이며, 이로 인해 빠른 시간 안에 많은 팬을 확보했습니다. 특히 'Attention', 'Hype Boy', 'Cookie' 등의 곡이 큰 인기를 끌었습니다.
print(
    chain.with_config(configurable={"llm": "openai"})
    .invoke({"topic": "뉴진스"})
    .__dict__["content"]
)

# 뉴진스(NewJeans)는 대한민국의 걸그룹으로, ADOR 레이블에 소속되어 있습니다. 이 그룹은 2022년에 데뷔하였으며, 하이브(HYBE)의 산하 레이블인 ADOR에서 처음으로 런칭한 걸그룹입니다. 뉴진스는 독특한 음악 스타일과 대중적인 감성을 결합하여 많은 주목을 받았으며, 데뷔와 동시에 큰 인기를 끌었습니다. 멤버들은 대개 젊고 유능한 아티스트들로 구성되어 있으며, 그들의 음악과 퍼포먼스는 다양한 연령층의 팬들에게 사랑받고 있습니다. 뉴진스는 빠른 시간 안에 K-pop 씬에서 두각을 나타내며 활발한 활동을 이어가고 있습니다.
print(
    chain.with_config(configurable={"llm": "gpt4o"})
    .invoke({"topic": "뉴진스"})
    .__dict__["content"]
)

"""
뉴진스(NewJeans)는 LG 산하의 글로벌 음악 레이블인 **하이어뮤직**이 2022년에 데뷔시킨 **5인조 걸 그룹**입니다. 

**핵심 특징은 다음과 같습니다:**

* **신선하고 밝은 음악 스타일:**  팝, 힙합, 일렉트로닉 음악을 기반으로 한 밝고 경쾌한 곡들이 특징입니다.
* **젊은 세대 타겟:**  Z세대를 주요 타겟으로 하여 그들의 취향에 맞는 음악과 콘셉트를 선보입니다.
* **글로벌 팬덤 구축:** 데뷔 초기부터 전 세계적으로 큰 인기를 얻으며 글로벌 걸 그룹으로서의 가능성을 보여주고 있습니다.
* **멤버 구성:**  MINJE, HYELEE, Danielle, Harisu, SORAYA로 구성되어 있으며, 각 멤버들은 개성 넘치는 매력을 자랑합니다.

뉴진스는 데뷔 앨범 "**New Jeans**"로 큰 성공을 거두며, 이후 "**OMG**", "**Ditto**" 등의 앨범을 통해 꾸준히 성장하고 있습니다.
"""
print(
    chain.with_config(configurable={"llm": "ollama"})
    .invoke({"topic": "뉴진스"})
    .__dict__["content"]
)
```

<br>

# 프롬프트 대안 설정하기
```python
from langchain.prompts import PromptTemplate
from langchain_core.runnables import ConfigurableField
from langchain_openai import ChatOpenAI
from langchain_ollama import ChatOllama

llm = ChatOpenAI(temperature=0)

prompt = PromptTemplate.from_template(
    "{country} 의 수도는 어디야?"
).configurable_alternatives(
    ConfigurableField(id="prompt"),
    default_key="capital",
    area=PromptTemplate.from_template("{country} 의 면적은 얼마야?"),
    population=PromptTemplate.from_template("{country} 의 인구는 얼마야?"),
    eng=PromptTemplate.from_template("{input} 을 영어로 번역해주세요."),
)

chain = prompt | llm

# 대한민국의 총 면적은 약 100,363km² 입니다.
print(
    chain.with_config(configurable={"prompt": "area"})
    .invoke({"country": "대한민국"})
    .__dict__["content"]
)

# 2021년 7월 기준 대한민국의 인구는 약 5천만 명입니다.
print(
    chain.with_config(configurable={"prompt": "population"})
    .invoke({"country": "대한민국"})
    .__dict__["content"]
)

# Hello
print(
    chain.with_config(configurable={"prompt": "eng"})
    .invoke({"input": "안녕하세요"})
    .__dict__["content"]
)
```

<br>

# 프롬프트, LLM 모두 변경
```python
from langchain.prompts import PromptTemplate
from langchain_core.runnables import ConfigurableField
from langchain_openai import ChatOpenAI
from langchain_ollama import ChatOllama

llm = ChatOllama(temperature=0, model="exaone3.5:7.8b").configurable_alternatives(
    ConfigurableField(id="llm"),
    default_key="ollama",
    openai=ChatOpenAI(model="gpt-4o-mini"),
    gpt4=ChatOpenAI(model="gpt-4o"),
)

prompt = PromptTemplate.from_template(
    "{company} 에 대해서 20자 이내로 설명해 줘."
).configurable_alternatives(
    ConfigurableField(id="prompt"),
    default_key="description",
    founder=PromptTemplate.from_template("{company} 의 창립자는 누구인가요?"),
    competitor=PromptTemplate.from_template("{company} 의 경쟁사는 누구인가요?"),
)

chain = prompt | llm

# 애플(Apple Inc.)의 창립자는 스티브 잡스(Steve Jobs), 스티브 우즈니악(Steve Wozniak), 그리고 로널드 웨인(Ronald Wayne)입니다. 이들은 1976년 4월 1일에 애플을 설립했습니다. 스티브 잡스와 스티브 우즈니악은 특히 애플의 발전에 큰 영향을 미쳤으며, 잡스는 회사의 아이디어와 비전을 주도했습니다. 로널드 웨인은 애플의 초기 설립에 참여했지만, 빠르게 회사를 떠났습니다.
print(
    chain.with_config(configurable={"prompt": "founder", "llm": "openai"})
    .invoke({"company": "애플"})
    .__dict__["content"]
)

# 애플의 주요 경쟁사는 다양한 분야에서 존재합니다:

# 1. **스마트폰 및 태블릿**:
#    - 삼성 (Samsung)
#    - 화웨이 (Huawei) - 최근 제재로 인해 영향력이 줄었지만 여전히 일부 시장에서 경쟁
#    - 샤오미 (Xiaomi), 오포 (OPPO), 비보 (Vivo) 등 중국 제조사들

# 2. **개인용 컴퓨터**:
#    - 레노버 (Lenovo), HP, 델 테크놀로지스 (Dell Technologies) 등

# 3. **웨어러블 기기**:
#    - 삼성 (Samsung) - 갤럭시 워치 시리즈
#    - 핏비트 (Fitbit) - 특히 건강 모니터링 기기 분야에서

# 4. **스마트 홈 및 IoT 기기**:
#    - 삼성 (Samsung) - 스마트 스피커 및 홈 시큐리티 시스템
#    - 구글 (Google) - 네스트 (Nest) 제품군
print(
    chain.with_config(configurable={"prompt": "competitor"})
    .invoke({"company": "애플"})
    .__dict__["content"]
)

# 애플은 혁신적인 제품과 강력한 생태계로 알려져 있지만, 각 분야에서 다양한 기업들과 경쟁 관계에 있습니다. 특히 기술 트렌드와 시장 변화에 따라 경쟁 구도도 유동적일 수 있습니다.
# 혁신적인 스마트폰 및 기술 기업.
print(chain.invoke({"company": "애플"}).__dict__["content"])
```