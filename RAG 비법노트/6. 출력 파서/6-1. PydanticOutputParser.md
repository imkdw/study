# PydanticOutputParser
- `pydantic`은 파이썬에서 데이터 유효성검증, 데이터를 구조화된 형식으로 관리하는 유용한 라이브러리임
- 유효성검사는 에러를 방지하고 필요한 경고나 오류 메세지를 통해서 잘못된 데이터 입력을 막아줌
- `PydanticOutputParser`를 통해서 LLM에서 단순한 텍스트 대신 구조화된 모델로 변환해서 정보를 더 쉽게 처리가 가능함

<br>

### 구현해야되는 핵심 메소드
- **get_format_instructions()**
  - 언어모델이 출력해야 할 정보의 형식을 정의하는 지침을 제공함
  - 언어 모델이 출력해야 할 데이터 필드와 그 형태를 설명하는 지침을 문자열로 반환이 가능
  - 출력을 구조화하고 특정 데이터 모델에 맞게 변환하는데 매우 중요함
- **parse()**
  - 언어 모델의 출력을 받아서 이를 특정 구조로 분석하고 변환함
  - 입력된 문자열을 사전에 정의된 스카미에 따라 검증하고, 해당 스키마를 따르는 데이터 구조로 변환함

<br>

# 문자열로 나오는 출력 구조
```python
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_teddynote import logging
from langchain_teddynote.messages import stream_response

load_dotenv()

logging.langsmith("langchain_test")

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)

email_conversation = """From: 김철수 (chulsoo.kim@bikecorporation.me)
To: 이은채 (eunchae@teddyinternational.me)
Subject: "ZENESIS" 자전거 유통 협력 및 미팅 일정 제안

안녕하세요, 이은채 대리님,

저는 바이크코퍼레이션의 김철수 상무입니다. 최근 보도자료를 통해 귀사의 신규 자전거 "ZENESIS"에 대해 알게 되었습니다. 바이크코퍼레이션은 자전거 제조 및 유통 분야에서 혁신과 품질을 선도하는 기업으로, 이 분야에서의 장기적인 경험과 전문성을 가지고 있습니다.

ZENESIS 모델에 대한 상세한 브로슈어를 요청드립니다. 특히 기술 사양, 배터리 성능, 그리고 디자인 측면에 대한 정보가 필요합니다. 이를 통해 저희가 제안할 유통 전략과 마케팅 계획을 보다 구체화할 수 있을 것입니다.

또한, 협력 가능성을 더 깊이 논의하기 위해 다음 주 화요일(1월 15일) 오전 10시에 미팅을 제안합니다. 귀사 사무실에서 만나 이야기를 나눌 수 있을까요?

감사합니다.

김철수
상무이사
바이크코퍼레이션
"""

from langchain_core.prompts import PromptTemplate

prompt = PromptTemplate.from_template(
    "다음의 이메일 내용중 중요한 내용을 추출해 주세요.\n\n{email_conversation}"
)

llm = ChatOpenAI(temperature=0, model_name="gpt-4.1-mini")

chain = prompt | llm

answer = chain.stream({"email_conversation": email_conversation})

# 다음은 이메일의 중요한 내용입니다:

# - 김철수 상무(바이크코퍼레이션)가 이은채 대리(테디인터내셔널)에 "ZENESIS" 자전거 유통 협력 제안
# - ZENESIS 모델의 상세 브로슈어 요청 (기술 사양, 배터리 성능, 디자인 정보 포함)
# - 유통 전략 및 마케팅 계획 구체화를 위한 정보 필요
# - 협력 논의를 위한 미팅 제안: 1월 15일 화요일 오전 10시, 귀사 사무실에서 진행 희망%
output = stream_response(answer, return_output=True)
```

<br>

# JSON 형식으로 출력하기
```python
from dotenv import load_dotenv
from langchain_core.output_parsers import PydanticOutputParser
from langchain_openai import ChatOpenAI
from langchain_teddynote import logging
from langchain_teddynote.messages import stream_response
from pydantic import BaseModel, Field
from langchain_core.prompts import PromptTemplate

load_dotenv()

logging.langsmith("langchain_test")

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)

email_conversation = """From: 김철수 (chulsoo.kim@bikecorporation.me)
To: 이은채 (eunchae@teddyinternational.me)
Subject: "ZENESIS" 자전거 유통 협력 및 미팅 일정 제안

안녕하세요, 이은채 대리님,

저는 바이크코퍼레이션의 김철수 상무입니다. 최근 보도자료를 통해 귀사의 신규 자전거 "ZENESIS"에 대해 알게 되었습니다. 바이크코퍼레이션은 자전거 제조 및 유통 분야에서 혁신과 품질을 선도하는 기업으로, 이 분야에서의 장기적인 경험과 전문성을 가지고 있습니다.

ZENESIS 모델에 대한 상세한 브로슈어를 요청드립니다. 특히 기술 사양, 배터리 성능, 그리고 디자인 측면에 대한 정보가 필요합니다. 이를 통해 저희가 제안할 유통 전략과 마케팅 계획을 보다 구체화할 수 있을 것입니다.

또한, 협력 가능성을 더 깊이 논의하기 위해 다음 주 화요일(1월 15일) 오전 10시에 미팅을 제안합니다. 귀사 사무실에서 만나 이야기를 나눌 수 있을까요?

감사합니다.

김철수
상무이사
바이크코퍼레이션
"""


prompt = PromptTemplate.from_template(
    "다음의 이메일 내용중 중요한 내용을 추출해 주세요.\n\n{email_conversation}"
)

chain = prompt | llm


class EmailSummary(BaseModel):
    person: str = Field(description="메일을 보낸 사람")
    email: str = Field(description="메일을 보낸 사람의 이메일 주소")
    subject: str = Field(description="메일 제목")
    summary: str = Field(description="메일 본문을 요약한 텍스트")
    date: str = Field(description="메일 본문에 언급된 미팅 날짜와 시간")


parser = PydanticOutputParser(pydantic_object=EmailSummary)

# {
#     "properties": {
#         "person": {
#             "description": "메일을 보낸 사람",
#             "title": "Person",
#             "type": "string",
#         },
#         "email": {
#             "description": "메일을 보낸 사람의 이메일 주소",
#             "title": "Email",
#             "type": "string",
#         },
#         "subject": {"description": "메일 제목", "title": "Subject", "type": "string"},
#         "summary": {
#             "description": "메일 본문을 요약한 텍스트",
#             "title": "Summary",
#             "type": "string",
#         },
#         "date": {
#             "description": "메일 본문에 언급된 미팅 날짜와 시간",
#             "title": "Date",
#             "type": "string",
#         },
#     },
#     "required": ["person", "email", "subject", "summary", "date"],
# }
print(parser.get_format_instructions())

prompt = PromptTemplate.from_template(
    """
You are a helpful assistant. Please answer the following questions in KOREAN.

QUESTION:
{question}

EMAIL CONVERSATION:
{email_conversation}

FORMAT:
{format}
"""
)

prompt = prompt.partial(format=parser.get_format_instructions())

# The output should be formatted as a JSON instance that conforms to the JSON schema below.

# As an example, for the schema {"properties": {"foo": {"title": "Foo", "description": "a list of strings", "type": "array", "items": {"type": "string"}}}, "required": ["foo"]}
# the object {"foo": ["bar", "baz"]} is a well-formatted instance of the schema. The object {"properties": {"foo": ["bar", "baz"]}} is not well-formatted.

# Here is the output schema:
# ```
# {"properties": {"person": {"description": "메일을 보낸 사람", "title": "Person", "type": "string"}, "email": {"description": "메일을 보낸 사람의 이메일 주소", "title": "Email", "type": "string"}, "subject": {"description": "메일 제목", "title": "Subject", "type": "string"}, "summary": {"description": "메일 본문을 요약한 텍스트", "title": "Summary", "type": "string"}, "date": {"description": "메일 본문에 언급된 미팅 날짜와 시간", "title": "Date", "type": "string"}}, "required": ["person", "email", "subject", "summary", "date"]}
# ```
# input_variables=['email_conversation', 'question'] input_types={} partial_variables={'format': 'The output should be formatted as a JSON instance that conforms to the JSON schema below.\n\nAs an example, for the schema {"properties": {"foo": {"title": "Foo", "description": "a list of strings", "type": "array", "items": {"type": "string"}}}, "required": ["foo"]}\nthe object {"foo": ["bar", "baz"]} is a well-formatted instance of the schema. The object {"properties": {"foo": ["bar", "baz"]}} is not well-formatted.\n\nHere is the output schema:\n```\n{"properties": {"person": {"description": "메일을 보낸 사람", "title": "Person", "type": "string"}, "email": {"description": "메일을 보낸 사람의 이메일 주소", "title": "Email", "type": "string"}, "subject": {"description": "메일 제목", "title": "Subject", "type": "string"}, "summary": {"description": "메일 본문을 요약한 텍스트", "title": "Summary", "type": "string"}, "date": {"description": "메일 본문에 언급된 미팅 날짜와 시간", "title": "Date", "type": "string"}}, "required": ["person", "email", "subject", "summary", "date"]}\n```'} template='\nYou are a helpful assistant. Please answer the following questions in KOREAN.\n\nQUESTION:\n{question}\n\nEMAIL CONVERSATION:\n{email_conversation}\n\nFORMAT:\n{format}\n'
print(prompt)

chain = prompt | llm

response = chain.stream(
    {
        "email_conversation": email_conversation,
        "question": "이메일 내용중 주요 내용을 추출해 주세요.",
    }
)

# {
#   "person": "김철수",
#   "email": "chulsoo.kim@bikecorporation.me",
#   "subject": "\"ZENESIS\" 자전거 유통 협력 및 미팅 일정 제안",
#   "summary": "김철수 상무가 이은채 대리님에게 바이크코퍼레이션의 자전거 'ZENESIS'에 대한 브로슈어 요청과 협력 논의를 위한 미팅 제안을 보냈습니다.",
#   "date": "1월 15일 오전 10시"
# }
output = stream_response(response, return_output=True)

structured_output = parser.parse(output)

# person='김철수' email='chulsoo.kim@bikecorporation.me' subject='"ZENESIS" 자전거 유통 협력 및 미팅 일정 제안' summary="김철수 상무가 이은채 대리님에게 'ZENESIS' 자전거에 대한 브로슈어 요청과 협력 논의를 위한 미팅 제안을 보냈습니다." date='1월 15일 오전 10시'
print(structured_output)
```