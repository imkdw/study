# Map-Refine 요약
- Map-Reduce랑 비슷하지만 Reduce 단계 대신 생성된 요약을 순차적으로 처리함으로써 최종 요약본을 점진적으로 개선함
- 모든 청크가 처리될 때까지 Refine 단게를 반복하여 최종 요약본으로 만들어 내는 방식임
- 이러한 방식은 요약본을 순서대로 처리하므로 문서의 맥락이 어느정도 유지된다는 장점이 있음
- 하지만 여러 차례 반복하므로 그만큼 비용과 시간이 더 많이 소모됨
- 내용의 흐름이 중요하다면 Map-Refine을, 빠른 처리가중요하다면 Map-Reduce 방식을 고려하는게 좋음

<br>

# 구현
```python
from dotenv import load_dotenv
from langchain_core.output_parsers import StrOutputParser
from langchain_teddynote import logging

load_dotenv()

logging.langsmith("test")

# ==============================================

from langchain import hub
from langchain_core.output_parsers import StrOutputParser
from langchain_community.document_loaders import PyPDFLoader
from langchain_ollama import ChatOllama

loader = PyPDFLoader(
    "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"
)
docs = loader.load()
docs = docs[3:8]

map_llm = ChatOllama(
    model="exaone3.5:7.8b",
    temperature=0,
)

map_summary_prompt = hub.pull("teddynote/map-summary-prompt")

# ================================ System Message ================================

# You are an expert summarizer. Your task is to summarize the following document in {language}.

# ================================ Human Message =================================

# Extract most important main thesis from the documents, then summarize in bullet points.

# #Format:
# - summary 1
# - summary 2
# - summary 3
# -...

# Here is a given document: 
# {documents}

# Write 1~5 sentences. Think step by step.
# #Summary:
map_summary_prompt.pretty_print()

map_chain = map_summary_prompt | map_llm | StrOutputParser()

# - **공군의 중요성 강조**: 현대 전쟁에서 항공우주력의 중요성이 증대되고 있으며, 특히 제공권 장악이 승리의 핵심 요소임을 강조한다.
# - **첨단 무기체계 확보**: 대한민국 공군은 KF-X 등 첨단 무기체계를 확보하여 조국의 영공 방어를 강화하고 있다.
# - **전문 인력 양성**: 공군은 창의적이고 전문적인 능력을 갖춘 정예 군인 양성에 힘쓰고 있다.
# - **군인의 의무와 자세**: 훈련병들은 국방의 신성한 의무를 수행하며 법규 준수와 상관의 명령에 대한 복종, 그리고 어떠한 상황에서도 임무 완수를 위한 자세를 갖추어야 함을 강조한다.
# - **역사적 통찰**: 제2차 세계대전 시기 Giulio Douhet의 제공권 장악 이론을 인용하여 현대 군사 전략에서 항공우주력의 핵심적 역할을 재확인한다.
print(map_chain.invoke({"documents": docs[0], "language": "Korean"}))

input_doc = [{"documents": doc, "language": "Korean"} for doc in docs]

# [
#     "- **공군의 중요성 강조**: 현대 전쟁에서 항공우주력의 중요성이 증대되고 있으며, 특히 제공권 장악이 승리의 핵심 요소임을 강조한다.\n- **첨단 무기체계 확보**: 대한민국 공군은 KF-X 등 첨단 무기체계를 확보하여 조국의 영공 방어를 강화하고 있다.\n- **전문 인력 양성**: 공군은 창의적이고 전문적인 능력을 갖춘 정예 군인 양성에 힘쓰고 있다.\n- **군인의 의무와 자세**: 훈련병들은 국방의 신성한 의무를 수행하며 법규 준수와 상관의 명령에 대한 복종, 그리고 어떠한 상황에서도 임무 완수를 위한 자세를 갖추어야 함을 강조한다.\n- **역사적 통찰**: 제2차 세계대전 시기 Giulio Douhet의 제공권 장악 이론을 인용하여 현대 군사 전략에서 항공우주력의 핵심적 역할을 재확인한다.",
#     "- **병사의 역할과 자부심 강조**: 공군 병사들은 국방의 신성한 의무를 수행하며, 공군의 항공우주력 강화와 영공 방어에 중요한 역할을 맡고 있어 긍지와 자부심을 가져야 함을 강조합니다.\n- **특기 이해의 중요성**: 군사 특기를 충분히 이해하는 것이 복무에 필수적임을 강조하며, 이 책자는 각 특기의 직무 내용, 배속 가능 부대, 교육 기관 및 기간, 교육 내용 등을 상세히 설명합니다.\n- **책자의 목적**: 공군 병사들의 특기별 직무 이해를 돕기 위해 제작된 이 책자는 실질적인 정보 제공을 통해 복무 효율성을 높이는데 초점을 맞춥니다.\n- **지원자와 훈련병을 위한 기원**: 모든 훈련병과 지원자들의 성공을 기원하며, 이 책자가 그들의 군 생활에 유용한 지침서가 되기를 바랍니다.\n- **발행 정보**: 2016년 2월에 공군 교육사령부 제27예비단장에 의해 발행되었습니다.",
#     "주어진 문서 메타데이터만으로는 구체적인 내용을 파악하기 어렵지만, 일반적인 학술 또는 전문 문서의 구조를 바탕으로 추정하여 요약을 구성해 보겠습니다. 실제 내용이 포함된 페이지 5의 내용이 특수 군인 전문 분야에 관한 것으로 보이므로, 다음과 같이 요약할 수 있습니다:\n\n- **특수 군인 역할의 중요성 강조**: 문서는 현대 군사 전략에서 특수 군인의 역할과 중요성을 중심으로 다룹니다.\n- **기술 및 훈련의 혁신**: 최신 기술과 고도화된 훈련 방법이 특수 군인의 효율성과 성공률을 크게 향상시킨다는 점을 강조합니다.\n- **전략적 유연성**: 특수 군인 팀은 다양한 환경과 임무에 빠르게 적응하고 대응할 수 있는 유연성을 갖추는 것이 필수적임을 설명합니다.\n- **국제 협력의 필요성**: 국제적인 협력과 정보 공유가 특수 작전의 성공을 위한 핵심 요소로 제시됩니다.\n- **윤리적 고려사항**: 특수 작전 수행 시 윤리적 기준 준수의 중요성도 함께 다루고 있습니다.",
#     "주어진 문서는 군인의 특정 전문 분야(병 특기)에 대한 포괄적인 가이드라인을 제공하고 있습니다. 주요 내용은 다음과 같습니다:\n\n- **병 특기의 개요**: 특기의 기본 개념과 중요성을 설명합니다 (페이지 7).\n- **특기분류 기준 및 절차**: 특기를 분류하고 평가하는 기준과 절차를 상세히 다룹니다 (페이지 13부터 시작).\n- **특기별 세부 내용**: 각 특기의 구체적인 내용과 요구사항을 설명합니다 (페이지 17부터 시작).\n- **질의응답**: 독자들이 자주 묻는 질문과 그에 대한 답변을 제공하여 이해를 돕습니다 (페이지 123).\n\n이 문서는 군인들이 자신의 전문 분야를 이해하고 발전시키는 데 필요한 핵심 정보를 체계적으로 정리하고 있습니다.",
#     "주어진 문서 내용이 제한적이고 구체적인 내용이 페이지 7에 국한되어 있어 전체적인 맥락을 정확히 파악하기 어렵지만, 제공된 정보를 바탕으로 다음과 같이 요약할 수 있습니다:\n\n- **병 특기 개요** 섹션은 군인의 특수 기술 및 전문 분야에 대한 개요를 다루고 있습니다.\n- 이 문서는 2016년 1월에 제작되었으며, Adobe PDF와 InDesign을 통해 생성되었습니다.\n- **병 특기**에 대한 설명은 군인의 역할 다양화와 전문성 강화에 중점을 두고 있을 것으로 추정됩니다.\n- 구체적인 내용이 제한적이므로, 더 자세한 내용은 전체 문서를 검토해야 합니다.\n\n더 구체적인 요약을 위해서는 해당 페이지의 내용이 포함된 전체 문서의 내용이 필요합니다.",
# ]
print(map_chain.batch(input_doc))
```