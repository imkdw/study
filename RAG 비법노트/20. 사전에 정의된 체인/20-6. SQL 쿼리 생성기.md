# SQL 쿼리 생성기
- 일반적으로 DB 조회를 위해서는 SQL 쿼리문을 보내야하는데 이 부분을 에이전트가 대신 만들어주는 작업
- 에이전트는 LLM과 도구를 결합한 것임

<br>

# LLM으로 디비 접근
```python
from dotenv import load_dotenv
from langchain_teddynote import logging

load_dotenv()

logging.langsmith("test")

# ==============================================
from langchain_openai import ChatOpenAI
from langchain.chains import create_sql_query_chain
from langchain_community.utilities import SQLDatabase
from langchain_core.prompts import PromptTemplate
from langchain_community.tools.sql_database.tool import QuerySQLDataBaseTool


db = SQLDatabase.from_uri(
    "sqlite:////Users/imkdw/study/RAG 비법노트/20. 사전에 정의된 체인/finance.db"
)

# ['accounts', 'customers', 'transactions']
print(db.get_usable_table_names())

prompt = PromptTemplate.from_template(
    """Given an input question, first create a syntactically correct {dialect} query to run, then look at the results of the query and return the answer. Unless the user specifies in his question a specific number of examples he wishes to obtain, always limit your query to at most {top_k} results. You can order the results by a relevant column to return the most interesting examples in the database.
Use the following format:

Question: "Question here"
SQLQuery: "SQL Query to run"
SQLResult: "Result of the SQLQuery"
Answer: "Final answer here"

Only use the following tables:
{table_info}

Here is the description of the columns in the tables:
`cust`: customer name
`prod`: product name
`trans`: transaction date

Question: {input}"""
).partial(dialect=db.dialect)

llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0)

chain = create_sql_query_chain(llm, db, prompt)

generated_sql_query = chain.invoke({"question": "고객의 이름을 나열하세요"})

# "SELECT name\nFROM customers"
print(generated_sql_query.__repr__())

execute_query = QuerySQLDataBaseTool(db=db)

# [('테디',), ('폴',), ('셜리',), ('민수',), ('지영',), ('은정',)]
print(execute_query.invoke({"query": generated_sql_query}))

write_query = create_sql_query_chain(llm, db)

chain = write_query | execute_query

# [('teddy@example.com',)]
print(chain.invoke({"question": "테디의 이메일을 조회하세요"}))
```

<br>

# LCEL로 답변 개선하기
```python
from langchain_openai import ChatOpenAI
from langchain.chains import create_sql_query_chain
from langchain_community.utilities import SQLDatabase
from langchain_core.prompts import PromptTemplate
from langchain_community.tools.sql_database.tool import QuerySQLDataBaseTool
from operator import itemgetter
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough


db = SQLDatabase.from_uri(
    "sqlite:////Users/imkdw/study/RAG 비법노트/20. 사전에 정의된 체인/finance.db"
)

llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0)

execute_query = QuerySQLDataBaseTool(db=db)

write_query = create_sql_query_chain(llm, db)

answer_prompt = PromptTemplate.from_template(
    """Given the following user question, corresponding SQL query, and SQL result, answer the user question.

Question: {question}
SQL Query: {query}
SQL Result: {result}
Answer: """
)

answer = answer_prompt | llm | StrOutputParser()

chain = (
    RunnablePassthrough.assign(query=write_query).assign(
        result=itemgetter("query") | execute_query
    )
    | answer
)

# 테디의 transaction의 합계는 -965.7 입니다.
print(chain.invoke({"question": "테디의 transaction 의 합계를 구하세요"}))
```

<br>

# Agent 활용하기
```python
from langchain_openai import ChatOpenAI
from langchain_community.utilities import SQLDatabase
from langchain_community.agent_toolkits import create_sql_agent

llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0)

db = SQLDatabase.from_uri(
    "sqlite:////Users/imkdw/study/RAG 비법노트/20. 사전에 정의된 체인/finance.db"
)

agent_executor = create_sql_agent(llm, db=db, agent_type="openai-tools", verbose=True)

# > Entering new SQL Agent Executor chain...

# Invoking: `sql_db_list_tables` with `{}`


# accounts, customers, transactions
# Invoking: `sql_db_schema` with `{'table_names': 'transactions'}`


# CREATE TABLE transactions (
#         transaction_id INTEGER,
#         account_id INTEGER,
#         amount REAL,
#         transaction_date TEXT,
#         PRIMARY KEY (transaction_id),
#         FOREIGN KEY(account_id) REFERENCES accounts (account_id)
# )

# /*
# 3 rows from transactions table:
# transaction_id  account_id      amount  transaction_date
# 1       1       74.79   2024-07-13
# 2       1       -224.1  2024-05-13
# 3       1       -128.9  2024-01-25
# */
# Invoking: `sql_db_query` with `{'query': 'SELECT account_id, SUM(amount) AS total_amount FROM transactions WHERE account_id IN (1, 2) GROUP BY account_id'}`


# [(1, -965.7), (2, 743.13)]테디의 거래 합계는 -965.7이고, 셜리의 거래 합계는 743.13입니다.

# > Finished chain.
# {'input': '테디와 셜리의 transaction 의 합계를 구하고 비교하세요', 'output': '테디의 거래 합계는 -965.7이고, 셜리의 거래 합계는 743.13입니다.'}
print(
    agent_executor.invoke(
        {"input": "테디와 셜리의 transaction 의 합계를 구하고 비교하세요"}
    )
)
```