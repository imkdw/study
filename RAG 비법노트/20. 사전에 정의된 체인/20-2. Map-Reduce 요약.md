# Map-Reduce 요약
- 대규모 문서를 언어 모델의 토큰 제한에 구애받지 않고 효율적으로 요약하는 기법
- 총 2개의 단계로 나눠짐

<br>

### Map 단계
- 문서를 작은 청크로 나누는 단계
- 전체 문서를 특정한 기준에 따라 청크로 나눠 각 청크마다 요약을 만듬
- 이 때 일반적인 텍스트 분할의 청크보다는 더 큰 페이지 단위로 분할하는 편임

<br>

### Reduce 단계
- 각 청크의 요약을 결합하는 단계
- Map 단계에서 나온 요약본들을 하나의 최종 요약본으로 통합시킴

<br>

# 기본적인 요약 및 내용 이어붙히기
```python
from langchain_community.document_loaders import PyPDFLoader
from langchain_ollama import ChatOllama
from langchain_teddynote.callbacks import StreamingCallback
from langchain import hub
from langchain_core.output_parsers import StrOutputParser
from langchain_teddynote.messages import stream_response

llm = ChatOllama(
    model="exaone3.5:7.8b",
    streaming=True,
    temperature=0,
    callbacks=[StreamingCallback()],
)


loader = PyPDFLoader(
    "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"
)
docs = loader.load()
docs = docs[3:5]

map_prompt = hub.pull("teddynote/map-prompt")

map_chain = map_prompt | llm | StrOutputParser()

doc_summaries = map_chain.batch(docs)

reduce_prompt = hub.pull("teddynote/reduce-prompt")

reduce_chain = reduce_prompt | llm | StrOutputParser()


answer = reduce_chain.stream(
    {"doc_summaries": "\n".join(doc_summaries), "language": "Korean"}
)

# - **대한민국 공군은 현대 전쟁의 복잡성 속에서 항공우주력의 중요성을 강조하며, 조국의 영공방위를 위해 첨단 무기체계의 확보와 함께 전문성과 창의력을 갖춘 정예 군인 양성에 힘쓰고 있습니다.**
# - **공군 훈련병들은 신성한 국방 의무를 수행하는 국민으로서 법규 준수와 상관의 명령에 대한 복종, 그리고 어떠한 상황에서도 임무 완수를 위한 헌신이 요구됩니다.**
# - **이러한 노력은 제2차 세계대전 항공전략 사상가 Giulio Douhet의 제공권 장악의 중요성에 대한 인식을 현대적 맥락에서 재해석한 결과로, 비대칭 전력과 정보전의 시대에 공군의 역할이 더욱 강조되고 있음을 반영합니다.**- 공군 병 특기 소개 책자의 주요 목표는 병사들이 자신의 군사 특기를 충분히 이해하고, 이를 통해 국방의 의무를 수행하는 데 필요한 긍지와 자부심을 갖도록 돕는 것입니다.
# - 이 책자는 각 특기의 직무 내용뿐만 아니라 배속 가능한 부대, 교육 기관 및 과정, 교육 내용, 그리고 특기 분류에 필요한 기준과 절차 등을 상세히 설명하고 있습니다.
# - 궁극적으로, 이 문서는 훈련병과 지원자들이 공군 내에서의 역할과 책임을 명확히 이해하고 성공적으로 복무할 수 있도록 지원하는 것을 목표로 합니다./Users/imkdw/.pyenv/versions/3.11.13/lib/python3.11/site-packages/langsmith/client.py:272: LangSmithMissingAPIKeyWarning: API key must be provided when using hosted LangSmith API
#   warnings.warn(
# -- ** **공공군군의의 핵심 핵심 전략 전략****

#     -- 현대 현대 전쟁 전쟁에서에서 항공우주 항공우주력력의의 중요 중요성성 강조 강조

#     -- 첨단 첨단 무기 무기체계체계 확보 확보와와 전문 전문성성,, 창의력 창의력을을 갖춘 갖춘 군인 군인 양성 양성에에 집중 집중


# -- ** **훈련훈련병병의의 역할 역할과과 의무 의무****

#     -- 신성 신성한한 국방 국방 의무 의무 수행 수행을을 위한 위한 법규 법규 준수 준수와와 상관 상관 명령 명령 복종 복종

#     -- 어떠 어떠한한 상황 상황에서에서도도 임무 임무 완수 완수를를 위한 위한 헌신 헌신 요구 요구


# -- ** **역사역사적적 맥락 맥락과과 현대 현대적적 적용 적용****

#     -- Giul Giulioio Dou Douhethet의의 제공 제공권권 장악 장악 이론 이론을을 현대 현대 비대칭 비대칭 전력 전력 및 및 정보 정보전전 시대 시대에에 맞 맞게게 재해 재해석석

#     -- 공군 공군의의 역할 역할과과 중요 중요성성 강조 강조의의 현대 현대적적 의미 의미


# -- ** **병병 특기 특기 소개 소개 책자 책자의의 목적 목적****

#     -- 병사 병사들들의의 군사 군사 특기 특기 이해 이해 증진 증진 및 및 국방 국방 의무 의무 수행 수행에에 대한 대한 자부심 자부심 고양 고양

#     -- 특기 특기별별 직무 직무 내용 내용,, 배속 배속 가능 가능 부대 부대,, 교육 교육 과정 과정 및 및 기준 기준 상세 상세 설명 설명


# -- ** **책책자자의의 최종 최종 목표 목표****

#     -- 훈련 훈련병병과과 지원자 지원자들이들이 공군 공군 내 내 역할 역할과과 책임 책임 명확히 명확히 이해 이해하하도록도록 지원 지원

#     -- 성공 성공적적인인 복무 복무를를 위한 위한 지침 지침 제공 제공%
stream_response(answer)
```

<br>

# 데코레이터를 통해 여러 동작 연결하기
- 데코레이터 chain을 이용해서 하나의 체인으로 연결함
- 데코레이터는 여러 동작을 하나로 묶어서 일괄적으로 실행할 때 유용함

```python
from langchain_community.document_loaders import PyPDFLoader
from langchain_ollama import ChatOllama
from langchain_teddynote.callbacks import StreamingCallback
from langchain import hub
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import chain


loader = PyPDFLoader(
    "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"
)
docs = loader.load()
docs = docs[3:5]


@chain
def map_reduce_chain(docs):
    map_llm = ChatOllama(
        model="exaone3.5:7.8b",
        streaming=True,
        temperature=0,
        callbacks=[StreamingCallback()],
    )

    map_prompt = hub.pull("teddynote/map-prompt")
    map_chain = map_prompt | map_llm | StrOutputParser()
    doc_summaries = map_chain.batch(docs)

    reduce_prompt = hub.pull("teddynote/reduce-prompt")
    reduce_llm = ChatOllama(
        model="exaone3.5:7.8b",
        streaming=True,
        temperature=0,
        callbacks=[StreamingCallback()],
    )
    reduce_chain = reduce_prompt | reduce_llm | StrOutputParser()

    return reduce_chain.invoke(
        {"doc_summaries": "\n".join(doc_summaries), "language": "Korean"}
    )


# - **대한민국 공군은 현대 전쟁의 복잡성 속에서 항공우주력의 중요성을 강조하며, 조국의 영공방위를 위해 첨단 무기체계의 확보와 함께 전문성과 창의력을 갖춘 정예 군인 양성에 힘쓰고 있습니다.**
# - **공군 훈련병들은 신성한 국방 의무를 수행하는 국민으로서 법규 준수와 상관의 명령에 대한 복종, 그리고 어떠한 상황에서도 임무 완수를 위한 헌신이 요구됩니다.**
# - **이러한 노력은 제2차 세계대전 항공전략 사상가 Giulio Douhet의 제공권 장악의 중요성에 대한 인식을 현대적 맥락에서 재해석한 결과로, 비대칭 전력과 정보전의 시대에 공군의 역할이 더욱 강조되고 있음을 반영합니다.**- 공군 병 특기 소개 책자의 주요 목표는 병사들이 자신의 군사 특기를 충분히 이해하고, 이를 통해 국방의 의무를 수행하는 데 필요한 긍지와 자부심을 갖도록 돕는 것입니다.
# - 이 책자는 각 특기의 직무 내용뿐만 아니라 배속 가능한 부대, 교육 기관 및 과정, 교육 내용, 그리고 특기 분류에 필요한 기준과 절차 등을 상세히 설명하고 있습니다.
# - 궁극적으로, 이 문서는 훈련병과 지원자들이 공군 내에서의 역할과 책임을 명확히 이해하고 성공적으로 복무할 수 있도록 지원하는 것을 목표로 합니다.
answer = map_reduce_chain.invoke(docs)
```