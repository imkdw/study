# CoD(Chain Of Destiny) 요약
- GPT-4를 사용해서 초기에 엔티티가 적은 요약을 생성하고 길이를 늘리지 않으면서 누락된 중요 엔티티들을 반복적으로 통합하는 과정을 거치는 요약 방법
- 반복적으로 통합한다는 뜻은 한 번에 요약을 끝내는게 아닌 완성된 요약본에 대해다시 개선하는 작업을 반복한다는 뜻
- 엔티티는 사람 이름, 상품명 등 중요한 정보 개체를 의미함
- 일반적인 요약 작업을 하다보면 엔티티가 누락되기 쉬운데 CoD에서는 단계적으로 중요한 엔티티를 추가해서 밀도 높은 요약을 완성해 나감

<br>

# 구현
```python
from dotenv import load_dotenv
from langchain_core.output_parsers import StrOutputParser
from langchain_teddynote import logging

load_dotenv()

logging.langsmith("test")

# ==============================================

from langchain import hub
from langchain_core.output_parsers import StrOutputParser
from langchain_community.document_loaders import PyPDFLoader
import textwrap
from langchain import hub
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import SimpleJsonOutputParser

loader = PyPDFLoader(
    "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"
)
docs = loader.load()
docs = docs[3:8]

# ================================ System Message ================================

# As an expert copy-writer, you will write increasingly concise, entity-dense summaries of the user provided {content_category}. The initial summary should be under {max_words} words and contain {entity_range} informative Descriptive Entities from the {content_category}.

# A Descriptive Entity is:
# - Relevant: to the main story.
# - Specific: descriptive yet concise (5 words or fewer).
# - Faithful: present in the {content_category}.
# - Anywhere: located anywhere in the {content_category}.

# # Your Summarization Process
# - Read through the {content_category} and the all the below sections to get an understanding of the task.
# - Pick {entity_range} informative Descriptive Entities from the {content_category} (";" delimited, do not add spaces).
# - In your output JSON list of dictionaries, write an initial summary of max {max_words} words containing the Entities.
# - You now have `[{"missing_entities": "...", "denser_summary": "..."}]`

# Then, repeat the below 2 steps {iterations} times:

# - Step 1. In a new dict in the same list, identify {entity_range} new informative Descriptive Entities from the {content_category} which are missing from the previously generated summary.
# - Step 2. Write a new, denser summary of identical length which covers every Entity and detail from the previous summary plus the new Missing Entities.

# A Missing Entity is:
# - An informative Descriptive Entity from the {content_category} as defined above.
# - Novel: not in the previous summary.

# # Guidelines
# - The first summary should be long (max {max_words} words) yet highly non-specific, containing little information beyond the Entities marked as missing. Use overly verbose language and fillers (e.g., "this {content_category} discusses") to reach ~{max_words} words.
# - Make every word count: re-write the previous summary to improve flow and make space for additional entities.
# - Make space with fusion, compression, and removal of uninformative phrases like "the {content_category} discusses".
# - The summaries should become highly dense and concise yet self-contained, e.g., easily understood without the {content_category}.
# - Missing entities can appear anywhere in the new summary.
# - Never drop entities from the previous summary. If space cannot be made, add fewer new entities.
# - You're finished when your JSON list has 1+{iterations} dictionaries of increasing density.

# # IMPORTANT
# - Remember, to keep each summary to max {max_words} words.
# - Never remove Entities or details. Only add more from the {content_category}.
# - Do not discuss the {content_category} itself, focus on the content: informative Descriptive Entities, and details.
# - Remember, if you're overusing filler phrases in later summaries, or discussing the {content_category} itself, not its contents, choose more informative Descriptive Entities and include more details from the {content_category}.
# - Answer with a minified JSON list of dictionaries with keys "missing_entities" and "denser_summary".
# - "denser_summary" should be written in the same language as the "content".

# ## Example output
# [{"missing_entities": "ent1;ent2", "denser_summary": "<vague initial summary with entities 'ent1','ent2'>"}, {"missing_entities": "ent3", "denser_summary": "denser summary with 'ent1','ent2','ent3'"}, ...]

# ================================ Human Message =================================

# {content_category}:
# {content}
cod_prompt = hub.pull("teddynote/chain-of-density-prompt")


# {content}를 제외한 모든 입력에 대한 기본값을 지정함
cod_chain_inputs = {
    "content": lambda d: d.get("content"),
    "content_category": lambda d: d.get("content_category", "Article"),
    "entity_range": lambda d: d.get("entity_range", "1-3"),
    "max_words": lambda d: int(d.get("max_words", 80)),
    "iterations": lambda d: int(d.get("iterations", 5)),
}

cod_chain = (
    cod_chain_inputs
    | cod_prompt
    | ChatOpenAI(temperature=0, model="gpt-4o-mini")
    | SimpleJsonOutputParser()
)

# 두 번째 체인 생성, 최종 요약만 추출 (스트리밍 불가능, 최종 결과가 필요)
cod_final_summary_chain = cod_chain | (
    lambda output: output[-1].get(
        "denser_summary", '오류: 마지막 딕셔너리에 "denser_summary" 키가 없습니다'
    )
)

content = docs[1].page_content
print(content)

results: list[dict[str, str]] = []

for partial_json in cod_chain.stream(
    {"content": content, "content_category": "Article"}
):
    results = partial_json

    print(results, end="\r", flush=True)

total_summaries = len(results)
print("\n")

i = 1
for cod in results:
    added_entities = ", ".join(
        [
            ent.strip()
            for ent in cod.get(
                "missing_entities", 'ERR: "missing_entiies" key not found'
            ).split(";")
        ]
    )
    summary = cod.get("denser_summary", 'ERR: missing key "denser_summary"')

    print(
        f"### CoD Summary {i}/{total_summaries}, 추가된 엔티티(entity): {added_entities}"
        + "\n"
    )
    print(textwrap.fill(summary, width=80) + "\n")
    i += 1

"""
### CoD Summary 1/5, 추가된 엔티티(entity): 공군, 병, 특기

부대관리훈령에 따르면, '병은 국민의 한 사람으로서 신성한 국방의 의무를 수행하고 있다는 긍지와 자부심을 가지고, 복무에 충실하여야' 합니다.
공군의 첨단 항공우주력 확보 및 조국 영공방위 임무 완수를 위해 여러분은 큰 역할을 하게 될 것입니다. 본 공군 병 특기 소개 책자는 특기별
직무내용, 배속 가능 부대, 교육기관 및 기간 등을 설명합니다.

### CoD Summary 2/5, 추가된 엔티티(entity): 교육기관, 직무내용, 훈련병

부대관리훈령에 따르면, '병은 국민의 한 사람으로서 신성한 국방의 의무를 수행하고 있다는 긍지와 자부심을 가지고, 복무에 충실하여야' 합니다.
공군의 첨단 항공우주력 확보 및 조국 영공방위 임무 완수를 위해 여러분은 큰 역할을 하게 될 것입니다. 본 공군 병 특기 소개 책자는 특기별
직무내용, 배속 가능 부대, 교육기관 및 기간 등을 상세히 설명합니다.

### CoD Summary 3/5, 추가된 엔티티(entity): 복무, 기준, 절차

부대관리훈령에 따르면, '병은 국민의 한 사람으로서 신성한 국방의 의무를 수행하고 있다는 긍지와 자부심을 가지고, 복무에 충실하여야' 합니다.
공군의 첨단 항공우주력 확보 및 조국 영공방위 임무 완수를 위해 여러분은 큰 역할을 하게 될 것입니다. 본 공군 병 특기 소개 책자는 특기별
직무내용, 배속 가능 부대, 교육기관, 복무 기준 및 절차를 상세히 설명합니다.

### CoD Summary 4/5, 추가된 엔티티(entity): 조국, 항공우주력, 특기교육

부대관리훈령에 따르면, '병은 국민의 한 사람으로서 신성한 국방의 의무를 수행하고 있다는 긍지와 자부심을 가지고, 복무에 충실하여야' 합니다.
공군의 첨단 항공우주력 확보 및 조국 영공방위 임무 완수를 위해 여러분은 큰 역할을 하게 될 것입니다. 본 공군 병 특기 소개 책자는 특기별
직무내용, 배속 가능 부대, 교육기관, 복무 기준 및 절차, 특기교육 내용을 상세히 설명합니다.

### CoD Summary 5/5, 추가된 엔티티(entity): 부대관리훈령, 지원자, 건승

부대관리훈령에 따르면, '병은 국민의 한 사람으로서 신성한 국방의 의무를 수행하고 있다는 긍지와 자부심을 가지고, 복무에 충실하여야' 합니다.
공군의 첨단 항공우주력 확보 및 조국 영공방위 임무 완수를 위해 여러분은 큰 역할을 하게 될 것입니다. 본 공군 병 특기 소개 책자는 특기별
직무내용, 배속 가능 부대, 교육기관, 복무 기준 및 절차, 특기교육 내용을 상세히 설명하며, 모든 훈련병과 지원자의 건승을 기원합니다.


============== [최종 요약] =================

부대관리훈령에 따르면, '병은 국민의 한 사람으로서 신성한 국방의 의무를 수행하고 있다는 긍지와 자부심을 가지고, 복무에 충실하여야' 합니다. 공군의 첨단 항공우주력 확보 및 조국 영공방위 임무 완수를 위해 여러분은 큰 역할을 하게 될 것입니다. 본 공군 병 특기 소개 책자는 특기별 직무내용, 배속 가능 부대, 교육기관, 복무 기준 및 절차, 특기교육 내용을 상세히 설명하며, 모든 훈련병과 지원자의 건승을 기원합니다.
"""
print("\n============== [최종 요약] =================\n")
print(summary)
```