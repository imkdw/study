# 이전 대화 내용을 기억하는 에이전트 만들기
- `RunnableWithMessageHistory`를 활용해서 `AgentExecutor`를 감싸주면 만들수있음

```python
from langchain_community.chat_message_histories import ChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain.tools import tool
from typing import List, Dict, Annotated
from langchain_teddynote.tools import GoogleNews
from langchain_experimental.utilities import PythonREPL
from langchain_openai import ChatOpenAI
from langchain.agents import create_tool_calling_agent
from langchain.agents import AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
from langchain_teddynote.messages import AgentCallbacks, AgentStreamParser

store = {}


def get_session_history(session_ids):
    if session_ids not in store:
        store[session_ids] = ChatMessageHistory()
    return store[session_ids]


@tool
def search_news(query: str) -> List[Dict[str, str]]:
    """Search Google News by input keyword"""
    news_tool = GoogleNews()
    return news_tool.search_by_keyword(query, k=5)


@tool
def python_repl_tool(
    code: Annotated[str, "The python code to execute to generate your chart."],
):
    """Use this to execute python code. If you want to see the output of a value,
    you should print it out with `print(...)`. This is visible to the user."""
    result = ""
    try:
        result = PythonREPL().run(code)
    except BaseException as e:
        print(f"Failed to execute. Error: {repr(e)}")
    finally:
        return result


def tool_callback(tool) -> None:
    print("<<<<<<< 도구 호출 >>>>>>")
    print(f"Tool: {tool.get('tool')}")
    print("<<<<<<< 도구 호출 >>>>>>")


def observation_callback(observation) -> None:
    print("<<<<<<< 관찰 내용 >>>>>>")
    print(f"Observation: {observation.get('observation')[0]}")
    print("<<<<<<< 관찰 내용 >>>>>>")


def result_callback(result: str) -> None:
    print("<<<<<<< 최종 답변 >>>>>>")
    print(result)
    print("<<<<<<< 최종 답변 >>>>>>")


tools = [search_news, python_repl_tool]

prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "You are a helpful assistant. "
            "Make sure to use the `search_news` tool for searching keyword related news.",
        ),
        ("placeholder", "{chat_history}"),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ]
)

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)
agent = create_tool_calling_agent(llm, tools, prompt)

agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=False,
    handle_parsing_errors=True,
)

# 채팅 메시지 기록이 추가된 에이전트 생성
agent_with_chat_history = RunnableWithMessageHistory(
    agent_executor,
    get_session_history,
    # 프롬프트의 질문이 입력되는 키값
    input_messages_key="input",
    # 프롬프트의 메시지가 입력되는 키값
    history_messages_key="chat_history",
)

agent_callbacks = AgentCallbacks(
    tool_callback=tool_callback,
    observation_callback=observation_callback,
    result_callback=result_callback,
)

agent_stream_parser = AgentStreamParser(agent_callbacks)

session_id = "dongwoo"

response = agent_with_chat_history.stream(
    {"input": "안녕? 내 이름은 동우야!"},
    config={"configurable": {"session_id": session_id}},
)

# <<<<<<< 최종 답변 >>>>>>
# 안녕하세요, 동우님! 어떻게 도와드릴까요?
# <<<<<<< 최종 답변 >>>>>>
for step in response:
    agent_stream_parser.process_agent_steps(step)

response = agent_with_chat_history.stream(
    {"input": "내 이름이 뭐라고?"},
    config={"configurable": {"session_id": session_id}},
)

# <<<<<<< 최종 답변 >>>>>>
# 동우님이라고 하셨습니다! 맞나요?
# <<<<<<< 최종 답변 >>>>>>
for step in response:
    agent_stream_parser.process_agent_steps(step)

response = agent_with_chat_history.stream(
    {"input": "내 이메일 주소는 imkdw@kakao.com 이야. 회사 이름은 동우 주식회사야."},
    config={"configurable": {"session_id": session_id}},
)

# <<<<<<< 최종 답변 >>>>>>
# 알겠습니다, 동우님! 필요한 정보나 도움이 필요하시면 언제든지 말씀해 주세요.
# <<<<<<< 최종 답변 >>>>>>
for step in response:
    agent_stream_parser.process_agent_steps(step)

response = agent_with_chat_history.stream(
    {
        "input": "메이플스토리 관련 최신 뉴스 5개를 검색해서 이메일의 본문으로 작성해줘. "
        "수신인에는 `셜리 상무님` 그리고, 발신인에는 내 인적정보를 적어줘."
        "정중한 어조로 작성하고, 메일의 시작과 끝에는 적절한 인사말과 맺음말을 적어줘."
    },
    config={"configurable": {"session_id": session_id}},
)

# <<<<<<< 도구 호출 >>>>>>
# Tool: search_news
# <<<<<<< 도구 호출 >>>>>>

# <<<<<<< 관찰 내용 >>>>>>
# Observation: {'url': 'https://news.google.com/rss/articles/CBMiW0FVX3lxTE4zZnd1ejRXOGZGT3JacnZBbElaNHh6ZWRQemw3ZTJNZ1VZUUplQl9acG5faWhUYk5HcFh1STUzM29SMkllV1BvVl85WHE4bGJYQTU4THpHVnNLWjDSAWBBVV95cUxNd09JRmN4SGYwdndZVkdVUTRMTWd2U0U1QU51Y3lpWHMyd3V4c0xKaTFQbnJ3bUJjN1J0MHBWSzdtTHVyYmF3Q0FUY2dtYldqaVZaQnk4Y1Z0cnVFU0VoazE?oc=5', 'content': '메이플스토리 쇼케이스 유출했다 1억 물게 된 협력사 직원 - 연합뉴스'}
# <<<<<<< 관찰 내용 >>>>>>

# <<<<<<< 최종 답변 >>>>>>
# 아래는 메이플스토리 관련 최신 뉴스 5개를 정리한 이메일 본문입니다.

# ---

# **수신인:** 셜리 상무님
# **발신인:** 동우 (imkdw@kakao.com)

# 안녕하세요, 셜리 상무님.

# 최근 메이플스토리에 대한 흥미로운 뉴스가 많이 보도되고 있습니다. 아래는 그 중 일부를 정리한 내용입니다.

# 1. [메이플스토리 쇼케이스 유출했다 1억 물게 된 협력사 직원 - 연합뉴스](https://news.google.com/rss/articles/CBMiW0FVX3lxTE4zZnd1ejRXOGZGT3JacnZBbElaNHh6ZWRQemw3ZTJNZ1VZUUplQl9acG5faWhUYk5HcFh1STUzM29SMkllV1BvVl85WHE4bGJYQTU4THpHVnNLWjDSAWBBVV95cUxNd09JRmN4SGYwdndZVkdVUTRMTWd2U0U1QU51Y3lpWHMyd3V4c0xKaTFQbnJ3bUJjN1J0MHBWSzdtTHVyYmF3Q0FUY2dtYldqaVZaQnk4Y1Z0cnVFU0VoazE?oc=5)

# 2. [넥슨 ‘메이플스토리’, 대격변의 하반기 로드맵 발표 - 게임뷰](https://news.google.com/rss/articles/CBMiakFVX3lxTE1DcXlURmM1TDBMQXlyS0M1U29yRUhLVnI2c0JGZjZOYnNDX2Z1b05FLUhzVk12NksyZjJJMWlKWVpOdkV5bGtLNHNsY1loVmlDOGVTWG5NN0VuSXU0TUpHdGVheDdpOWUtVmc?oc=5)

# 3. [메이플스토리 “쇼케이스 내용 유출자 처벌 확정” - 게임톡](https://news.google.com/rss/articles/CBMibEFVX3lxTFBrNV9zNXoyWGRUQXhiQmN3NE16WFI4MFYxNHJsZXhsUWkzSzdBc284dnN0UFFZYjBXaXdaRkNSRUlQdEdiNU1VMDFfamU4V1NFVkpmTDFiNzFnTmlxd2JVSlVycHkwdFNsUEt0Sg?oc=5)

# 4. [넥슨, 2분기 매출 1조1천494억...메이플-던파 인기 반등 - 지디넷코리아](https://news.google.com/rss/articles/CBMiVkFVX3lxTE5yZWtwWWxLdkQzRnNzY0xwd2Z6Q0tOcWRHZEtCYXhjMVBpRVhIV1ZuajZjeUlheXZabFBjdlVLOXllMkFFb0xCd2VuYnpZOHRvRW1QdEhR?oc=5)

# 5. [메이플스토리 또 날았다…넥슨, 역대 최대 반기 실적 달성 - 한국경제](https://news.google.com/rss/articles/CBMiWkFVX3lxTE9tdWIyTVdWcGlvVVlGaEExbFFZN1hPVUtEdlZNbXFJVkNEMm9VWXI1U3NDb0JTT2w0VmFVRld2M1Zmdk5oMU16TjNvT2dmbHZFQUp0UTFVRWZ4QdIBVEFVX3lxTE9xa2FCSjgtUXhnQm5LTnlaRlI2X2Q2R1NIVU9XeElRbGJqaHBhT0hqdi1FOUhmYWRLRlNJQWItQlZHeU1lMlFGeXVFeDR5TUUxdFhPTQ?oc=5)

# 이 정보가 도움이 되길 바랍니다. 추가적인 질문이나 요청이 있으시면 언제든지 말씀해 주세요.

# 감사합니다.

# 동우 드림

# ---
for step in response:
    agent_stream_parser.process_agent_steps(step)
```