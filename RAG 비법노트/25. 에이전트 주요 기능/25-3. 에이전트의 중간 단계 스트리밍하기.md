# 에이전트의 중간 단계 스트리밍하기
- `AgentExecutor.stream()` 메소드를 통해서 중간 단계 스트리밍이 가능함
- 이 때 Action, Observation 2개의 단계가 번갈아가면서 나타남
- Action : 미리 추가해 둔 도구 중에서 어떤 도구를 사용할지 결정하는 과정이 출력됨
- Observation : 실행된 결과가 담김
- 최종적으로 에이전트가 목표를 달성했다면 답변이 출력됨

<br>

# 단계별로 나타내기
```python
from langchain.tools import tool
from typing import List, Dict, Annotated
from langchain_teddynote.tools import GoogleNews
from langchain_experimental.utilities import PythonREPL
from langchain_openai import ChatOpenAI
from langchain.agents import create_tool_calling_agent
from langchain.agents import AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
from langchain_teddynote.messages import AgentStreamParser


@tool
def search_news(query: str) -> List[Dict[str, str]]:
    """Search Google News by input keyword"""
    news_tool = GoogleNews()
    return news_tool.search_by_keyword(query, k=5)


@tool
def python_repl_tool(
    code: Annotated[str, "The python code to execute to generate your chart."],
):
    """Use this to execute python code. If you want to see the output of a value,
    you should print it out with `print(...)`. This is visible to the user."""
    result = ""
    try:
        result = PythonREPL().run(code)
    except BaseException as e:
        print(f"Failed to execute. Error: {repr(e)}")
    finally:
        return result


tools = [search_news, python_repl_tool]

prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "You are a helpful assistant. "
            "Make sure to use the `search_news` tool for searching keyword related news.",
        ),
        ("placeholder", "{chat_history}"),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ]
)

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)
agent = create_tool_calling_agent(llm, tools, prompt)

agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=False,
    handle_parsing_errors=True,
)

result = agent_executor.stream({"input": "AI 투자와 관련된 뉴스를 검색해 주세요."})

for step in result:
    print(step)
    print("===" * 20)
```

<br>

# 과정에서 나타나는 정보 정렬하기
```python
from langchain.tools import tool
from typing import List, Dict, Annotated
from langchain_teddynote.tools import GoogleNews
from langchain_experimental.utilities import PythonREPL
from langchain_openai import ChatOpenAI
from langchain.agents import create_tool_calling_agent
from langchain.agents import AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
from langchain_teddynote.messages import AgentStreamParser


@tool
def search_news(query: str) -> List[Dict[str, str]]:
    """Search Google News by input keyword"""
    news_tool = GoogleNews()
    return news_tool.search_by_keyword(query, k=5)


@tool
def python_repl_tool(
    code: Annotated[str, "The python code to execute to generate your chart."],
):
    """Use this to execute python code. If you want to see the output of a value,
    you should print it out with `print(...)`. This is visible to the user."""
    result = ""
    try:
        result = PythonREPL().run(code)
    except BaseException as e:
        print(f"Failed to execute. Error: {repr(e)}")
    finally:
        return result


# AgentCallbacks와 AgentStreamParser를 langchain_teddynote.messages에서 가져옵니다.
from langchain_teddynote.messages import AgentCallbacks, AgentStreamParser


def tool_callback(tool) -> None:
    print("<<<<<<< 도구 호출 >>>>>>")
    print(f"Tool: {tool.get('tool')}")
    print("<<<<<<< 도구 호출 >>>>>>")


def observation_callback(observation) -> None:
    print("<<<<<<< 관찰 내용 >>>>>>")
    print(f"Observation: {observation.get('observation')[0]}")
    print("<<<<<<< 관찰 내용 >>>>>>")


def result_callback(result: str) -> None:
    print("<<<<<<< 최종 답변 >>>>>>")
    print(result)
    print("<<<<<<< 최종 답변 >>>>>>")


agent_callbacks = AgentCallbacks(
    tool_callback=tool_callback,
    observation_callback=observation_callback,
    result_callback=result_callback,
)

agent_stream_parser = AgentStreamParser(agent_callbacks)

tools = [search_news, python_repl_tool]

prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "You are a helpful assistant. "
            "Make sure to use the `search_news` tool for searching keyword related news.",
        ),
        ("placeholder", "{chat_history}"),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ]
)

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)
agent = create_tool_calling_agent(llm, tools, prompt)

agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=False,
    handle_parsing_errors=True,
)

# 중간 단계 과정을 깔끔하게 출력하기 위한 콜백 함수
agent_stream_parser = AgentStreamParser()

result = agent_executor.stream({"input": "AI 투자관련 뉴스를 검색해 주세요."})

# [도구 호출]
# Tool: search_news
# query: AI 투자
# Log:
# Invoking: `search_news` with `{'query': 'AI 투자'}`

# [관찰 내용]
# Observation: [{'url': 'https://news.google.com/rss/articles/CBMiiwFBVV95cUxQYWRzV3R1VVhVRWVaUjhGVlhIVHNOd21KVmN5SVQxNWh6WE4ybXk2TlRHV1J3V2lyZlBSOWM3VlZpaEFxQ3RacHdMZUZXRU9LRXA2ek1QbXdkVDFNR0Y1bEdwNmVfSWdEZ1VWUG9YQnZkaFRFTVB1cjhNcTI3UHFWLThsdWRlQ0NnbWFr0gGfAUFVX3lxTFBZdEJYNTNCYlhMVUZXUlVzNDMyOTZST2hkb1ZlMjFEajN3VlFLUTZ0M3dqemhhNEEwLTFfQUxWeTBrNTVZNGxidGhENl9UUFN0VUtJNm04RnVmQnhwVTJFUUFlLTJnZ0g4TGVMZUJjSldzSnFWczQyWF9iZnN0QjA0RWlJQ1dkU1VwYkc3a0c0elVBWUtIbEVZdFJrb2dXTQ?oc=5', 'content': 'AI 점자 스타트업 대표, 횡령 후 해외 도주… 300억 증발 위기 - 조선일보'}, {'url': 'https://news.google.com/rss/articles/CBMiTkFVX3lxTE1WR2E1WmU3R29fVjdzQ3ZRZm5oc1pLUk40bkdWLUxMWTFVTjlLUFU2Y1FFcnRGX2tLX1RSOUFSMllUWlhNU0NoWVB6NHl5Zw?oc=5', 'content': '올트먼 “무모하다고 해도 투자한다”…오픈AI 기업가치 5000억 달러 - 매일경제'}, {'url': 'https://news.google.com/rss/articles/CBMiiAFBVV95cUxQMmphR19NcDZGeldlOTBXVXdkdnFVOWdYUkJsdFgtUWdrbTV6OUh3S2lkeWRiZERRUFZLRkJ6SVJHYnkySmRsZlRPRHhLbE04ck9BeUFxdWJGQUUzUUdLcVhDMXZPMXR0RFBCVzRCc3F4cnpWV1I1NWJqQnFxYnF6RTg5TEdtdUY0?oc=5', 'content': "中, 'AI 투자' 힘입어 '엘리트 품질 지수' 19위 도약… 싱가포르·미국 '맹추격' - 글로벌이코노믹"}, {'url': 'https://news.google.com/rss/articles/CBMiU0FVX3lxTE1xOXBIYWk1Qk1pM0FDS0pvYlItaDFwVHF5Z3VHcUNXRnhuZUhFcFVVbDZzMTFvRTJ5RDFab3RWMUN5RllPU1c5MkFnTWw2M0Fqbzln?oc=5', 'content': '대규모 AI 투자에도 성과는 아직…막판 성장통? - 네이트'}, {'url': 'https://news.google.com/rss/articles/CBMiWkFVX3lxTE9DWlRUZDE1SnM1a2x2c2VnUmdpM2ZXSVNzVmdVc2V3b3VZc09UM1lfZUhDRGRQT2sxREFqMWY5Zk5nSFRDYm1UNE9MOHhfcDE0RTVua1V1alp3d9IBVEFVX3lxTE5lbzZ3R2dianlwZUFQdFg0em9FZnkwMWR4MFhreGlPZXdpQ2plSk9QRVA1emlyR1I0a3NobURIdm9tMHdGb0pIdGo4d1k2SS15TWJmVw?oc=5', 'content': '불붙은 AI 투자경쟁…스타트업이 VC 골라 투자 받기도 - 한국경제'}]

# [최종 답변]
# 다음은 최근 AI 투자와 관련된 뉴스 기사들입니다:

# 1. [AI 점자 스타트업 대표, 횡령 후 해외 도주… 300억 증발 위기 - 조선일보](https://news.google.com/rss/articles/CBMiiwFBVV95cUxQYWRzV3R1VVhVRWVaUjhGVlhIVHNOd21KVmN5SVQxNWh6WE4ybXk2TlRHV1J3V2lyZlBSOWM3VlZpaEFxQ3RacHdMZUZXRU9LRXA2ek1QbXdkVDFNR0Y1bEdwNmVfSWdEZ1VWUG9YQnZkaFRFTVB1cjhNcTI3UHFWLThsdWRlQ0NnbWFr0gGfAUFVX3lxTFBZdEJYNTNCYlhMVUZXUlVzNDMyOTZST2hkb1ZlMjFEajN3VlFLUTZ0M3dqemhhNEEwLTFfQUxWeTBrNTVZNGxidGhENl9UUFN0VUtJNm04RnVmQnhwVTJFUUFlLTJnZ0g4TGVMZUJjSldzSnFWczQyWF9iZnN0QjA0RWlJQ1dkU1VwYkc3a0c0elVBWUtIbEVZdFJrb2dXTQ?oc=5)

# 2. [올트먼 “무모하다고 해도 투자한다”…오픈AI 기업가치 5000억 달러 - 매일경제](https://news.google.com/rss/articles/CBMiTkFVX3lxTE1WR2E1WmU3R29fVjdzQ3ZRZm5oc1pLUk40bkdWLUxMWTFVTjlLUFU2Y1FFcnRGX2tLX1RSOUFSMllUWlhNU0NoWVB6NHl5Zw?oc=5)

# 3. [中, 'AI 투자' 힘입어 '엘리트 품질 지수' 19위 도약… 싱가포르·미국 '맹추격' - 글로벌이코노믹](https://news.google.com/rss/articles/CBMiiAFBVV95cUxQMmphR19NcDZGeldlOTBXVXdkdnFVOWdYUkJsdFgtUWdrbTV6OUh3S2lkeWRiZERRUFZLRkJ6SVJHYnkySmRsZlRPRHhLbE04ck9BeUFxdWJGQUUzUUdLcVhDMXZPMXR0RFBCVzRCc3F4cnpWV1I1NWJqQnFxYnF6RTg5TEdtdUY0?oc=5)

# 4. [대규모 AI 투자에도 성과는 아직…막판 성장통? - 네이트](https://news.google.com/rss/articles/CBMiU0FVX3lxTE1xOXBIYWk1Qk1pM0FDS0pvYlItaDFwVHF5Z3VHcUNXRnhuZUhFcFVVbDZzMTFvRTJ5RDFab3RWMUN5RllPU1c5MkFnTWw2M0Fqbzln?oc=5)

# 5. [불붙은 AI 투자경쟁…스타트업이 VC 골라 투자 받기도 - 한국경제](https://news.google.com/rss/articles/CBMiWkFVX3lxTE9DWlRUZDE1SnM1a2x2c2VnUmdpM2ZXSVNzVmdVc2V3b3VZc09UM1lfZUhDRGRQT2sxREFqMWY5Zk5nSFRDYm1UNE9MOHhfcDE0RTVua1V1alp3d9IBVEFVX3lxTE5lbzZ3R2dianlwZUFQdFg0em9FZnkwMWR4MFhreGlPZXdpQ2plSk9QRVA1emlyR1I0a3NobURIdm9tMHdGb0pIdGo4d1k2SS15TWJmVw?oc=5)

# 이 기사들은 AI 투자와 관련된 다양한 주제를 다루고 있습니다. 관심 있는 기사를 클릭하여 자세한 내용을 확인해 보세요.
for step in result:
    agent_stream_parser.process_agent_steps(step)
```