# 앙상블 리트리버
- 여러 리트리버를 입력으로 받아 하나의 문서 검색 결과로 결합하는 랭체인의 기능
- 다양한 검색 알고리즘의 장점을 활용해서 단일 알고리즘보다 더 나은 성능 달성이 가능함
- RRF 알고리즘을 사용해서 여러 리트리버의 결과 순위를 조정할 수 있음
- 키워드 기반의 희소 리트리버와 의미 유사성 기반 밀집 리트리버를 결합하는 하이브리드 검색이 효과적임

<br>

# 예제
```python
from langchain.retrievers import BM25Retriever, EnsembleRetriever
from langchain.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings

doc_list = [
    "I like apples",
    "I like apple company",
    "I like apple's iphone",
    "Apple is my favorite company",
    "I like apple's ipad",
    "I like apple's macbook",
]


bm25_retriever = BM25Retriever.from_texts(
    doc_list,
)
bm25_retriever.k = 1  # 검색 결과는 1개만

embedding = OpenAIEmbeddings()

faiss_vectorstore = FAISS.from_texts(
    doc_list,
    embedding,
)
faiss_retriever = faiss_vectorstore.as_retriever(search_kwargs={"k": 1})

ensemble_retriever = EnsembleRetriever(
    retrievers=[bm25_retriever, faiss_retriever],
    # BM25 70%, FAISS 30%
    weights=[0.7, 0.3],
)

query = "my favorite fruit is apple"
ensemble_result = ensemble_retriever.invoke(query)
bm25_result = bm25_retriever.invoke(query)
faiss_result = faiss_retriever.invoke(query)

# [Ensemble Retriever]
# Content: Apple is my favorite company
print("[Ensemble Retriever]")
for doc in ensemble_result:
    print(f"Content: {doc.page_content}")
    print()

# [BM25 Retriever]
# Content: Apple is my favorite company
print("[BM25 Retriever]")
for doc in bm25_result:
    print(f"Content: {doc.page_content}")
    print()

# [FAISS Retriever]
# Content: I like apples
print("[FAISS Retriever]")
for doc in faiss_result:
    print(f"Content: {doc.page_content}")
    print()
```

<br>

# 런타임에 설정 변경
- 앙상블 리트리버를 생성하는 시점에 가중치같은 리트리버의 속성 변경이 가능함

```python
from langchain.retrievers import BM25Retriever, EnsembleRetriever
from langchain.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings
from langchain_core.runnables import ConfigurableField

doc_list = [
    "I like apples",
    "I like apple company",
    "I like apple's iphone",
    "Apple is my favorite company",
    "I like apple's ipad",
    "I like apple's macbook",
]


bm25_retriever = BM25Retriever.from_texts(
    doc_list,
)
bm25_retriever.k = 1  # 검색 결과는 1개만

embedding = OpenAIEmbeddings()

faiss_vectorstore = FAISS.from_texts(
    doc_list,
    embedding,
)
faiss_retriever = faiss_vectorstore.as_retriever(search_kwargs={"k": 1})

ensemble_retriever = EnsembleRetriever(
    retrievers=[bm25_retriever, faiss_retriever],
    # BM25 70%, FAISS 30%
    weights=[0.7, 0.3],
)

query = "my favorite fruit is apple"
ensemble_result = ensemble_retriever.invoke(query)
bm25_result = bm25_retriever.invoke(query)
faiss_result = faiss_retriever.invoke(query)


ensemble_retriever = EnsembleRetriever(
    retrievers=[bm25_retriever, faiss_retriever],
).configurable_fields(
    weights=ConfigurableField(
        id="ensemble_weights",
        name="Ensemble Weights",
        description="Ensemble Weights",
    )
)


config = {"configurable": {"ensemble_weights": [1, 0]}}

docs = ensemble_retriever.invoke("my favorite fruit is apple", config=config)

print("BM25 가중치 100%")
print(docs, end="\n\n")

config = {"configurable": {"ensemble_weights": [0, 1]}}

docs = ensemble_retriever.invoke("my favorite fruit is apple", config=config)

print("FAISS 가중치 100%")
print(docs, end="\n\n")

# BM25 가중치 100%
# [Document(metadata={}, page_content='Apple is my favorite company'), Document(id='82cca050-77ff-4d97-ad3a-4c0001ffcba7', metadata={}, page_content='I like apples')]

# FAISS 가중치 100%
# [Document(id='82cca050-77ff-4d97-ad3a-4c0001ffcba7', metadata={}, page_content='I like apples'), Document(metadata={}, page_content='Apple is my favorite company')]
```