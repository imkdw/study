# 부모 문서 리트리버
- 부모 문서를 찾아 반환하는 리트리버로, 부모 문서는 문서를 청크로 나누기 전의 원본 문서를 의미함
- 문서를 청크로 분할해 저장한 후 검색시 관련된 청크와 함께 해당 청크가 속한 원본 문서 전체의 정보와 맥락을 제공할 때 유용함

<br>

# 기본 예제
```python
TXT_PATH = "/Users/imkdw/study/RAG 비법노트/13. 리트리버/검은 마법사_보스 몬스터_공격 패턴 - 나무위키.txt"

from langchain.storage import InMemoryStore
from langchain_community.document_loaders import TextLoader
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain.retrievers import ParentDocumentRetriever

loaders = [
    TextLoader(TXT_PATH),
]

docs = []
for loader in loaders:
    docs.extend(loader.load())

child_splitter = RecursiveCharacterTextSplitter(chunk_size=200)

vectorstore = Chroma(
    collection_name="full_documents", embedding_function=OpenAIEmbeddings()
)

store = InMemoryStore()

retriever = ParentDocumentRetriever(
    vectorstore=vectorstore,
    docstore=store,
    child_splitter=child_splitter,
)

retriever.add_documents(docs, ids=None, add_to_docstore=True)

# ['cffcc760-9a75-4404-954c-9afb22ac8a8f']
print(list(store.yield_keys()))

retrieved_docs = retriever.invoke("공격 패턴")

# 문서의 길이: 25405
print(
    f"문서의 길이: {len(retrieved_docs[0].page_content)}",
    end="\n\n=====================\n\n",
)

# 의 빨간 원이 시계 방향으로 하나씩 사라지고, 그 다음은 안쪽에 5개의 빨간 원이 시계 반대 방향으로, 마지막은 원판의 중심의 빨간 원이 사라진다. 빨간 원이 모두 사라지면 즉사하고 격파 실패로 간주되어 입장 맵인 거인의 심장으로 추방된다.
# · 저주
# 이 지역에서 발생되는 공격은 창조나 파괴의 저주를 거는 것 같다. 만약 두 저주가 동시에 걸린다면 큰 피해를 입으니 조심하자. - 대적자
# 검은 마법사 보스전 공략의 핵심이 되는 패턴이다. 그러므로 격파를 위해서는 반드시 숙지해야 한다. 특정 공격을 받고 생존했다면 6초 동안 창조의 저주 또는 파괴의 저주에 걸린다. 창조의 저주는 흰 표식을, 파괴의 저주는 검은 표식을 남긴다.[7]
# o 창조의 저주


#                                                 1, 2, 3페이즈 화염                                                          4페이즈 화염
# 빛의 초월자의
print(retrieved_docs[0].page_content[2000:2500])
```

<br>

# 큰 문서 쪼개기
- 원본 문서를 큰 청크로 나누어 부모 문서를 생성하고 이를 다시 작은 청크로 분할해서 자식 문서를 생성함
- 작은 청크를 벡터 스토어에 색인화해서 검색의 효율성을 높이고 검색 시에는 부모 문서를 반환해서 더 큰 문맥을 제공함
```python
TXT_PATH = "/Users/imkdw/study/RAG 비법노트/13. 리트리버/검은 마법사_보스 몬스터_공격 패턴 - 나무위키.txt"

from langchain.storage import InMemoryStore
from langchain_community.document_loaders import TextLoader
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain.retrievers import ParentDocumentRetriever

loaders = [
    TextLoader(TXT_PATH),
]

docs = []
for loader in loaders:
    docs.extend(loader.load())


vectorstore = Chroma(
    collection_name="full_documents", embedding_function=OpenAIEmbeddings()
)

store = InMemoryStore()

# 부모 문서는 청크수를 1000으로 설정
parent_splitter = RecursiveCharacterTextSplitter(chunk_size=1000)

# 자식 문서는 200으로 설정
child_splitter = RecursiveCharacterTextSplitter(chunk_size=200)


vectorstore = Chroma(
    collection_name="split_parents", embedding_function=OpenAIEmbeddings()
)

store = InMemoryStore()

retriever = ParentDocumentRetriever(
    vectorstore=vectorstore,
    docstore=store,
    child_splitter=child_splitter,
    parent_splitter=parent_splitter,
)

retriever.add_documents(docs)

# 34, 전체를 저장했을땐 1개였지만 이젠 34개가 된 모습
print(len(list(store.yield_keys())))

retrieved_docs = retriever.invoke("익스트림 모드 차이점")

# 익스트림 모드 기준으로는 1페이즈의 체력 비중이 많이 높아지기에 여유컷이 아닌 이상 1페이즈를 한 번만에 넘길 순 없다. 따라서 하드 때와는 빌드가 달라지게 된다. 하지만 제한시간도 30분으로 줄었기 때문에 하드와 비슷하게 3번의 극딜 안에 넘어가야 하는 것은 똑같다.

# 아이온과 얄다바오트는 벨룸과는 달리 캐릭터 인식 범위가 짧고,[17] 심지어는 자신이 공격당하더라도 적이 인식 범위 밖에 있다면 추적하지 않고 제자리에 가만히 있는다. 또한 2개체에 모두 데미지를 주어 합 체력을 깎는 것이기 때문에 실질적인 체력은 절반인 31조 5000억/590조 정도라고 할 수 있다. 따라서 하드 모드를 기준으로 하드 데미안을 1분 안에 잡을 수 있다면 1페이즈를 스킵할 수 있다.

# · 통곡의 장벽

# 통곡의 장벽이 솟아올라 공간을 잠식한다.
# 보호막 시전 패턴. 40초 / 36초마다 맵의 좌우 끝에서부터 기둥이 올라오면서 맵의 크기를 줄여나간다. 장벽은 최대 10번 등장하며 혹여나 기둥이 생성될 때 솟아오르는 기둥에 맞으면 9,999% 데미지를 입으므로 너무 구석에 붙지 않게 주의할 것. 장벽이 등장하면 아이온과 얄다바오트는 처음 등장 위치로 내려찍기와 함께 텔레포트되고 보호막이 생긴다.

# 시간이 지날수록 맵이 점점 좁아지기 때문에 나중에는 아이온과 얄다바오트의 공격을 피할 수 없게 되어 사실상 게임 오버에 이르게 된다. 따라서 1페이즈는 되도록이면 바인드 한 번이나 두 번으로 끝내야 한다.
# · 붉은 번개

# 불길한 붉은 번개가 내리쳐 움직임을 제한한다.
# 맵에 600px[18] 간격으로 예고 이펙트가 6개 나타나고, 2.76초 후 붉은 번개가 떨어진다. 붉은 번개는 12.24초 간 지속된다. 피격 시 99% 데미지를 입는다. 다크 사이트로 회피할 수 있으며, 텔레포트로 넘어갈 수 있다.

# 해당 직업군이 아니라면 활동 가능한 범위가 화면의 38.7% 수준으로 줄어드는데 검은 사슬은 날아오지, 아이온과 얄다바오트가 주변에 있으면 생존 난이도가 급상승하게 된다.
print(retrieved_docs[0].page_content)
```