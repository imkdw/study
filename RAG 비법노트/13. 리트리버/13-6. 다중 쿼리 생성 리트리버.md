# 다중 쿼리 생성 리트리버
- LLM을 시용해서 사용자가 입력한 질문을 다양한 관점에 따라 여러 질문으로 변환하는 리트리버
- 여러 질문으로 검색을 수행한 문서들에서 공통된 부분을 추출함으로써 더욱 관련성 높은 검색 결과를 얻는 방식
- 유저의 불친절한 질문을 더욱 정확한 쿼리로 다듬어 주는 후처리 역할을함
- 단순히 입력한 날것보다는 LLM이 만든 쿼리를 가지고 질문하면 성능이 더 좋음

<br>

# 기본 방식
```python
TXT_PATH = "/Users/imkdw/study/RAG 비법노트/13. 리트리버/검은 마법사_보스 몬스터_공격 패턴 - 나무위키.txt"

from langchain_community.document_loaders import WebBaseLoader
from langchain.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain.retrievers.multi_query import MultiQueryRetriever
from langchain_openai import ChatOpenAI

loader = WebBaseLoader(
    r"https://namu.wiki/w/%EA%B2%80%EC%9D%80%20%EB%A7%88%EB%B2%95%EC%82%AC/%EB%B3%B4%EC%8A%A4%20%EB%AA%AC%EC%8A%A4%ED%84%B0/%EA%B3%B5%EA%B2%A9%20%ED%8C%A8%ED%84%B4",
    encoding="utf-8",
)

text_splitter = RecursiveCharacterTextSplitter(chunk_size=500, chunk_overlap=0)
docs = loader.load_and_split(text_splitter)

openai_embedding = OpenAIEmbeddings()

db = FAISS.from_documents(docs, openai_embedding)

retriever = db.as_retriever()

# 문서 검색
query = "검은마법사 1페이즈 패턴을 알려줘"
relevant_docs = retriever.invoke(query)

# 4
print(len(relevant_docs))

# 기사가 쓰러져 검은 마법사에게로 가는 길이 열린다.격파 후 각 기사들은 동시에 몸이 녹아내리면서 사라진다. 검은 마법사의 피조물로 보이는데 별 설명이 없어서 정체는 불명.                                        2.3. 페이즈 2[편집]                                        전투 맵은 1페이즈의 어둠의 신전에서 검은 마법사가 앉아 있었던 어둠의 옥좌 부분. 1페이즈에 비해 좁아졌다. 2페이즈의 검은 마법사는 3%의 충돌 데미지가 있다.암흑적에게 6초 동안 암흑 상태이상을 건다. 루미너스는 예외로 패시브를 통해 무효화가 가능하다.재사용 대기시간 35초시야 차단이 생각보다 긴 편이며 그 동안에도 다른 패턴들은 계속 발동하기 때문에 비숍이 빠른 속도로 디스펠을 사용해서 해제해줘야 한다.붉은 번개(아포칼립스)검은 마법사의 붉은 번개가 모든 곳을 뒤덮는다. 피할 곳을 찾아야 한다.보호막 시전 패턴. 72초마다[22] 경고 문구가
print(relevant_docs[1].page_content)


llm = ChatOpenAI(temperature=0, model="gpt-4o-mini")

multiquery_retriever = MultiQueryRetriever.from_llm(
    retriever=db.as_retriever(),
    llm=llm,
)

question = "검은마법사 1페이즈 패턴을 알려줘"
relevant_docs = multiquery_retriever.invoke(question)

# ===============
# 검색된 문서 개수: 6
# ===============
print(
    f"===============\n검색된 문서 개수: {len(relevant_docs)}",
    end="\n===============\n",
)

# 22.4. 페이즈 32.5. 페이즈 4                                        1. 개요[편집]                                        메이플스토리의 보스 몬스터 검은 마법사의 공격 패턴을 정리한 문서. 메이플 월드의 최종 보스인 만큼 패턴도 보스 중에서도 압도적으로 많다.패턴의 피해 수치, 쿨타임 및 시전 개수는 각각 "하드 / 익스트림"이며 따로 구분이 되어 있지 않으면 난이도 공통이다.                                        2. 공격 패턴[편집]                                        출시 전까지의 보스가 가진 패턴들을 모조리 들고 나왔다. 전체 즉사기[1]와 각종 장애물은 물론, 스우의 낙하물[2], 매그너스의 존 컨트롤 시스템, 루시드의 탄막형 잡몹 소환과 탄막, 윌의 거미줄[3] 등 다양한 패턴들이 등장한다. 또한 데미안의 낙인 시스템[4]과 진
print(relevant_docs[1].page_content)
```

<br>

# LCEL 체인에서 활용하기
```python
from langchain_community.document_loaders import WebBaseLoader
from langchain.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain.retrievers.multi_query import MultiQueryRetriever
from langchain_openai import ChatOpenAI
from langchain_core.runnables import RunnablePassthrough
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import StrOutputParser

loader = WebBaseLoader(
    r"https://namu.wiki/w/%EA%B2%80%EC%9D%80%20%EB%A7%88%EB%B2%95%EC%82%AC/%EB%B3%B4%EC%8A%A4%20%EB%AA%AC%EC%8A%A4%ED%84%B0/%EA%B3%B5%EA%B2%A9%20%ED%8C%A8%ED%84%B4",
    encoding="utf-8",
)

text_splitter = RecursiveCharacterTextSplitter(chunk_size=500, chunk_overlap=0)
docs = loader.load_and_split(text_splitter)

openai_embedding = OpenAIEmbeddings()

db = FAISS.from_documents(docs, openai_embedding)

retriever = db.as_retriever()

# 문서 검색
query = "검은마법사 1페이즈 패턴을 알려줘"
relevant_docs = retriever.invoke(query)

prompt = PromptTemplate.from_template(
    """You are an AI language model assistant. 
Your task is to generate five different versions of the given user question to retrieve relevant documents from a vector database. 
By generating multiple perspectives on the user question, your goal is to help the user overcome some of the limitations of the distance-based similarity search. 
Your response should be a list of values separated by new lines, eg: `foo\nbar\nbaz\n`

#ORIGINAL QUESTION: 
{question}

#Answer in Korean:
"""
)

llm = ChatOpenAI(temperature=0, model="gpt-4o-mini")

custom_multiquery_chain = (
    {"question": RunnablePassthrough()} | prompt | llm | StrOutputParser()
)

question = "검은마법사 1페이즈 패턴을 알려줘"

multi_queries = custom_multiquery_chain.invoke(question)

# 검은마법사 1페이즈의 전투 패턴에 대해 설명해 줄 수 있나요?
# 검은마법사 1페이즈에서 주의해야 할 공격 방식은 무엇인가요?
# 검은마법사 1페이즈의 주요 기술과 그에 대한 대처법은?
# 검은마법사 1페이즈의 패턴을 자세히 알고 싶어요.
# 검은마법사 1페이즈에서 발생하는 이벤트와 그에 따른 전략은?
print(multi_queries)

multiquery_retriever = MultiQueryRetriever.from_llm(
    llm=custom_multiquery_chain, retriever=db.as_retriever()
)

relevant_docs = multiquery_retriever.invoke(question)

# ===============
# 검색된 문서 개수: 5
# ===============
print(
    f"===============\n검색된 문서 개수: {len(relevant_docs)}",
    end="\n===============\n",
)

# 기사가 쓰러져 검은 마법사에게로 가는 길이 열린다.격파 후 각 기사들은 동시에 몸이 녹아내리면서 사라진다. 검은 마법사의 피조물로 보이는데 별 설명이 없어서 정체는 불명.                                        2.3. 페이즈 2[편집]                                        전투 맵은 1페이즈의 어둠의 신전에서 검은 마법사가 앉아 있었던 어둠의 옥좌 부분. 1페이즈에 비해 좁아졌다. 2페이즈의 검은 마법사는 3%의 충돌 데미지가 있다.암흑적에게 6초 동안 암흑 상태이상을 건다. 루미너스는 예외로 패시브를 통해 무효화가 가능하다.재사용 대기시간 35초시야 차단이 생각보다 긴 편이며 그 동안에도 다른 패턴들은 계속 발동하기 때문에 비숍이 빠른 속도로 디스펠을 사용해서 해제해줘야 한다.붉은 번개(아포칼립스)검은 마법사의 붉은 번개가 모든 곳을 뒤덮는다. 피할 곳을 찾아야 한다.보호막 시전 패턴. 72초마다[22] 경고 문구가
# ===============
# 검은 마법사/보스 몬스터/공격 패턴 - 나무위키
# ===============
# 패턴으로, 보통은 무적기를 이 때 쓰기에 무적 권능이라고 불리기도 한다. 만약 무적을 쓸 수 없는 상황이라면 양 쪽 구석에 있는 넓은 발판을 찾아서 아래쪽에 움직이면서 피해야 한다. 다크 사이트로 회피할 수 있으며 낮은 확률로 낙하물 사이에 간격이 조금 벌어진 경우 그 사이로 윗점을 써서 피하기도 한다.창조의 권능 사용 직후에는 흡수 패턴을 사용하지 않으나 밀격을 사용하기도 한다.파괴의 권능파괴의 권능 사용권능 사용 시 등장하는 장판검은 마법사가 바닥을 붕괴시킨다. 바닥에 닿으면 9,999%의 데미지를 입는다. 장판은 5초 동안 지속된다.이 경우에는 창조의 권능과 반대로 발판 위가 안전지대이다. 단, 검은 마법사가 근처에 있을 시 그대로 밀쳐내기를 맞고 바닥으로 떨어질 수 있으니 조심하자. 단타가 아니라 연속 데미지로 들어오기 때문에 발판이 주변에 없을 때에는 블링크 체공을 활용하는 것도 좋다.패턴의 판정이 후한 편이라 패턴 발동 후 보호막이 생성되는 시점에 이펙트가 지속되고 있을
# ===============
# 3페이즈의 여러 패턴과 연계하여 데카를 깎아먹는 악랄한 패턴이며 후술할 파괴의 레이저와 가장 많이 연계되어 저주 중첩으로 데카를 날려먹는 일이 많다. 이펙트가 화려한 스킬을 사용하면 검은 마법사가 잘 안 보일 수 있으니 주의해야 한다. 타격 시 실루엣 표시를 키거나 일반 효과음으로 패턴 사용 여부를 알 수 있다.사거리가 상당히 길어서 검은 마법사를 너무 오른쪽으로 밀면 파티원들이 패턴을 피할 공간이 없어 생존하기 힘든 상황이 자주 연출된다. 다만 가장 오른쪽 발판보다 오른쪽으로 들어오지만 않는다면 포지션을 잡아줄 일명 '주차' 격수나 슬로우 격수가 없어도 상관없다. 처음 검은 마법사에 도전하는 경우 밀격의 범위를 잘 모르거나, 사선을 피하다 검은 마법사가 오른쪽으로 들어와 이 패턴에 의해 죽는 경우가 많다.링크에서 검은 마법사의 밀격 사거리가 어느 정도인지 볼 수 있다.발판 생성 / 파괴정해진 위치에 예고 이펙트 1.38초 후 폭발과 함께 발판이 생성된다. 피격 시 25% 데미지를
# ===============
# 22.4. 페이즈 32.5. 페이즈 4                                        1. 개요[편집]                                        메이플스토리의 보스 몬스터 검은 마법사의 공격 패턴을 정리한 문서. 메이플 월드의 최종 보스인 만큼 패턴도 보스 중에서도 압도적으로 많다.패턴의 피해 수치, 쿨타임 및 시전 개수는 각각 "하드 / 익스트림"이며 따로 구분이 되어 있지 않으면 난이도 공통이다.                                        2. 공격 패턴[편집]                                        출시 전까지의 보스가 가진 패턴들을 모조리 들고 나왔다. 전체 즉사기[1]와 각종 장애물은 물론, 스우의 낙하물[2], 매그너스의 존 컨트롤 시스템, 루시드의 탄막형 잡몹 소환과 탄막, 윌의 거미줄[3] 등 다양한 패턴들이 등장한다. 또한 데미안의 낙인 시스템[4]과 진
# ===============
for relevant_doc in relevant_docs:
    print(relevant_doc.page_content, end="\n===============\n")
```