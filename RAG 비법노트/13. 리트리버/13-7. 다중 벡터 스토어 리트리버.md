# 다중 벡터 스토어 리트리버
- 하나의 문서에서 여러 개의 벡터 표현을 생성해서 문서의 다양한 부분을 별도로 검색할 수 있도록 지원하는 리트리버
- 문서를 청크로 분할하거나 요약 임베딩을 생성하거나 특정 질문에 대한 답을 포함하는 벡터를 생성하는 등 여러 방식으로 문서를 표현함

<br>

### 동작
- 작은 청크 생성
  - 문서를 더 작은 단위로 분할, 각 청크에 대해 별도의 임베딩을 생성
  - 문서의 특정 부분에 대해서 세밀하게 검색하거나 분석할 때 유용함
- 요약 임베딩 사용
  - 문서의 핵심 내용을 요약한 후 이 요약본에 대해 임베딩을 생성
  - 문서 전체를 분석하지 않고도 중요한 내용을 빠르게 파악할 수 있어서 효율성을 높임
- 가설 쿼리 활용
  - 각 문서에 대한 적합한 가설 질문을 만들고 이를 기반으로 임베딩을 생성
  - 특정 주제에 대해 깊이 있는 탐색을 원할 때 적합함

<br>

# 청크와 원본 문서 검색하기
```python
PDF_PATH = "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"

from langchain_community.document_loaders import PyMuPDFLoader
import uuid
from langchain.storage import InMemoryStore
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain.retrievers.multi_vector import MultiVectorRetriever

loader = PyMuPDFLoader(PDF_PATH)
docs = loader.load()

vectorstore = Chroma(
    collection_name="small_bigger_chunks",
    embedding_function=OpenAIEmbeddings(model="text-embedding-3-small"),
)

store = InMemoryStore()

id_key = "doc_id"

retriever = MultiVectorRetriever(
    vectorstore=vectorstore,
    byte_store=store,
    id_key=id_key,
)

doc_ids = [str(uuid.uuid4()) for _ in docs]

# 부모 청크는 600
parent_text_splitter = RecursiveCharacterTextSplitter(chunk_size=600)

# 자식 청크는 200
child_text_splitter = RecursiveCharacterTextSplitter(chunk_size=200)

#
parent_docs = []
for i, doc in enumerate(docs):
    _id = doc_ids[i]
    parent_doc = parent_text_splitter.split_documents([doc])

    for _doc in parent_doc:
        _doc.metadata[id_key] = _id
    parent_docs.extend(parent_doc)

# 144
print(len(parent_docs))


child_docs = []
for i, doc in enumerate(docs):
    _id = doc_ids[i]
    child_doc = child_text_splitter.split_documents([doc])
    for _doc in child_doc:
        _doc.metadata[id_key] = _id
    child_docs.extend(child_doc)

# 1157
print(len(child_docs))

# 벡터 저장소에 부모, 자식 문서 추가
retriever.vectorstore.add_documents(parent_docs)
retriever.vectorstore.add_documents(child_docs)

# docstore 에 원본 문서를 저장
retriever.docstore.mset(list(zip(doc_ids, docs)))

question = "30010 특기의 이름은?"

# 유사도 검색
relevant_chunks = retriever.vectorstore.similarity_search(question)

# 검색된 문서의 개수: 4
print(f"검색된 문서의 개수: {len(relevant_chunks)}")

"""
41310
46110
⇓ 특기부호 구성
1 2 3 4 5
 
      예시) 헌병 병과
신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
8114(원·상·중사) → 8113(하사)
병
81110
* 병 특기부호의 경우, 5번째 자리에 특기세목 표기

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

항공기기체정비
항공기재보급
특 기 부 호
특기를 숫자로 나타낸 것
41310
46110
⇓ 특기부호 구성
1 2 3 4 5
 
      예시) 헌병 병과
신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
8114(원·상·중사) → 8113(하사)
병
81110

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
8114(원·상·중사) → 8113(하사)
병
81110
* 병 특기부호의 경우, 5번째 자리에 특기세목 표기
⇓ 신분별 특기 개요('16년도 기준, 특기신설·분리·통합 등 인사 정책에 따른 변동 가능)
신    분

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

군수
특기(명칭)
병과를 기능별로 분류한 것
항공기기체정비
항공기재보급
특 기 부 호
특기를 숫자로 나타낸 것
41310
46110
⇓ 특기부호 구성
1 2 3 4 5
 
      예시) 헌병 병과
신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
"""
for chunk in relevant_chunks:
    print(chunk.page_content, end="\n\n")
    print(">" * 100, end="\n\n")

# 원본 문서를 보기위한 invoke() 결과
relevant_docs = retriever.invoke(question)

"""
검색된 문서의 개수: 1

====================================================================================================

08
공군 특기 개요
⇓ 용어정의
용        어
설 명
예 시
병        과
군무를 기능별로 분류한 것
군수
특기(명칭)
병과를 기능별로 분류한 것
항공기기체정비
항공기재보급
특 기 부 호
특기를 숫자로 나타낸 것
41310
46110
⇓ 특기부호 구성
1 2 3 4 5
 
      예시) 헌병 병과
신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
8114(원·상·중사) → 8113(하사)
병
81110
* 병 특기부호의 경우, 5번째 자리에 특기세목 표기
⇓ 신분별 특기 개요('16년도 기준, 특기신설·분리·통합 등 인사 정책에 따른 변동 가능)
신    분
개    요
모집·선발시 지원 직종
장    교
18개 특기
-
부사관
· 17개 특기군
  : 항공통제, 방공포병, 구조, 안전, 무기정비, 보급수송,
    시설, 재정, 총무, 군악, 정보, 정훈, 법무, 의무 등
· 53개 특기
  : 항공통제, 단·중거리유도무기운용, 항공구조, 항공안전,
    정밀측정장비정비, 일반보급, 항공시설, 회계, 총무, 
    군악, 항공정보운영, 정훈, 법무서기, 항공의무 등
10개 직종
병
· 13개 특기군
  : 항공통제, 방공포병, 기상, 정보통신, 무기정비, 
    보급수송, 시설, 재정, 총무, 군악, 헌병, 정보, 의무 등
· 51개 특기
  : 항공통제, 단거리유도무기운용, 항공기상관측, 
    정보체계관리, 항공기기체정비, 항공기재보급, 토건, 
    회계, 총무, 군악, 헌병, 항공정보운영, 항공의무 등
11개 직종
군사특기군
숙련도
접미어
"""
print(f"검색된 문서의 개수: {len(relevant_docs)}", end="\n\n")
print("=" * 100, end="\n\n")
print(relevant_docs[0].page_content)
```

<br>

### 검색 유형을 MMR로 설정
```python
from langchain.retrievers.multi_vector import SearchType

retriever.search_type = SearchType.mmr

# 관련 문서 전체를 검색
question = "30010 특기의 이름은?"
print(retriever.invoke(question)[0].page_content)
```

<br>

### 검색 유형을 similarity_score_threshold로 설정
```python
from langchain.retrievers.multi_vector import SearchType

retriever.search_type = SearchType.similarity_score_threshold
retriever.search_kwargs = {"score_threshold": 0.3} # 유사도 점수가 0.3 이상인 문서만 검색

# 관련 문서 전체를 검색
print(retriever.invoke("30010 특기의 이름은?")[0].page_content)
```

<br>

### 검색 유형을 similarity로 설정
```python
from langchain.retrievers.multi_vector import SearchType

retriever.search_type = SearchType.similarity
retriever.search_kwargs = {"k": 1}

print(len(retriever.invoke("30010 특기의 이름은?")))
```

<br>

# 요약본을 벡터 DB에 저장하기
- 요약을 하면 종종 청크의 내용을 더 정확하게 추출이 가능해서 더 나은 검색 결과를 얻을 수 있음
- 요약본을 만들고 요약본을 아우르는 원본 문서와 같이 임베딩해서 벡터스토어에 저장하게됨

<br>

### LLM을 통해서 요약하기
```python
PDF_PATH = "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"

from langchain_community.document_loaders import PyMuPDFLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_core.documents import Document
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI

loader = PyMuPDFLoader(PDF_PATH)

# 재귀 텍스트 분할을 통해서 청크 사이즈를 600자로 나누고, 최대 50개의 문자만 중복되게 설정함
text_splitter = RecursiveCharacterTextSplitter(chunk_size=600, chunk_overlap=50)

split_docs = loader.load_and_split(text_splitter)

# 분할된 문서의 개수: 141
print(f"분할된 문서의 개수: {len(split_docs)}")


summary_chain = (
    {"doc": lambda x: x.page_content}
    | ChatPromptTemplate.from_messages(
        [
            ("system", "You are an expert in summarizing documents in Korean."),
            (
                "user",
                "Summarize the following documents in 3 sentences in bullet points format.\n\n{doc}",
            ),
        ]
    )
    | ChatOpenAI(temperature=0, model="gpt-4o-mini")
    | StrOutputParser()
)

# 배치 처리를 통해서 문서를 요약함. 동시에 10개까지 가능
summaries = summary_chain.batch(split_docs, {"max_concurrency": 10})

# 141
print(len(summaries))

# 30
# 기계직종항공기초과저지55710
# 특기개요
# 비행단 시설대대 항공기초과저지장비(망) 점검, 유지보수, 운영 보조 업무 수행
# 반영 자격증
# 기계정비, 메카트로닉스, 정밀측정
# 반영 전공
# 금속, 금속재료, 금형설계, 기계, 기계설계, 기계전자, 기계제도, 동력기계,
# 메카트로닉스, 생산기계가공, 세라믹, 원자력(기계), 재료, 정밀기계, 제어기계,
# 조선선박, 항공공학, 항공기계, 항공우주, 항공정비
# 항공기초과저지장비
# 초과저지장비 정비
# 초과저지장비 운영
# 초과저지장비 운영
print(split_docs[33].page_content, end="\n\n")

# - 비행단 시설대대에서 항공기 초과저지장비의 점검, 유지보수 및 운영 보조 업무를 수행한다.
# - 관련 자격증으로는 기계정비, 메카트로닉스, 정밀측정이 있으며, 다양한 기계 및 항공 관련 전공이 반영된다.
# - 초과저지장비의 정비와 운영에 대한 전문성을 요구하며, 항공기계 및 항공정비 분야의 지식이 필요하다.
print(summaries[33])
```

<br>

### 요약한 정보 벡터스토어에 저장하기
```python
PDF_PATH = "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"

import uuid
from langchain_community.document_loaders import PyMuPDFLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_core.documents import Document
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from langchain.storage import InMemoryStore
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain.retrievers.multi_vector import MultiVectorRetriever

loader = PyMuPDFLoader(PDF_PATH)

# 재귀 텍스트 분할을 통해서 청크 사이즈를 600자로 나누고, 최대 50개의 문자만 중복되게 설정함
text_splitter = RecursiveCharacterTextSplitter(chunk_size=600, chunk_overlap=50)

split_docs = loader.load_and_split(text_splitter)

summary_chain = (
    {"doc": lambda x: x.page_content}
    | ChatPromptTemplate.from_messages(
        [
            ("system", "You are an expert in summarizing documents in Korean."),
            (
                "user",
                "Summarize the following documents in 3 sentences in bullet points format.\n\n{doc}",
            ),
        ]
    )
    | ChatOpenAI(temperature=0, model="gpt-4o-mini")
    | StrOutputParser()
)

# 배치 처리를 통해서 문서를 요약함. 동시에 10개까지 가능
summaries = summary_chain.batch(split_docs, {"max_concurrency": 10})


summary_vectorstore = Chroma(
    collection_name="summaries",
    embedding_function=OpenAIEmbeddings(model="text-embedding-3-small"),
)

store = InMemoryStore()

id_key = "doc_id"

retriever = MultiVectorRetriever(
    vectorstore=summary_vectorstore,
    byte_store=store,
    id_key=id_key,
)

doc_ids = [str(uuid.uuid4()) for _ in split_docs]

summary_docs = [
    Document(page_content=s, metadata={id_key: doc_ids[i]})
    for i, s in enumerate(summaries)
]

# 요약된 정보를 벡터스토어에 저장
retriever.vectorstore.add_documents(summary_docs)

# 문서 ID, 문서를 매핑해서 문서 저장소에 저장
retriever.docstore.mset(list(zip(doc_ids, split_docs)))

# 유사도 검색 수행
result_docs = summary_vectorstore.similarity_search("정보체계관리 특기의 주요 업무는?")

# - 보안체계관리병은 비행단급 및 독립전대급 부대에서 암호전문처리와 암호장비 정비 관리 보조 업무를 수행한다.
# - 관련 자격증으로는 사무자동화, 전자계산기, 정보보호, 전기기사 등이 있으며, 다양한 전공 분야가 반영된다.
# - 주요 전공 분야에는 구조시스템, 암호, 정보기술, 컴퓨터 프로그래밍 등이 포함된다.
print(result_docs[0].page_content)

# 질문과 관련된 문서 검색
retrieved_docs = retriever.invoke("정보체계관리 특기의 주요 업무는?")

# 특기명칭부호
# 70
# 기계직종
# 특기명칭부호
# 시설직종
# 특기명칭부호
# 차량정비직종
# 차량운전직종
# 특기명칭부호
# 전자계산직종
# 특기개요
# 보안체계관리병으로서 비행단급/독립전대급 부대에서 암호전문처리 및
# 암호장비 정비관리 보조 업무 수행
# 반영 자격증
# 사무자동화, 전자계산기, 전자계산기조직운용, 전자기기, 정보기기운용,
# 정보보호, 정보처리, 정보통신, 정보보안, 전기기사, 전기공사
# 반영 전공
# 구조시스템, 멀티, 암호, 응용전자, 전자, 전자계산, 전자전산, 정보, 정보기술,
# 정보보호, 컴퓨터, 컴퓨터그래픽, 프로그래밍, IT
# 보안체계관리30110
# 암호장비정비
print(retrieved_docs[0].page_content)
```

<br>

# 가설 쿼리로 문서 내용 탐색하기
- 가설쿼리란 유저의 질문으로 어떤 질문이 들어올지 예상해서 미리 임베딩해서 저장해 둔 것을 의미함
- 유저의 질문이 들어오면 미리 가상으로 만들어 둔 쿼리 간의 임베딩 유사도를 계산해서 매칭될 확률을 높임

<br>

### 가설 쿼리 벡터스토어에 저장하기
```python
import uuid
from langchain_core.prompts import ChatPromptTemplate
from langchain.output_parsers.openai_functions import JsonKeyOutputFunctionsParser
from langchain_openai import ChatOpenAI
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_community.document_loaders import PyMuPDFLoader
from langchain.storage import InMemoryStore
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain.retrievers.multi_vector import MultiVectorRetriever
from langchain_core.documents import Document

PDF_PATH = "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"

text_splitter = RecursiveCharacterTextSplitter(chunk_size=600, chunk_overlap=50)

loader = PyMuPDFLoader(PDF_PATH)

split_docs = loader.load_and_split(text_splitter)

functions = [
    {
        # 함수의 이름 지정
        "name": "hypothetical_questions",
        # 함수에 대한 설명
        "description": "Generate hypothetical questions",
        # 함수 파라미터 정의
        "parameters": {
            # 파라미터 타입 정의
            "type": "object",
            # 객체 속성 정의
            "properties": {
                # 질문 정의
                "questions": {
                    # 질문 타입 정의
                    "type": "array",
                    # 배열 내부의 요소 정의
                    "items": {
                        # 배열은 string[] 타입으로 정의
                        "type": "string"
                    },
                },
            },
            # 필수 파라미터로 questions를 지정
            "required": ["questions"],
        },
    }
]


hypothetical_query_chain = (
    {"doc": lambda x: x.page_content}
    # 답변할 수 있는 가상의 질문을 정확히 3개 생성하도록 요청
    | ChatPromptTemplate.from_template(
        "Generate a list of exactly 3 hypothetical questions that the below document could be used to answer. "
        "Potential users are those interested in the AI industry. Create questions that they would be interested in. "
        "Output should be written in Korean:\n\n{doc}"
    )
    | ChatOpenAI(max_retries=0, model="gpt-4o-mini").bind(
        functions=functions, function_call={"name": "hypothetical_questions"}
    )
    # 출력에서 questions 키에 해당하는 값을 추출
    | JsonKeyOutputFunctionsParser(key_name="questions")
)

# 문서 목록에 대해 가설 질문을 배치로 생성
hypothetical_questions = hypothetical_query_chain.batch(
    split_docs, {"max_concurrency": 10}
)

# 141
print(len(hypothetical_questions))

# [
#     "이 문서에서 언급된 항공기 기계정비 기술이 AI 산업에 어떻게 적용될 수 있을까요?",
#     "기계직종 항공기초과저지장비의 유지보수 기술이 AI 기반 기술의 발전에 어떤 영향을 줄까요?",
#     "AI 기술이 항공기 기계 정비 분야의 효율성을 어떻게 높일 수 있을까요?",
# ]
print(hypothetical_questions[33])

hypothetical_vectorstore = Chroma(
    collection_name="hypo-questions", embedding_function=OpenAIEmbeddings()
)
store = InMemoryStore()

id_key = "doc_id"

retriever = MultiVectorRetriever(
    vectorstore=hypothetical_vectorstore,
    byte_store=store,
    id_key=id_key,
)
doc_ids = [str(uuid.uuid4()) for _ in split_docs]

question_docs = []

for i, question_list in enumerate(hypothetical_questions):
    question_docs.extend(
        [Document(page_content=s, metadata={id_key: doc_ids[i]}) for s in question_list]
    )

retriever.vectorstore.add_documents(question_docs)

retriever.docstore.mset(list(zip(doc_ids, split_docs)))

result_docs = hypothetical_vectorstore.similarity_search(
    "정보체계관리 특기가 수행하는 주요 임무는?"
)

# AI 산업에서 전문화관리를 담당하는 직무에 필요한 특기는 무엇인가요?
# {'doc_id': 'e794b4a6-8c5d-4471-9b92-4b57fae322d4'}
# 특수정보 수집 관련 업무에서 필요한 기본 지식에는 어떤 것들이 있을까요?
# {'doc_id': '17476a8d-f309-4537-8c00-17feb9f995bb'}
# AI 기술이 정보 처리 및 보안 분야에서 수행할 수 있는 역할은 무엇인가?
# {'doc_id': 'fb1b4c19-d509-4406-8c7d-a08ff7389582'}
# 기계 학습 기술을 사용하여 공군 장비 정보 시스템의 운영 성능을 향상시킬 수 있는 방법은 무엇인가요?
# {'doc_id': 'f0d42418-77bc-4f6e-aefd-f02e6abd9345'}
for doc in result_docs:
    print(doc.page_content)
    print(doc.metadata)


retrieved_docs = retriever.invoke(result_docs[1].page_content)

# 119
# 특기교육
# •
# •
# •
# •
# •
# •
# 교육기관(기간) : 특기교육 없음(실무부대 직접배속)
# 특수정보 수집 장비의 운용
# 특수정보 정밀 수집방법에 의한 첩보자료 분석 수행
# 특수정보 수집 일지의 작성
# 특수정보 수집 장비의 점검
# 예비적 분석 자료의 작성 및 분석
# 직무내용
# •
# •
# 특수정보 수집장비의 운용방법 숙지
# 특수정보 업무 기본지식 숙지
# - 일지작성, 장비점검, 자료분석법 등
# 배속가능부대
# 공개불가
# 특전
# • 취득가능 자격증 : 정보처리 등
# 특기명칭부호
# 118
# 기계직종
# 특기명칭부호
# 시설직종
# 특기명칭부호
# 차량정비직종
# 차량운전직종
# 특기명칭부호
# 특기명칭부호
# 통신전자전기직종
# 특기명칭부호
# 직종
# 일반직종
# 특기개요
# 특수정보 자료의 수집, 종합된 자료의 일반적인 식별
# 외국 특수정보 자료 수집/기록 및 번역을 통한 분석 보조 업무 수행
# 특수정보80210
for doc in retrieved_docs:
    print(doc.page_content)
```