# 다중 벡터 스토어 리트리버
- 하나의 문서에서 여러 개의 벡터 표현을 생성해서 문서의 다양한 부분을 별도로 검색할 수 있도록 지원하는 리트리버
- 문서를 청크로 분할하거나 요약 임베딩을 생성하거나 특정 질문에 대한 답을 포함하는 벡터를 생성하는 등 여러 방식으로 문서를 표현함

<br>

### 동작
- 작은 청크 생성
  - 문서를 더 작은 단위로 분할, 각 청크에 대해 별도의 임베딩을 생성
  - 문서의 특정 부분에 대해서 세밀하게 검색하거나 분석할 때 유용함
- 요약 임베딩 사용
  - 문서의 핵심 내용을 요약한 후 이 요약본에 대해 임베딩을 생성
  - 문서 전체를 분석하지 않고도 중요한 내용을 빠르게 파악할 수 있어서 효율성을 높임
- 가설 쿼리 활용
  - 각 문서에 대한 적합한 가설 질문을 만들고 이를 기반으로 임베딩을 생성
  - 특정 주제에 대해 깊이 있는 탐색을 원할 때 적합함

<br>

# 청크와 원본 문서 검색하기
```python
PDF_PATH = "/Users/imkdw/study/RAG 비법노트/13. 리트리버/specialty_soldier.pdf"

from langchain_community.document_loaders import PyMuPDFLoader
import uuid
from langchain.storage import InMemoryStore
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain.retrievers.multi_vector import MultiVectorRetriever

loader = PyMuPDFLoader(PDF_PATH)
docs = loader.load()

vectorstore = Chroma(
    collection_name="small_bigger_chunks",
    embedding_function=OpenAIEmbeddings(model="text-embedding-3-small"),
)

store = InMemoryStore()

id_key = "doc_id"

retriever = MultiVectorRetriever(
    vectorstore=vectorstore,
    byte_store=store,
    id_key=id_key,
)

doc_ids = [str(uuid.uuid4()) for _ in docs]

# 부모 청크는 600
parent_text_splitter = RecursiveCharacterTextSplitter(chunk_size=600)

# 자식 청크는 200
child_text_splitter = RecursiveCharacterTextSplitter(chunk_size=200)

#
parent_docs = []
for i, doc in enumerate(docs):
    _id = doc_ids[i]
    parent_doc = parent_text_splitter.split_documents([doc])

    for _doc in parent_doc:
        _doc.metadata[id_key] = _id
    parent_docs.extend(parent_doc)

# 144
print(len(parent_docs))


child_docs = []
for i, doc in enumerate(docs):
    _id = doc_ids[i]
    child_doc = child_text_splitter.split_documents([doc])
    for _doc in child_doc:
        _doc.metadata[id_key] = _id
    child_docs.extend(child_doc)

# 1157
print(len(child_docs))

# 벡터 저장소에 부모, 자식 문서 추가
retriever.vectorstore.add_documents(parent_docs)
retriever.vectorstore.add_documents(child_docs)

# docstore 에 원본 문서를 저장
retriever.docstore.mset(list(zip(doc_ids, docs)))

question = "30010 특기의 이름은?"

# 유사도 검색
relevant_chunks = retriever.vectorstore.similarity_search(question)

# 검색된 문서의 개수: 4
print(f"검색된 문서의 개수: {len(relevant_chunks)}")

"""
41310
46110
⇓ 특기부호 구성
1 2 3 4 5
 
      예시) 헌병 병과
신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
8114(원·상·중사) → 8113(하사)
병
81110
* 병 특기부호의 경우, 5번째 자리에 특기세목 표기

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

항공기기체정비
항공기재보급
특 기 부 호
특기를 숫자로 나타낸 것
41310
46110
⇓ 특기부호 구성
1 2 3 4 5
 
      예시) 헌병 병과
신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
8114(원·상·중사) → 8113(하사)
병
81110

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
8114(원·상·중사) → 8113(하사)
병
81110
* 병 특기부호의 경우, 5번째 자리에 특기세목 표기
⇓ 신분별 특기 개요('16년도 기준, 특기신설·분리·통합 등 인사 정책에 따른 변동 가능)
신    분

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

군수
특기(명칭)
병과를 기능별로 분류한 것
항공기기체정비
항공기재보급
특 기 부 호
특기를 숫자로 나타낸 것
41310
46110
⇓ 특기부호 구성
1 2 3 4 5
 
      예시) 헌병 병과
신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
"""
for chunk in relevant_chunks:
    print(chunk.page_content, end="\n\n")
    print(">" * 100, end="\n\n")

# 원본 문서를 보기위한 invoke() 결과
relevant_docs = retriever.invoke(question)

"""
검색된 문서의 개수: 1

====================================================================================================

08
공군 특기 개요
⇓ 용어정의
용        어
설 명
예 시
병        과
군무를 기능별로 분류한 것
군수
특기(명칭)
병과를 기능별로 분류한 것
항공기기체정비
항공기재보급
특 기 부 호
특기를 숫자로 나타낸 것
41310
46110
⇓ 특기부호 구성
1 2 3 4 5
 
      예시) 헌병 병과
신  분
특 기 부 호
장 교
8109(대령) → 8108(중령) → 8107(소령·대위) → 8106(중·소위)
준사관
8115
부사관
8114(원·상·중사) → 8113(하사)
병
81110
* 병 특기부호의 경우, 5번째 자리에 특기세목 표기
⇓ 신분별 특기 개요('16년도 기준, 특기신설·분리·통합 등 인사 정책에 따른 변동 가능)
신    분
개    요
모집·선발시 지원 직종
장    교
18개 특기
-
부사관
· 17개 특기군
  : 항공통제, 방공포병, 구조, 안전, 무기정비, 보급수송,
    시설, 재정, 총무, 군악, 정보, 정훈, 법무, 의무 등
· 53개 특기
  : 항공통제, 단·중거리유도무기운용, 항공구조, 항공안전,
    정밀측정장비정비, 일반보급, 항공시설, 회계, 총무, 
    군악, 항공정보운영, 정훈, 법무서기, 항공의무 등
10개 직종
병
· 13개 특기군
  : 항공통제, 방공포병, 기상, 정보통신, 무기정비, 
    보급수송, 시설, 재정, 총무, 군악, 헌병, 정보, 의무 등
· 51개 특기
  : 항공통제, 단거리유도무기운용, 항공기상관측, 
    정보체계관리, 항공기기체정비, 항공기재보급, 토건, 
    회계, 총무, 군악, 헌병, 항공정보운영, 항공의무 등
11개 직종
군사특기군
숙련도
접미어
"""
print(f"검색된 문서의 개수: {len(relevant_docs)}", end="\n\n")
print("=" * 100, end="\n\n")
print(relevant_docs[0].page_content)
```

<br>

### 검색 유형을 MMR로 설정
```python
from langchain.retrievers.multi_vector import SearchType

retriever.search_type = SearchType.mmr

# 관련 문서 전체를 검색
question = "30010 특기의 이름은?"
print(retriever.invoke(question)[0].page_content)
```

<br>

### 검색 유형을 similarity_score_threshold로 설정
```python
from langchain.retrievers.multi_vector import SearchType

retriever.search_type = SearchType.similarity_score_threshold
retriever.search_kwargs = {"score_threshold": 0.3} # 유사도 점수가 0.3 이상인 문서만 검색

# 관련 문서 전체를 검색
print(retriever.invoke("30010 특기의 이름은?")[0].page_content)
```

<br>

### 검색 유형을 similarity로 설정
```python
from langchain.retrievers.multi_vector import SearchType

retriever.search_type = SearchType.similarity
retriever.search_kwargs = {"k": 1}

print(len(retriever.invoke("30010 특기의 이름은?")))
```

<br>

# 요약본을 벡터 DB에 저장하기