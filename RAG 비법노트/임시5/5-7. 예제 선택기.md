# 예제 선택기
- 모든 예시가 프롬프트에 들어가는건 그만큼 비용도 많이 발생한다는 뜻임
- 로컬 모델의 경우 컨텍스트가 작기때문에 답변의 길이도 짧아지는 문제가 존재함
- 예제 선택기는 질문과 유사한 예시만 선택해 프롬프트에 넣는 방식임

<br>

### MaxMarginalRelevanceExampleSelector
- 입력된 질문과 의미가 가장 유사한 예시를 선택하는데 사용함
- 예시가 정의된 examples 목록에서 질문과 가장 유사한 예시를 찾아 프롬프트에 넣게됨

<br>

### SemanticSimilarityExampleSelector
- 유사도뿐 아니라 예시의 다양성까지 고려해서 선택하는 방식임

<br>

# 예제
```python
from dotenv import load_dotenv
from langchain_core.example_selectors import (
    MaxMarginalRelevanceExampleSelector,
    SemanticSimilarityExampleSelector,
)
from langchain_core.prompts import FewShotPromptTemplate, PromptTemplate
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain_chroma import Chroma
from langchain_teddynote.messages import stream_response

load_dotenv()

examples = [
    {
        "question": "스티브 잡스와 아인슈타인 중 누가 더 오래 살았나요?",
        "answer": """이 질문에 추가 질문이 필요한가요: 예.
        추가 질문: 스티브 잡스는 몇 살에 사망했나요?
        중간 답변: 스티브 잡스는 56세에 사망했습니다.
        추가 질문: 아인슈타인은 몇 살에 사망했나요?
        중간 답변: 아인슈타인은 76세에 사망했습니다.
        최종 답변은: 아인슈타인""",
    },
    {
        "question": "네이버의 창립자는 언제 태어났나요?",
        "answer": """이 질문에 추가 질문이 필요한가요: 예.
        추가 질문: 네이버의 창립자는 누구인가요?
        중간 답변: 네이버는 이해진에 의해 창립되었습니다.
        추가 질문: 이해진은 언제 태어났나요?
        중간 답변: 이해진은 1967년 6월 22일에 태어났습니다.
        최종 답변은: 1967년 6월 22일""",
    },
    {
        "question": "율곡 이이의 어머니가 태어난 해의 통치하던 왕은 누구인가요?",
        "answer": """이 질문에 추가 질문이 필요한가요: 예.
        추가 질문: 율곡 이이의 어머니는 누구인가요?
        중간 답변: 율곡 이이의 어머니는 신사임당입니다.
        추가 질문: 신사임당은 언제 태어났나요?
        중간 답변: 신사임당은 1504년에 태어났습니다.
        추가 질문: 1504년에 조선을 통치한 왕은 누구인가요?
        중간 답변: 1504년에 조선을 통치한 왕은 연산군입니다.
        최종 답변은: 연산군""",
    },
    {
        "question": "올드보이와 기생충의 감독이 같은 나라 출신인가요?",
        "answer": """이 질문에 추가 질문이 필요한가요: 예.
        추가 질문: 올드보이의 감독은 누구인가요?
        중간 답변: 올드보이의 감독은 박찬욱입니다.
        추가 질문: 박찬욱은 어느 나라 출신인가요?
        중간 답변: 박찬욱은 대한민국 출신입니다.
        추가 질문: 기생충의 감독은 누구인가요?
        중간 답변: 기생충의 감독은 봉준호입니다.
        추가 질문: 봉준호는 어느 나라 출신인가요?
        중간 답변: 봉준호는 대한민국 출신입니다.
        최종 답변은: 예""",
    },
    {
        "question": "Google이 창립된 연도에 Bill Gates의 나이는 몇 살인가요?",
        "answer": """이 질문에 추가 질문이 필요한가요: 예.
        추가 질문: Google이 창립된 연도는 언제인가요?
        중간 답변: Google은 1998년에 창립되었습니다.
        추가 질문: Bill Gates는 몇 년도에 태어났나요?
        중간 답변: Bill Gates는 1955년에 태어났습니다.
        추가 질문: 1998년에서 Bill Gates가 몇 살이었나요?
        중간 답변: 1998년에는 Bill Gates가 43세였습니다.
        최종 답변은: 43세""",
    },
]

# 벡터디비 생성
chroma = Chroma("example_selector", OpenAIEmbeddings())

example_selector = SemanticSimilarityExampleSelector.from_examples(
    examples,
    OpenAIEmbeddings(),
    Chroma,
    k=1,  # 생성할 예시의 수
)

question = "Google이 창립된 연도에 Bill Gates의 나이는 몇 살인가요?"

# 입력과 가장 유사한 예시를 선택
selected_examples = example_selector.select_examples({"question": question})

# 입력에 가장 유사한 예시:
# Google이 창립된 연도에 Bill Gates의 나이는 몇 살인가요?
# print(f"입력에 가장 유사한 예시:\n{question}\n")

example_prompt = PromptTemplate.from_template(
    "Question:\n{question}\nAnswer:\n{answer}"
)

prompt = FewShotPromptTemplate(
    example_selector=example_selector,
    example_prompt=example_prompt,
    suffix="Question:\n{question}\nAnswer:",
    input_variables=["question"],
)

question = "Google이 창립된 연도에 Bill Gates의 나이는 몇 살인가요?"
example_selector_prompt = prompt.format(question=question)

# Question:
# Google이 창립된 연도에 Bill Gates의 나이는 몇 살인가요?
# Answer:
# 이 질문에 추가 질문이 필요한가요: 예.
#         추가 질문: Google이 창립된 연도는 언제인가요?
#         중간 답변: Google은 1998년에 창립되었습니다.
#         추가 질문: Bill Gates는 몇 년도에 태어났나요?
#         중간 답변: Bill Gates는 1955년에 태어났습니다.
#         추가 질문: 1998년에서 Bill Gates가 몇 살이었나요?
#         중간 답변: 1998년에는 Bill Gates가 43세였습니다.
#         최종 답변은: 43세

# Question:
# Google이 창립된 연도에 Bill Gates의 나이는 몇 살인가요?
# Answer:
print(example_selector_prompt)

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)

prompt = FewShotPromptTemplate(
    example_selector=example_selector,
    example_prompt=example_prompt,
    suffix="Question:\n{question}\nAnswer:",
    input_variables=["question"],
)

# 체인 생성
chain = prompt | llm

# 결과 출력
answer = chain.stream(
    {"question": "Google이 창립된 연도에 Bill Gates의 나이는 몇 살인가요?"}
)

# Google은 1998년에 창립되었습니다. Bill Gates는 1955년에 태어났습니다. 따라서 1998년에는 Bill Gates가 43세였습니다. 최종 답변은: 43세.%
stream_response(answer)
```