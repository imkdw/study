# LLM 답변 캐싱하기
- 캐싱이랑 동일한 질문이 발생하면 그에 대한 답변을 별도의 공간에 저장해 두는 것을 의미함
- 캐싱을 사용하면 동일한 질문을 LLM에 다시 요청하지 않고 저장된 캐시 정보에서 답변을 불러옴

<br>

# 어플리케이션의 캐시
- 인메모리 캐시와 SQLite 캐시 2가지 방법이 존재함

<br>

### 인메모리 캐시
- 메모리 공간을 활용해 동일한 질문에 대한 답변을 일시적으로 저장
- 앱이 다시 실행되면 캐시가 모두 사라지기 때문에 프로그램이 재시작되면 캐시를 다시 만들어야함
- 자주 반복되는 정형화된 질문과 답변에 적합함

<br>

### SQLite 캐시
- 답변을 장기적으로 캐싱할 수 있어서 재시작 후에도 캐싱된 답변을 빠르게 반환이 가능
- 장기적인 데이터 저장이 필요한 서비스에서 유용함

<br>

# 예제
### 인메모리 캐싱
```python
from dotenv import load_dotenv
from langchain_teddynote import logging
from langchain_teddynote.messages import stream_response
import time

load_dotenv()
logging.langsmith("langchain_test")

# ========================================================================

from langchain.globals import set_llm_cache
from langchain.cache import InMemoryCache
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate


set_llm_cache(InMemoryCache())

llm = ChatOpenAI(model_name="gpt-3.5-turbo")
prompt = PromptTemplate.from_template("{country} 에 대해서 200자 내외로 요약해줘")
chain = prompt | llm

print("첫 번째 실행...")
start_time = time.time()
response1 = chain.invoke({"country": "한국"})
end_time = time.time()
first_execution_time = end_time - start_time
print(f"첫 번째 실행 시간: {first_execution_time:.2f}초")
print(f"응답: {response1.content}\n")

print("두 번째 실행")
start_time = time.time()
response2 = chain.invoke({"country": "한국"})
end_time = time.time()
second_execution_time = end_time - start_time
print(f"두 번째 실행 시간: {second_execution_time:.2f}초")
print(f"응답: {response2.content}\n")


# 첫 번째 실행...
# 첫 번째 실행 시간: 2.25초
# 응답: 한국은 동아시아에 위치한 나라로 인구는 약 5천만 명이 넘는 대한민국과 북한이 있습니다. 1953년 전쟁 이후 남북간의 갈등이 여전한 상태이며, 남한은 민주주의체제를 채택하고 선진적인 경제를 보유하고 있습니다. 한국은 세계에서 가장 혼잡한 도시인 서울을 중심으로 현대화가 진행되고 있으며, K-pop, 드라마, 영화 등의 문화적 산업이 세계적으로 큰 인기를 얻고 있습니다. 또한 전통문화와 현대문화를 조화롭게 발전시키며 다양한 전통 축제와 문화행사를 지속적으로 개최하고 있습니다.

# 두 번째 실행
# 두 번째 실행 시간: 0.00초
# 응답: 한국은 동아시아에 위치한 나라로 인구는 약 5천만 명이 넘는 대한민국과 북한이 있습니다. 1953년 전쟁 이후 남북간의 갈등이 여전한 상태이며, 남한은 민주주의체제를 채택하고 선진적인 경제를 보유하고 있습니다. 한국은 세계에서 가장 혼잡한 도시인 서울을 중심으로 현대화가 진행되고 있으며, K-pop, 드라마, 영화 등의 문화적 산업이 세계적으로 큰 인기를 얻고 있습니다. 또한 전통문화와 현대문화를 조화롭게 발전시키며 다양한 전통 축제와 문화행사를 지속적으로 개최하고 있습니다.
```

<br>

### SQLite 캐싱
```python
from dotenv import load_dotenv
from langchain_teddynote import logging
from langchain_teddynote.messages import stream_response
import time

load_dotenv()
logging.langsmith("langchain_test")

# ========================================================================

from langchain.globals import set_llm_cache
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_community.cache import SQLiteCache
from langchain_core.globals import set_llm_cache
import os

if not os.path.exists("cache"):
    os.makedirs("cache")

set_llm_cache(SQLiteCache(database_path="cache/llm_cache.db"))

llm = ChatOpenAI(model_name="gpt-3.5-turbo")
prompt = PromptTemplate.from_template("{country} 에 대해서 200자 내외로 요약해줘")
chain = prompt | llm

print("첫 번째 실행...")
start_time = time.time()
response1 = chain.invoke({"country": "호주"})
end_time = time.time()
first_execution_time = end_time - start_time
print(f"첫 번째 실행 시간: {first_execution_time:.2f}초")
print(f"응답: {response1.content}\n")

print("두 번째 실행")
start_time = time.time()
response2 = chain.invoke({"country": "호주"})
end_time = time.time()
second_execution_time = end_time - start_time
print(f"두 번째 실행 시간: {second_execution_time:.2f}초")
print(f"응답: {response2.content}\n")

# LangSmith 추적을 시작합니다.
# [프로젝트명]
# langchain_test
# 첫 번째 실행...
# 첫 번째 실행 시간: 3.10초
# 응답: 호주는 대양주의 나라로 남반구에 위치하고 있습니다. 수도는 캔버라이며 최대 도시는 시드니와 멜버른입니다. 호주는 멋진 자연경관, 다양한 동식물, 화려한 해안선으로 유명하며 세계적인 관광지로도 알려져 있습니다. 또한 호주는 다양한 문화를 포용하고 있으며 인도얼, 중국인, 유럽인 등 다양한 인종들이 함께 살고 있는 다문화 국가입니다. 호주는 경제적으로도 중요한 역할을 하며 광산산업, 농업, 서비스업 등이 발전하고 있습니다. 최근에는 고부가가치 산업과 기술 및 연구 분야에도 큰 투자를 하고 있어 발전 가능성이 큰 국가입니다.

# 두 번째 실행
# 두 번째 실행 시간: 0.00초
# 응답: 호주는 대양주의 나라로 남반구에 위치하고 있습니다. 수도는 캔버라이며 최대 도시는 시드니와 멜버른입니다. 호주는 멋진 자연경관, 다양한 동식물, 화려한 해안선으로 유명하며 세계적인 관광지로도 알려져 있습니다. 또한 호주는 다양한 문화를 포용하고 있으며 인도얼, 중국인, 유럽인 등 다양한 인종들이 함께 살고 있는 다문화 국가입니다. 호주는 경제적으로도 중요한 역할을 하며 광산산업, 농업, 서비스업 등이 발전하고 있습니다. 최근에는 고부가가치 산업과 기술 및 연구 분야에도 큰 투자를 하고 있어 발전 가능성이 큰 국가입니다.

# LangSmith 추적을 시작합니다.
# [프로젝트명]
# langchain_test
# 첫 번째 실행...
# 첫 번째 실행 시간: 0.03초
# 응답: 호주는 대양주의 나라로 남반구에 위치하고 있습니다. 수도는 캔버라이며 최대 도시는 시드니와 멜버른입니다. 호주는 멋진 자연경관, 다양한 동식물, 화려한 해안선으로 유명하며 세계적인 관광지로도 알려져 있습니다. 또한 호주는 다양한 문화를 포용하고 있으며 인도얼, 중국인, 유럽인 등 다양한 인종들이 함께 살고 있는 다문화 국가입니다. 호주는 경제적으로도 중요한 역할을 하며 광산산업, 농업, 서비스업 등이 발전하고 있습니다. 최근에는 고부가가치 산업과 기술 및 연구 분야에도 큰 투자를 하고 있어 발전 가능성이 큰 국가입니다.

# 두 번째 실행
# 두 번째 실행 시간: 0.00초
# 응답: 호주는 대양주의 나라로 남반구에 위치하고 있습니다. 수도는 캔버라이며 최대 도시는 시드니와 멜버른입니다. 호주는 멋진 자연경관, 다양한 동식물, 화려한 해안선으로 유명하며 세계적인 관광지로도 알려져 있습니다. 또한 호주는 다양한 문화를 포용하고 있으며 인도얼, 중국인, 유럽인 등 다양한 인종들이 함께 살고 있는 다문화 국가입니다. 호주는 경제적으로도 중요한 역할을 하며 광산산업, 농업, 서비스업 등이 발전하고 있습니다. 최근에는 고부가가치 산업과 기술 및 연구 분야에도 큰 투자를 하고 있어 발전 가능성이 큰 국가입니다.
```