# 할인 요금 계산을 위한 협력 시작하기

- 영화에는 가격을 계산하는 메소드가 존재하지만 어떤 할인 정책을 사용할지 정하는 코드는 없음
- 이는 객체지향적인 코드로 단지 discountPolicy에게 메세지를 전달할뿐임

```ts
import Money from "./money";
import Screening from "./screening";

/**
 * 영화 개념
 */
export default class Movie {
  private title: string;
  private runningTime: Duration;
  private fee: Money;
  private discountPolicy: DiscountPolicy;

  constructor(title: string, runningTime: Duration, fee: Money, discountPolicy: DiscountPolicy) {
    this.title = title;
    this.runningTime = runningTime;
    this.fee = fee;
    this.discountPolicy = discountPolicy;
  }

  getFee(): Money {
    return this.fee;
  }

  calculateMoviePrice(screenging: Screening): Money {
    return this.fee.minus(this.discountPolicy.calculateDiscountAmount(screening));
  }
}
```

<br>

# 할인 정책과 조건

- 할인 정책은 `금액 할인 정책`과 `비율 할인 정책`으로 구분된다
- 두 클래스는 대부분의 코드가 유사하고 할인 요금을 계산하는 방식만 다르므로 중복코드 제거를 위해 공통코드를 보관할 장소가 필요
- 실페 앱에서는 `DiscountPolicy`에 대한 인스턴스 생성이 필요하지 않으므로 추상클래스로 선언함
- 부모 클래스에 기본적인 알고리즘을 구현하고, 중간에 필요한 처리를 자식클래스에게 위임하는것을 `템플릿 메소드 패턴`이라고 함

```ts
import Money from "./money";
import Screening from "./screening";

/**
 * 추상화된 할인정책 클래스
 *
 */
export default abstract class DiscountPolicy {
  /**
   * 할인 조건들
   */
  private conditions: DiscountContion[] = [];

  constructor(conditions: DiscountContion[]) {
    this.conditions = conditions;
  }

  calculateDiscountAmount(screening: Screening): Money {
    for (const condition of this.conditions) {
      if (condition.isSatisfiedBy(screening)) {
      }
    }
  }

  protected abstract getDiscountAmount(screening: Screening): Money;
}
```

<br>

### 할인 조건 인터페이스

```ts
import Screening from "./screening";

export default interface DiscountCondition {
  isSatisfiedBy(screening: Screening): boolean;
}
```

<br>

# 할인 조건 구현

### 순번을 인스턴스 변수로 포함하는 `SequenceCondition`

- 할인 여부를 판단하기 위해 사용할 순번을 포함함
- `Screening`의 상영 순번과 일치할 경우 할인이 가능한것으로 판단함

```ts
import DiscountCondition from "./discount-condition";
import Screening from "./screening";

export default class SequenceCondition implements DiscountCondition {
  private sequence: number;

  constructor(sequence: number) {
    this.sequence = sequence;
  }

  isSatisfiedBy(screening: Screening): boolean {
    return screening.isSequence(this.sequence);
  }
}
```

<br>

### 상영시간이 특정 기간에 포함되는지 검사하는 `PeriodCondition`

- 상영 요일을 기반으로 할인여부를 검사함

```ts
import Screening from "../screening";
import DiscountCondition from "./discount-condition";

enum DayOfWeek {
  SUNDAY = 0,
  MONDAY = 1,
  TUESDAY = 2,
  WEDNESDAY = 3,
  THURSDAY = 4,
  FRIDAY = 5,
  SATURDAY = 6,
}

/**
 * 상영 시간이 특정 기간안에 포함되는지 여부를 검사함
 */
export class PeriodCondition implements DiscountCondition {
  private dayOfWeek: DayOfWeek;
  private startTime: Date;
  private endTime: Date;

  constructor(dayOfWeek: DayOfWeek, startTime: Date, endTime: Date) {
    this.dayOfWeek = dayOfWeek;
    this.startTime = startTime;
    this.endTime = endTime;
  }

  isSatisfiedBy(screening: Screening): boolean {
    const screeningTime = screening.getStartTime();
    const screeningDayOfWeek = screeningTime.getDay();

    return (
      screeningDayOfWeek === this.dayOfWeek &&
      this.startTime.getTime() <= screeningTime.getTime() &&
      this.endTime.getTime() >= screeningTime.getTime()
    );
  }
}
```

<br>

# 할인 정책 구현
