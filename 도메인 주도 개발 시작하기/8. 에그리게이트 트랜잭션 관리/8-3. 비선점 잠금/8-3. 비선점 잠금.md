# 비선점 잠금

- 선점 잠금이 강력하긴 하지만 선점 잠금을 통해서 모든 트랜잭션 충돌 문제가 해결되지는 않는다
- 비선점 잠금은 동시에 접근하는것을 막는 대신 변경한 데이터를 실제 DBMS에 반영하는 시점에 변경 가능 여부를 확인하는 방식이다
- 애그리게이트를 수정할 때 마다 버전으로 사용할 프로퍼티값이 1씩 증가하는 방식으로 아래 같은 쿼리를 사용한다
- 또한 버전이 다른 애그리게이트에 대해서 쿼리를 수행하면 예외를 발생하도록 구현하면 된다

```sql
UPDATE aggreate SET version = version + 1 WHERE id = 1;
```

<br>

### 응용 계층에서의 처리

- 서버에서 버전에 대한 불일치가 발생한다면 응용 계층으로 이를 전달하여 적절한 처리가 가능하도록 해야한다

<br>

# 강제 버전 증가

- 루트 엔티티의 값이 바뀌지 않았더라도 내부 구성요소 중 일부 값이 변경된다면 논리적으로 그 애그리게이트는 바뀐것이다
- 애그리게이트 내에 어떤 구성요소의 상태가 바뀌면 루트 애그리게이트의 버전 값이 증가해야 비선점 잠금이 올바르게 작동하게된다
