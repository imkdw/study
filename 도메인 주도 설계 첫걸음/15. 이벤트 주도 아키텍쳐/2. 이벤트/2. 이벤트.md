# 이벤트, 커맨드, 메세지

- 이벤트는 메세지 패턴과 유사하지만 서로 다르다
- 이벤트는 메세지 이지만, 메세지는 반드시 이벤트가 아니다
- 이벤트는 이미 일어난 일이고 커맨드는 어떤 일을 하라는 지시다, 서로 메세지로 비동기 통신이 가능하다
- 이벤트는 이미 일어난 일을 설명하므로 이벤트 이름은 과거 시제로 표현해야한다

<br>

### 이벤트

- 이미 발생한 변화를 설명하는 메세지

<br>

### 커맨드

- 수행돼야 할 작업을 설명하는 메세지

<br>

# 구조

- 이벤트는 선택한 메세징 플랫폼을 사용해서 직렬화하고 전송할 수 있는 데이터 레코드다
- 일반적인 이벤트 스키마에는 이벤트의 메타데이터와 페이로드를 포함한다

```json
{
  "type": "delivery-confirmed",
  "event-id": "1234567890",
  "timestamp": "2020-01-01T00:00:00.000Z",
  "payload": {
    "delivery-id": "1234567890",
    "tracking-id": "1234567890",
    "status": "delivered"
  }
}
```

<br>

# 이벤트 유형

### 이벤트 알림

- 다른 컴포넌트가 반응할 비즈니스 도메인의 변경에 관한 메세지
- 이벤트를 알리는게 목적이므로 장황하지 않아야 하며 구독자아 이벤트에 반응하는데 필요한 모든 정보를 포함해서는 안된다
- 아래 예시는 생성된 급여를 알리지만 모든 정보를 담고있지는 않다

```json
{
  "type": "paycheck-generated",
  // ...
  "payload": {
    "paycheck-id": "1234567890",
    "amount": 1000,
    "currency": "KRW"
  }
}
```

<br>

#### 간결한 이벤트 알림

- 간결한 이벤트 알림은 여러 시나리오에서 선호됨
- 세부 정보를 얻기위한 질의를 명시적으로 하도록 강제하는건 민감한 정보가 메시징 인프라를 통해 공유되는걸 방지함
  - 구독자가 데이터에 접근하기 위해 추가 권한이 필요하게함
- 비동기적인 특성으로 인해서 정보가 구독자에게 도착했을 때 이미 만료된 상태로 렌더링 될 수 있음
  - 정보의 특성이 경쟁조건에 민감한 경우 명시적으로 질의하면 최신 상태를 얻을 수 있음

<br>

### 이벤트를 통한 상태전송

- 이벤트를 통한 상태전송(ECST) 메세지는 구독자에게 제공자의 내부 상태에 대한 변경사항을 알려줌
- 알림 메세지와는 다르게 상태 변경을 반영하는 모든 데이터를 포함하게됨
- 규모가 큰 자료구조를 사용해서 처리하는 경우는 실제로 수정된 필드만 ECST 메세지에 포함하는게 합리적임
- 이렇게 메세지 내부에 완전한 스냅샷이 포함되어 있거나 업데이트된 필드만 포함하는 경우는 엔티티 상태의 로컬 캐시를 보유하고 사용이 가능함
- 데이터가 필요할 때마다 데이터 소스를 질의하는 대신 모든 데이터를 로컬로 캐싱이 가능해짐

<br>

### 도메인 이벤트

- 도메인 이벤트는 이벤트 알림과 ECST 메세지 사이 어딘가 존재한다
- 둘 다 비즈니스 도메인에서 중요한 이벤트를 설명하고 관련된 모든 데이터를 포함하게된다

<br>

### 도메인 이벤트와 이벤트 알림의 관계

- 둘 다 제공자의 비느시으 도메인에서 발생한 변경사항을 서명하지만, 두 개념에는 차이가 존재함
- 도메인 이벤트에는 이벤트를 설명하는 모든 정보를 포함하는데, 완전한 그림을 얻기 위해서 추가 조치를 할 필요가 없음
- 이벤트 알림은 다른 컴포넌트와 연동을 돕기 위해서 설계됬지만, 도메인 이벤트는 비즈니스 도메인을 모델링하고 설명하기 위함임
- 즉 둘은 모델링 의도가 다름

<br>

### 도메인 이벤트와 이벤트를 통한 상태 전송의 관계

- 도메인 이벤트에 포함되는 데이터는 일반적인 ECST 메시지의 스키마와 개념적으로 다름
- ECST는 데이터를 로컬 캐시로 보유하기에 충분한 정보를 제공하지만 모든 도메인 이벤트는 이러한 풍부한 모델을 노출하면 안됨
- 사용자가 구독하지 않은 다른 도메인 이벤트가 동일한 필드에 영향을 줄 수 있으므로 특정 도미엔 이벤트에 포함된 데이터 조차도 애그리게이트의 상태를 캐싱하기에 충분하지 않음
- 도메인 이벤트에 포함된 데이터는 애그리게이트의 상태를 설명하기 위한것이 아니고 수명주기 동안 발생한 비즈니스 이벤트를 설명함
