# 저장 공간

- 공통점은 문자열을 저장할 수 있는 데이터 타입임
- 가장 큰 차이점은 고정 길이냐 가변 길이냐임

<br>

### CHAR

- 저장공간이 고정적이라 실제 저장된 값의 유효 크기가 얼마인지 저장할 필요가 없어서 추가 공간이 필요없음
- 문자열 길이가 일정하다면 항상 CHAR를 쓰는게 일반적임

<br>

### VARCHAR

- 최대 길이는 지정되어 있지만, 그 이하로 사용하면 그만큼 저장공간이 줄어듬
- 하지만 유효 크기가 얼마인지 별도로 저장해야되서 1~2 바이트의 저장공간이 추가로 필요함
- 저장되는 문자열 값을 길의가 가변적이라면 varchar를 사용하는게 좋음

<br>

### 하나의 글자를 저장하기 위해서 각 타입을 비교

- 모두 한 글자를 저장할 때 사용되는 문자 집합에 따라서 실제 저장공간을 1~4 바이트까지 사용함
- char에 저장하면 추가 공간이 필요없지만, varchar의 경우는 문자열 길이를 저장하기 위해 1~2 바이트의 추가 공간이 필요
  - varchar 타입의 길이가 255 바이트 이하면 1 바이트만 사용함
  - 256 바이트 이상으로 설정되면 2 바이트를 사용함
  - 2바이트로 표현할 수 있는 이상은 사요잉 불가능하므로 최대 길이는 65536 바이트 이상으로 설정이 불가능

<br>

### MySQL 레코드의 최대 크기

- TEXT, BLOB을 제외한 컬럼의 전체 크기는 64kb를 초과할 수 없음
- 만약 기존에 40kb를 쓰는 상황에서 25kb짜리 varchar를 만들면 text로 변경됨
- 참고로 65536 바이트라고 해서 이게 실제 글자는 길이가 아니고, 저장하는 문자마다 달라진다

<br>

### 컬럼이 자주 변경되는 경우 선택해야 하는 자료형?

- 2개의 타입중 선택 기준은 값의 길이도 중요하지만, 컬럼의 값이 얼마나 자주 변경되는지도 중요함

<br>

#### CHAR

- char의 경우 고정된 길이로 해당 길이만큼 데이터가 저장됨
- 만약 값이 바뀌는 경우 그냥 변경되는 컬럼의 값을 업데이트 하면됨
- 주민번호, 부서번호, 상태 등을 해당 타입으로 저장하면 좋음. 변경되도 바꿔넣기만 하면됨

<br>

#### VARCHAR

- varchar의 경우 실제 저장되는 만큼 + 데이터의 최대 길이로 데이터가 저장됨
- 만약 기존에 값보다 더 큰 데이터가 오는 경우 레코드 자체를 다른 공간으로 옮겨서 저장해야함
- 레코드 이동이나 분리는 CHAR에서 발생가능한 2~3바이트 공간 낭비보다 더 큰 공간이나 자원을 낭비하게함

<br>

### 자료형 뒤에 붙은 숫자가 의미하는것

- 해당 컬럼의 바이트 크기가 아니라 문자의 수를 의미함
- char(10), varchar(10)으로 컬럼을 정의하면 10글자(문자)를 저장할 수 있는 공간임
- 하지만 실제 디스크나 메모리에서 사용하는 공간은 각각 달라짐
  - 영어를 포함한 서구권 언어는 각 문자가 1바이트를 사용 -> `최대 10 바이트`
  - 한국어나 일본어와 같은 아시아권 언어는 각 문자가 최대 2바이트를 사용 -> `최대 20 바이트`
  - UTF-8 같은 유니코드는 최대 4바이트 까지 사용 -> `최대 40 바이트`

<br>

# 저장 공간과 스키마 변경

- 기존 varchar(60)의 컬럼을 63, 64 2개로 확장할 때 시간차이가 많이 발생한다
- 63의 경우 문자열 값의 길이를 저장하는 공간은 `63 * 4 = 252` 바이트로 1바이트만 사용한다
- 64의 경우 문자열 값의 길이를 저장하는 공간은 `64 * 4 = 256` 바이트로 2바이트를 사용하게 된다
- 이처럼 문자열 길이를 저장하는 공간의 크기가 바뀌면 `lock=shared`를 걸어서 변경을 막고 레코드를 복사하는 방식으로 처리한다
- 만약 길이가 크게 변경될 것으로 예상되면 길이 저장 공간의 크기가 바뀌지 않도록 미리 조금 크게 설계하는게 좋다

<br>

# 문자 집합(캐릭터 셋)

- 문자 집합은 문자열을 저장하는 char, varchar, text 타입 컬럼에만 사용이 가능함
- 요즘 앱은 다국어 처리를 위해서 대부분 utf-8(utf8mb4)를 사용하고 있음

<br>

### MySQL의 문자 집합을 설정하는 시스템 변수

- character_set_system
  - 서버가 식별자를 저장할 때 사용하는 문자 집합
  - 기본값으로 utf8로 설정되고, 설정하거나 변경할 필요가 없음
- character_set_server
  - 서버의 기본 문자 집합
  - 기본값으로 utf8mb4로 설정되고, 디비나 테이블에 따로 명시가 안됬다면 해당값이 사용됨
- character_set_database
  - 디비의 기본 문자 집합
  - 기본값으로 utf8mb4로 설정되고, 디비나 테이블에 따로 명시가 안됬다면 해당값이 사용됨
- character_set_filesystem
  - `load data infile ...`, `select ... into outfile`문장을 쓸때 인자로 지정되는 파일명 해석시 사용
  - 데이터 파일의 내용을 읽을때 쓰는게 아닌 파일을 찾을떄 쓰는것임
- character_set_client
  - 클라이언트가 보낸 sql은 해당 값으로 인코딩해서 서버로 전송함
  - 커넥션에서 임의의 문자 집합으로 변경해서 사용이 가능함
  - 인트로듀서가 지정된 경우는 해당값은 무시됨
- character_set_connection
  - 서버가 클라에서 받은 sql 처리를 위해서 해당 집합으로 변환함
  - 클라에서 받은 숫자값들 문자로 변환할때도 해당 값을 사용함
  - 기본값은 utf8mb4로 설정되어 있음
- character_set_results
  - 서버에서 쿼리의 처리 결과를 보낼때 사용하는 문자 집합
  - 기본값은 utf8mb4로 설정되어 있음, 커넥션에서 임의로 제어가 가능함

<br>

### 클라이언트에서 쿼리를 요청했을 때의 문자 집합 변환

- SQL에서 별도로 문자 집합을 설정하는 지정자를 인트로듀서라고 부름
- 일반적으로 문자열 앞에 \_(언더스코어)를 붙여서 표현함

```sql
select emp_no, first_name from employees where first_name = _latin1'Matt';
```

<br>

### 처리 결과를 클라이언트로 전송할 때 문자 집합 변환

- 변환 전의 문자 집합과 변환해야 할 문자 집합이 동일하면 별도의 변환 작업은 모두 생략함
- 문자 집합은 물론이고 콜레이션까지 포함해서 같은지 다른지를 비교함

<br>

# 콜레이션(Collation)

- 문자열 컬럼의 값에 대한 비교나 정렬 순서를 위한 규칙
- 모든 문자열 타입 컬럼은 독립적인 문자 집합과 콜레이션을 가짐
- 각 컬럼에 대해서 개별로 지정하지 않는다면 기본 문자 집합과 콜레이션이 설정됨
- 또한 문자 집합과 콜레이션에 일치여부에 따라 쿼리릐 결과가 달라지고 성능도 상당한 영향을 받음

<br>

### 콜레이션 이해

- 하나의 문자 집합에 속한 콜레이션은 다른 문자 집합과 공유해서 사용이 불가능함
- 컬럼의 문자 집합만 지정하고 콜레이션을 지정하지 않으면 묵시적으로 그 컬럼의 문자 집합으로 사용함
- 일반적으로 2개 또는 3개의 파트로 구분되어 있음
  - 3개의 파트 : 문자 집합 이름 + 문자 집합 하위 분류 + 대문자 소문자 구분 여부
  - 2개의 파트 : 문자 집합의 이름 + 항상 bin 이라는 키워드 사용(실제 문자 데이터의 바이트 기준으로 비교)
- 예를 들어서 0900은 UCA(Unicode Collation Algorithm) 버전을 뜻함
- ai, as는 엑샌트를 가진 문자와 안그런 문자를 정렬 순서상 동일 문자로 판단할지에 대한 여부다
- 문자열 컬럼은 콜레이션 없이 집합만 가질수는 없고 항상 비교는 콜레이션에 의해서 판단됨
  - 타입의 이름과 길이만 같다고 해서 똑같은 타입이라고 할수는 없음

<br>

### utf8mb4 문자 집합의 콜레이션

- 보통 앱에서는 다국어 지원을 위해 utf8mb4를 많이 사용하는 추세임
- latin의 경우 아주 특별한 경우 말고는 잘 안씀
- 성능을 기준으로 콜레이션을 정하진 말고, 필요에 따라서 결정하는게 좋다
- 만약 새로운 서비스를 개발하고 있다면 UCA 9.0.0 기반의 콜레이션을 권장한다

<br>

# 비교 방식

- MySQL에서 지원하는 대부분의 문자 집합과 콜레이션은 CHAR, VARCHAR 타입 뒤에 공백을 붙여서 문자열의 길이를 동일하게 만들고 비교를 수행한다
- UCA 9.0.0을 사용하는 컬럼의 경우는 앞, 뒤 공백이 비교연산에 영향을 미친다

```sql
set names utf8mb4 collate utf8mb4_bin;
select 'a ' = 'a'; -- 1(true)

set names utf8mb4 collate utf8mb4_0900_bin;
select 'a ' = 'a'; -- 0(false)
```

<br>

# 문자열 이스케이프 처리

- 일반적인 프로그래밍 언어처럼 문자열 이스케이프를 지원한다
- 홀따옴표, 쌍따옴표의 경우는 `\`를 사용하지 않고 `""` 또는 `''`로 처리가 가능함
