# MySQL 엔진의 잠금

- 락의 경우 스트리지 엔진 레벨과 MySQL 엔진 레벨로 구분이 가능함
- 또한 테이블락, 메타데이터 락, 네임드 락 등 존재함

<br/>

# 글로벌 락

- MySQL에서 제공하는 락 중 가장 범위가 크며, 범위는 MySQL 전체임
- SELECT를 제외한 DDL, DML 쿼리는 글로벌 락이 설정된 동안 대기로 남게됨
- 락을 걸기전에 테이블에 실행중인 모든 쿼리가 완료되어야함
- 모든 테이블에 큰 영향을 미치기 때문에 웹서비스용 디비에서는 사용하지 않는게 좋음

```sql
mysql> flush tables with read lock;
Query OK, 0 rows affected (0.02 sec)

mysql>
```

<br/>

### 백업 락

- 백업의 실패를 막기 위해서 DDL 명령이 실행되면 복제를 일시중지 하는 역할
- 특정 세션에서 백업 락을 흭득하면, 테이블의 스키마나 사용자의 인증관련 정보 변경이 불가능함

```sql
mysql> lock instance for backup;
Query OK, 0 rows affected (0.00 sec)

mysql> unlock instance;
Query OK, 0 rows affected (0.00 sec)
```

<br/>

# 테이블 락

- 개별 테이블 단위로 설정되는 잠금으로, 명시적 또는 묵시적으로 특정 테이블의 락이 가능함
- 명시적 락의 경우 특별한 상황이 아니라면 앱에서 사용할일은 거의 없음
- 묵시적 락의 경우 쿼리가 실행되는 동안 자동으로 획득됬다가 다시 자동으로 해제됨
  - InnoDB의 경우 레코드 기반 잠금을 제공해서 단순 데이터 변경으로 인해 락이 걸리진 않음
  - 대부분 DML 쿼리에서는 무시되고, 스키마를 변경하는 DDL 쿼리에만 영향을 미침

```sql
mysql> lock tables test_table READ;
Query OK, 0 rows affected (0.00 sec)

mysql> unlock tables;
Query OK, 0 rows affected (0.00 sec)
```

<br/>

# 네임드 락

- `GET_LOCK()` 함수를 사용해서 임의의 문자열에 잠금을 설정하는 락
- 단순히 사용자가 지정한 문자열에 대해서 락을 설정함
- 자주 사용되지는 않고, 많은 레코드에 대해서 복잡한 요건을 레코드를 변경하는 특 특정 상황에서 사용됨

```sql
mysql> select get_lock('mylock1', 10);
+-------------------------+
| get_lock('mylock1', 10) |
+-------------------------+
|                       1 |
+-------------------------+
1 row in set (0.00 sec)

mysql> select get_lock('mylock2', 10);
+-------------------------+
| get_lock('mylock2', 10) |
+-------------------------+
|                       1 |
+-------------------------+
1 row in set (0.00 sec)

mysql> select release_lock('mylock1');
+-------------------------+
| release_lock('mylock1') |
+-------------------------+
|                       1 |
+-------------------------+
1 row in set (0.00 sec)

mysql> select release_lock('mylock2');
+-------------------------+
| release_lock('mylock2') |
+-------------------------+
|                       1 |
+-------------------------+
1 row in set (0.00 sec)

mysql> select release_all_locks();
+---------------------+
| release_all_locks() |
+---------------------+
|                   0 |
+---------------------+
1 row in set (0.00 sec)

mysql>
```

<br/>

# 메타데이터 락

- DB 객체의 이름이나 구조를 변경하는 경우 획득하는 잠금
- 명시적으로 획득이 불가능하고, 테이블의 이름을 변경하는 등 상황에서 자동으로 획득함
- 예를 들면 실시간으로 테이블을 바꿔야하는 요건이 배치프로그램에서 자주 발생하는데 이런 경우임

<br/>

### 시간이 오래걸리는 테이블 구조 변경 쿼리 개선하기

- DDL의 경우 단일 스레드로 작동하기 때문에 데이터가 많으면 시간이 오래걸린다
- 이 때 KEY_BLOCK_SIZE 설정을 통해 테이블을 압축한다
- 이후에 N개의 스레드에서 데이터를 삽입한다
- 이후 남은 데이터는 MAX(id)를 통해서 마저 삽입한다.
- 이 때 최대한 많은 데이터를 사전에 백업해야 락으로 인한 영향을 줄일 수 있다
