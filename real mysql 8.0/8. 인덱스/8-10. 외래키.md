# 외래키

- 외래키 제약이 설정되면 연관되는 테이블의 컬럼에 인덱스까지 생성됨
- 외랰키 관리에는 중요한 두 가지 특징이 존재
  - 테이블의 변경이 발생(쓰기잠금)하는 경우만 잠금 경합이 발생
  - 외래키와 연관되지 않은 컬럼의 변경은 최대한 잠금 경합을 발생시키지 않음
- 외래키를 물리적으로 생성하는 경우 잠금 경합까지 고려해서 모델링 하는게 좋음
  - 잠금이 다른 테이블로 확장되면 그만큼 전체적으로 쿼리의 동시 성능이 낮아짐

<br/>

# 자식 테이블의 변경이 대기하는 경우

- 1번 커넥션에서 트랜잭션을 시작하고 id가 2인 레코드에 대해 쓰기잠금 획득
- 외래키 컬럼을 변경하는 4번 작업은 2번 작업이 완료될 때 까지 대기
- 자식 테이블의 외래키 컬럼 변경은 부모 테이블 확인이 필요한데, 부모 테이블의 해당 레코드가 쓰기 잠금이 걸려있으면 완료될 때 까지 대기

| 작업번호 | 커넥션 1                               | 커넥션 2                               |
| -------- | -------------------------------------- | -------------------------------------- |
| 1        | BEGIN;                                 |                                        |
| 2        | UPDATE tb_parent set fd='2' where id=2 |                                        |
| 3        |                                        | BEGIN;                                 |
| 4        |                                        | UPDATE tb_child set pid=2 where id=100 |
| 5        | ROLLBACK                               |                                        |
| 6        |                                        | QUERY OK                               |

<br/>

# 부모 테이블의 변경작업이 대기하는 경우

- 2번 쿼리에서 커넥션 1번은 부모 아이디가 1인 레코드(id=100)를 변경할 때 쓰기 잠금 획득
- 4번 쿼리에서 삭제할려고 하면 쓰기 잠금이 해제될 때 까지 기다림
- 이는 외래키의 특성(ON DELETE CASCADE) 때문에 부모 레코드가 삭제되면, 자식도 같이 삭제하는 식으로 동작하기 때문

| 작업번호 | 커넥션 1                                    | 커넥션 2                         |
| -------- | ------------------------------------------- | -------------------------------- |
| 1        | BEGIN;                                      |                                  |
| 2        | UPDATE tb_child set fd='100' where id = 100 |                                  |
| 3        |                                             | BEGIN;                           |
| 4        |                                             | DELETE FROM tb_parent where id=1 |
| 5        | ROLLBACK                                    |                                  |
| 6        |                                             | QUERY OK                         |
