# 데이터 암호화

- 보안 감사에서 필수적으로 언급되는 부분이다
- 어플리케이션 암호화는 주로 주민번호 같은 중요 정보를 가진 컬럼 단위로 수행한다
- 디비 수준에서는 테이블 단위로 암호화를 적용한다

<br/>

# MySQL 서버의 데이터 암호화

- 디비 서버와 디스크 사이이의 데이터 I/O 지점에서 암/복호화를 수행한다
- 스토리지 엔진의 I/O 레이어에서만 암/복호화 과정이 수행되는것이다
- 이런 특성으로 인해 암호화 방식을 `TDE(Transparent Data Encryption)`라고 부른다

<br/>

# 2단계 키 관리

- 암호화 키는 키링 플러그인에 의해 관리되고, 다양한 키링 플러그인이 존재한다.
- 커뮤니티 에디션의 경우는 `keyring_file` 플러그인만 사용이 가능하다
- 기본적으로 키링 플러그인의 경우 2단계(2-Tier) 키 관리 방식을 사용한다
- 마스터 키, 테이블스페이스 키 2개의 키를 관리한다

### 마스터 키

- 외부 키 관리 솔루션이나 디스크의 파일에서 마스터키를 가져온다
- 외부에 노출될 위험이 있으니 주기적으로 변경하는게 좋다
- 마스터 키가 변경되면 기존 키를 통해 테이블스페이스 키를 복호화 후 신규 키로 다시 암호화한다

```sql
mysql> ALTER INSTANCE RORATE INNODB MASTER KEY;
```

### 테이블스페이스 키

- 암호화된 테이블이 생성될때마다 각 고유한 테이블스페이스 키를 생성한다
- 테이블스페이스 키는 마스터키를 통해서 암호화횐다
- 생성된 테이블스페이스 키는 각 테이블의 데이터 파일 헤더에 저장한다
- 한번 생성된 테이블스페이스 키는 테이블이 삭제되지 않는이상 절대 변하지 않는다

### 암호화 알고리즘

- TDE에서 지원하는 알고리즘은 AES 256비트만 지원한다
- 테이블스페이스 키는 AES-256 ECB로 암호화된다
- 실제 데이터 파일은 AES-256 CBC로 암호화된다

<br/>

# 암호화의 성능

- 한번 읽은 페이지는 복호화되어 버퍼 풀에 저장되어서 암호화 되지 않은 테이블과 성능은 비슷하다
- 암호화, 복호화 시간동안 쿼리가 지연되나 디스크 동기화는 백그라운드 스레드가 담당해서 실제 유저의 쿼리가 지연되진 않는다
- 읽기, 쓰기 모두 기존 평문에 비해 3~6배정도 느려지지만, 밀리초 단위라 크게 체감되지는 않는다
- `performance_schema.file_summary_by_instance` 테이블에서 속도 확인이 가능하다

### 데이터 크기

- 평문의 길이가 짧은 경우는 암호화 데이터의 크기가 더 클순 있지만 데이터 페이지는 이미 암호화 키보다 훨씬 커서 사실상 동일하다
- 암호화를 적용한다고 해서 버퍼 풀의 효율이 달라지거나 메모리 사용 효율이 떨어지지는 않는다

### 압축과 암호화

- MySQL은 압축을 먼저 진행하고 암호화를 수행한다
- 암호화된 결과물은 랜덤 바이트를 가지는데 이러면 압축률이 매우 떨어진다
- 버퍼풀에 암호화된 데이터가 먼저 올라가면 매번 복호화를 수행해야되서 성능이 저하된다

<br/>

# 암호화와 복제

- DB에서는 소스 서버와 레플리카 서버의 모든 데이터를 복제하지만 암호화시 키는 그렇지 않다
- 각 인스턴스별로 고유한 키를 가지며, 원격 키 관리 솔루션을 사용한다고 해도 서로 다른 마스터키를 가지도록 설정해야한다
- `ALTER INSTANCE ROTATE INNODB MASTER KEY` 명령은 레플리카 자체로 복제는 되지만 키는 복제되지 않는다
- 항상 백업마다 키링 파일의 백업도 같이 고려하는것이 좋다
