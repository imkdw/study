# 복제 아키텍쳐

- MySQL의 복제의 경우 바이너리 로그를 기반으로 구축되어 사용한다
- 소스서버에서 바이너리 로그를 생성하면 이를 레플리카 서버가 읽어서 동기화가 이루어진다
- 이 때 레플리카 서버에서 바이너리 로그를 읽어서 따로 로컬 디스크에 저장해둔 파일을 릴레이 로그라고 한다
- 복제는 총 3개의 스레드에의해 동작하는데, 1개는 소스서버 나머지 2개는 레플리카 서버에 있다

<br>

# 복제에서 사용하는 스레드의 종류

- 레플리카 서버에서 사용하는 스레드는 서로 독립적으로 동작함

### 바이너리 로그 덤프 스레드(Binary Log Dump Thread)

- 소스 서버에서는 레플리카 서버가 연결될 때 내부적으로 바이너리 로그 덤프 스레드를 생성해서 바이너리 로그를 레플리카 서버로 전송해줌
- 전송을 위해서 각 이벤트를 읽을 때 일시적으로 바이너리 로그에 잠금이 필요하고, 완료되면 해제함
- `show processlist`를 통해서 확인이 가능함

<br>

### 레플리케이션 I/O 스레드(Replication I/O Thread)

- 소스 서버에서 바이너리 로그를 읽어와서 릴레이 로그로 저장하는 역할을 담당함
- 복제가 시작되면 I/O 스레드를 생성, 복제가 멈추면 스레드는 종료됨
- `show replica status`에서 `Replica_IO_Running` 컬럼에 표시된 값으로 확인이 가능함

<br>

### 레플리케이션 SQL 스레드(Replication SQL Thread)

- I/O 스레드에서 저장한 릴레이 로그를 읽어서 이벤트를 읽고 실행해줌
- 동일하게 `show replica status`에서 `Replica_IO_Running` 컬럼에 표시된 값으로 확인이 가능함

<br>

# 복제에서 생성되는 데이터의 종류

### 릴레이 로그(Relay Log)

- 소스 서버의 바이너리 로그에서 읽어온 이벤트(트랜잭션) 정보가 저장됨
- 릴레이 로그 파일들의 목록이 담긴 인덱스 파일과 실제 이벤트 정보가 저장된 로그 파일로 구성됨
- 레플리케이션 SQL 스레드에 의해서 레플리카 서버에 적용됨

<br>

### 커넥션 메타데이터(Connection Metadata)

- 소스 서버에 연결할 때 사용된 DB 계정, 바이너리 파일명 등이 담겨있음
- `mysql.slave_master_info` 테이블에 저장됨

<br>

### 어플라이어 메타데이터(Applier Metadata)

- SQL 스레드에서 릴레이 로그에 저장된 소스 서버의 이벤트를 레플리카 서버에 적용하는 컴포넌트
- 최근 적용된 이벤트나 해당 이벤트가 저장돼있는 릴레이 로그 파일명 등을 담고있음
- 해당 정보를 바탕으로 SQL 스레드는 나머지 이벤트를 적용함
- `mysql.slave_relay_log_info` 테이블에 저장됨
