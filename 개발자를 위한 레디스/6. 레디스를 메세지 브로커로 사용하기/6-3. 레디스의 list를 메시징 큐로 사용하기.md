# LIST의 EX 기능

- SNS에는 각 유저별 타임라인이 존재함
  - 타임라인은 각자의 계정에서 팔로우한 게시글, 관련이는 게시글 등이 표현됨
  - 트위터의 경우 각 유저의 타임라인 데이터를 레디스에서 LIST로 관리함

# RPUSHX 커맨드

- RPUSH와 다르게 RPUSHX는 이미 존재하는 데이터에 대해서만 데이터가 추가된다
- 이는 자주 접속하지 않는 유저의 데이터는 굳이 관리하지 않을때 유용하다

```
<!-- 기존에 존재하는 유저에게는 데이터가 추가됨 -->
127.0.0.1:6379> rpush timeline:user:a timeline:1
(integer) 1
127.0.0.1:6379> rpushx timeline:user:a timeline:2
(integer) 2
127.0.0.1:6379> xrange timeline:user:a 0 -1
127.0.0.1:6379> lrange timeline:user:a 0 -1
1) "timeline:1"
2) "timeline:2"

<!-- 새로운 유저에게는 데이터가 추가되지 않음 -->
127.0.0.1:6379> rpushx timeline:user:b timeline:1
(integer) 0
127.0.0.1:6379> lrange timeline:user:b 0 -1
(empty array)
```

<br/>

# list의 블로킹 기능

### 이벤트 루프

- 이벤트 루프는 새로운 이벤트가 있는지 체크하며, 없으면 대기했다가 다시 반복함
- 이런 작업은 폴링이라고 부르며, 프로세스가 진행중인 동안 앱과 큐의 리소스가 불필요하게 소모됨
- 폴링 인터벌 시간동안 새로운 이벤트가 들어와도 잠시 지연이 생길수도 있어서 즉시 처리는 안됨

### list 블로킹

- redis list 블로킹을 통해 이벤트 루프의 단점을 보완할 수 있음
- BLPOP, BRPOP 명령어로 블로킹 기능 사용이 가능함
- 만약 값이 있다면 바로 반환하고, 없다면 지정한 시간동안 기다렸다가 값을 반환
  - 시간이 만료되면 nil 값을 반환
- 일반 RPOP과는 다르게 반환값이 2개인데, 키값과 값을 같이 반환함
  - 이는 여러개의 큐를 동시에 사용하기 위해서 그렇게 되어있음

```
127.0.0.1:6379> brpop q:a 5
(nil)
(5.10s)
127.0.0.1:6379> brpop q:a 5
1) "q:a"
2) "1"
(1.46s)
```

<br/>

### list를 사용한 원형 큐

- 특정 아이템을 계속해서 반복 접근해야하는 클라, 도는 여러개의 클라가 병렬적으로 같은 이이템에 접근해야할때 원형큐를 사용해서 처리하고 싶을수도 있음
- RPOPLPUSH 명령어로 원형 큐를 사용할 수 있음

```
127.0.0.1:6379> lpush clist a
(integer) 1
127.0.0.1:6379> lpush clist b
(integer) 2
127.0.0.1:6379> lpush clist c
(integer) 3
127.0.0.1:6379> lrange clist 0 -1
1) "c"
2) "b"
3) "a"
127.0.0.1:6379> rpoplpush clist clist
"a"
127.0.0.1:6379> lrange clist 0 -1
1) "a"
2) "c"
3) "b"
127.0.0.1:6379>
```
