# 클라이언트 핸들링

- 기본적으로 소켓과 TCP를 사용하고, 원한다면 포트와 소켓 저장경로 변경이 가능함
- 멀티플렉싱 방식을 사용해서 하나의 통신채널을 통한 여러 데이터 스트림 전송이 가능
- 논블록킹 I/O를 통해서 다수의 클라이언트 지원이 가능함
- TCP_NODELAY 옵션을 통해서 작은 데이터라도 버퍼링하지 않고, 빠른 통신이 가능함
- 최대 클라이언트는 기본으로 10000이며, 이를 초과하는 경우 에러를 발생시킴

<br/>

# 클라이언트 버퍼 제한

- 클라이언트에 반환할 데이터를 임시로 저장하기 위해서 각 클라이언트마다 출력버퍼를 생성함
  - 연결된 클라이언트가 1000개면, 1000개의 출력버퍼를 생성함
- 클라이언트가 데이터를 처리하지 못하고 요청만 하게되면 계속해서 늘어나고 메모리 사용량이 증가함
  - 이런걸 대비해서 버퍼가 일정 크기 이상으로 커지면 클라이언트와 커넥션을 종료함
- 출력버퍼 외에 쿼리 버퍼도 존재함
  - 레디스에 요청이 들어오면 이를 버퍼에 저장하고나서 처리함
  - 기본값은 1GB로 쿼리버퍼가 무한하게 커지는것을 방지하기 위함
  - client-query-buffer-limit을 통해서 조정이 가능함

### Pub/Sub 제한

- 하드제한 : 32MB
- 소프트제한 : 1분당 8MB

### 복제본 제한

- 하드제한 : 256MB
- 소프트제한 : 1분당 64MB
- 마스터로 부터 대용량의 데이터를 받게된다면 더 큰 출력버퍼가 필요함

### 제한 변경하기

- CONFIG SET을 통해서 변경이 가능함

<br/>

# 클라이언트 이빅션(eviction)

- 7 이전 버전에서는 `maxmemory-policy`를 통해서 메모리 한도를 관리
- 7 이후 버전에서는 `maxmemory-clients`를 통해서 관리
  - 임계치에 도달한 클라이언트는 메모리 확보를 위해서 커넥션을 종료함

### maxmemory-clients 설정

- redis.conf 또는 CONFIG SET을 통해서 설정함
- 복제본에서 마스터, 복제본 노드는 해당 설정에 영향받지 않음
- 수동으로 해당 기능을 끄고싶다면 cli에서 `CLIENT NO-EVICT ON` 명령을 사용함
- 대용량 트래픽 환경에서는 5~10% 사이 값을 사용하는걸 권장함

```
<!-- 최대 1GB 까지 사용가능 -->
maxmemory-clients 1G

<!-- 최대 5% 까지 사용 가능 -->
maxmemory-clients 5%

<!-- 기능 미사용 -->
maxmemory-clients 0
```

<br/>

# Timeout, TCP Keepalive

### Timeout

- 설정된 초 동안 응답이 없는 클라이언트는 커넥션이 종료된다
- `CONFIG SET timeout <초>`를 통해서 설정함

### TCP Keepalive

- 주기적으로 TCP ACK를 보내고 응답이 없다면 종료함
- 클라이언트가 정상적으로 응답하지 못하는지를 우선으로 확인하고 끊는 방식
- 기본적으로 5분에 한번씩 신호를 보냄
