# 클러스터 리샤딩

- 마스터 노드가 가지고있는 해시슬롯 중 일부를 다른 마스터로 이동하는것
- redis-cli를 통해서 리샤딩과 결과 확인이 가능함

```
redis-cli --cluster reshard <ip> <port>
```

```
redis-cli --cluster check <ip> <port>
```

<br/>

# 클러스터 리샤딩 - 간단버전

- 리샤딩을 해야될 일이 자주 있거나 자동화를 하고싶을때 별도 인터렉션 없이 바로 슬롯 이동이 가능함
- 단점은 바로 이동되기 때문에 중간에 취소랑 확인이 어려움

```
redis-cli --cluster reshard <ip> <port> --cluster-from <node-id>
```

<br/>

# 클러스터 확장 - 신규 노드 추가

- 확장을 위한 신규 노드 추가 또는 가용성을 위한 복제본 추가 등이 해당됨
- 위 2개의 경우 모두 추가하고자 하는 레디스에는 아무런 데이터도 없어야함, 비어있지 않으면 에러가 발생함

### 마스터로 추가하기

```
redis-cli --cluster add-node <신규 노드 ip:port> <기존 노드 ip:port>
```

### 복제본으로 추가하기

```
redis-cli --cluster add-noe <신규 노드 ip:port> <기존 노드 ip:port> --cluster-slave <기존 마스터 ID>
```

<br/>

# 노드 제거하기

- 첫번째 인자는 기존 클러스터 노드 중 하나의 노드 정보를 입력해야함
- 마스터 노드의 경우 데이터가 없을때만 제거가 가능함
  - 즉 리샤딩을 통해서 모든 해시슬롯이 다른 마스터노드로 옮겨져야함
  - 혹은 수동으로 페일오버를 하고나서 노드의 역할을 복제본으로 만들고 제거할수도 있음

```
redis-cli --cluster del-node <기존 노드 ip:port> <삭제할 노드 ID>
```

### CLUSTER FORGET

- 클러스러를 제거하면 다른 노드에게도 해당 클러스터가 삭제됬다고 알려줘야함
- 커맨드를 전파하고나면 60초 동안은 동일한 노드 정보로 연결을 시도하지 않음
- 클러스터 구성에서 노드들은 가십프로토콜로 신규 클러스터 노드를 탐지하고 자동으로 연결함

### CLUSTER RESET

- 제거될 노드에서 수행될 명령어로 2가지 옵션이 존재하며 기본값은 SOFT다
- cluster del-noe 도중에도 자동으로 실행되지만, 사용자가 특정 클러스터 노드를 다른 역할로 재사용 할려고 할때도 사용이 가능함

#### SOFT

- 복제본 역할이였으면 마스터로 전환되고 모든 데이터가 삭제됨
- 만약 노드가 마스터고 저장된 키가 존재하면 리셋은 중단됨
- 노드가 해시슬롯을 가지고 있었으면 모두 해제되고 페일오버가 진행중이였다면 진행 상태도 초기화됨
- 클러스터 구성 내다른 노드 데이터가 초기화됨. 기존 클러스터 내부 노드 인식이 불가능함

#### HARD

- SOFT 과정을 모두 수행하고 추가 과정이 존재함
- currentEpoch, configEpoch, lastVoteEpoch 값이 0으로 초기화됨
- 해당 노드 ID가 새로운 임의 ID로 변경됨

<br/>

# 레디스 클러스터로의 데이터 마이그레이션

- 기존 싱글 또는 센티널로 운영중인 레디스를 클러스터로 마이그레이션하고 싶다면 redis-cli로 쉽게 가능함
- 기존 앱에서 다중 키 커맨드를 사용하지 않았다면 커넥션 변경 말고는 다른 문제는 없고, 사용했다면 해시태그를 사용하도록 앱 수정이 필요함
- 또한 마이그레이션을 할려고하면 기존 서비스에서 커넥션을 모두 죽이고 하는게좋다

```
redis-cli --cluster import <데이터를 가져올 노드 ip:port> --cluster-from <클러스터에 합류할 노드 ip:port> --cluster-copy
```

<br/>

# 복제본을 통한 읽기 성능 향상

- 클러스터의 경우 데이터를 조회할 때 키를 기억하는 마스터 노드에서 데이터를 가져오게 되어있음
- 성능 향상을 위해서 복제본에서 데이터를 가져오고 싶다면 readonly를 통해서 클라이언트가 복제본에서 직접 읽을수있게 하면됨

```
127.0.0.1:6379> readonly
OK
127.0.0.1:6379>
```

<br/>
