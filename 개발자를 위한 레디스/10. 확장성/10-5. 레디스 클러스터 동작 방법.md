# 하트비트 패킷

- 하트비트 패킷은 노드간 서로 정상유무를 확인하기 위해 PING/PONG을 주고받는 패킷을 뜻함
- 일반적으로 클러스터가 주고받은 유형의 패킷에 가십 섹션이 추가된 형태를 띔

### 패킷 헤더의 구성

- 노드 ID
- 현재 Epoch/구성 Epoch : 분산 환경에서 일관성을 유지하기 위한 정보
- 노드 Flag : 노드가 마스터인지 복제본인지에 대한 정보
- 비트맵 : 마스터가 제공하는 해시슬롯의 비트맵 정보, 복제본인 경우 마스터의 정보를 담음
- TCP 포트 : 발신 노드의 TCP 포트
- 클러스터 포트 : 발신 노드의 노드 간 커뮤니케이션을 위한 포트
- 클라스터 상태 : 발신 노드 관점에서 봤을 떄의 클러스터 상태(down/ok)
- 마스터 노드 ID : 복제본 노드인 경우 마스터의 노드 ID

<br/>

# 해시슬롯 구성이 전파되는 방법

- 클러스터의 중요한 기능 중 하나는 명령어에서 사용한 키의 해시슬롯이 어디에 있는지 정확히 파악하고 알려주는것임

### 해시슬롯 구성의 전파 방법

- 하트비트 패킷 : PING/PONG 주고받을 때 가지고있는 해시슬롯을 패킷 데이터에 추가
- 업데이트 메세지
  - 하트비트 패킷에는 발신하는 노드의 구성 Epoch가 포함되어 있음
  - 패킷을 보낸 노드의 Epoch값이 오래됬다면 해당 패킷을 받은 노드는 신규 에포크의 구성정보를 포함한 업데이트 메세지를 보내서 해시슬롯 구성을 업데이트함

<br/>

# 노드 핸드셰이크

- 한 노드가 클러스터에 합류하기 위해서는 CLUSTER MEET 명령어를 보냄
- 기존에 해당 노드를 모르는 노드들은 새로운 연결을 맺음
- 클러스터는 full-mesh 구조이미기 때문에 CLUSTER MEET는 방향성이 없고, 다시 응답을 보낼필요가 없음

<br/>

# 클라스터 라이브 재구성

- 클러스터가 작동되는 동안에도 마스터 노드를 추가하거나 삭제가 가능함
- 내부적으로 `CLUSTER SETSLOT 8 MIGRATING B` 같은 명령어가 전송됨
- 인스턴스 간 모든 키를 마이그레이션 할때는 락이 걸리기 떄문에 경쟁상태가 발생하지 않음
- MIGRATING 커맨드가 완료되면 OK 신호를 보내고 기존 데이터는 삭제됨

<br/>

# 리디렉션

- 레디스 클러스터가 반환하는 리디렉션은 2가지 종류가 존재함

### MOVED

- 요청하는 해시슬롯이 저 노드에 있으니까 앞으로 이 키에 대한 요청은 저 노드로 보내라는 의미
- 언급된 키가 어떤 해시슬롯에 있는지 파악하고 키를 보유한 마스터 노드를 찾음
- 만약 키가 있다면 바로 응답하고, 키가 다른곳에 있다면 에러를 반환함

### ASK

- 지금 요청한 쿼리는 저 노드에 있어, 하지만 다음 요청은 일단 나한테 보내라는 의미
- 해시슬롯에 이동하는 동안에만 발생함
- 리디렉션 오류가 반환한 노드 정보로 쿼리를 재전송하지만, 이후에 같은 키에 대한 쿼리가 들어오면 기존에 전송한 노드에 다시 보내고 클라이언트의 해시슬롯 맵을 업데이트 하지 않음

<br/>

# 장애 감지와 페일오버

클러스터 내부에서 특정 노드가 다른 노드에 접근할 수 없다고 감지하면 노드의 상태를 변경함

### PFAIL(Possible Failure) 플래그

- 일부 노드에서 해당 노드에 접근이 불가능하지만, 아직 확실하지 않은 상태
- NODE_TIMEOUT 시간 이상 도달이 불가능할때 PFAIL로 플래그가 가능함
  - 이 때 마스터, 복제본 등 노드의 역할은 상관없음
- 따라서 노드간 왕복 시간보다 NODE_TIMEOUT 값은 더 커야한다
- PING 이후에 NODE_TIMEOUT의 절반 시간동안 PONG을 못받으면 해당 노드에게 다시 PING을 보내는 방식으로 안전성을 향상시킴

### FAIL 플래그

- 실제로 노드에 장애가 발생해서 페일오버를 진행할려면 FAIL 플래그여야함
- 최초 PFAIL로 플래깅된 이후에 하트비트 패킷에서 해당 정보를 받는데 또 PFAIL이나 FAIL인 경우 해당 노드를 FAIL로 플래깅함

<br/>

# 복제본 선출

- 아래 조건에서 복제본은 페일오버를 직접 시도함
  - 마스터가 FAIL 상태
  - 마스터는 1개 이상의 해시슬롯을 가지고 있음
  - 마스터와 복제가 끊어진지 오래
- 복제본은 마스터가 되기 위해서 자신의 Epoch를 1 증가시키고 마스터 인스턴스에 투표를 요청함

### 내부에서 발생하는 과정

- 복제본은 클러스터 내부 모든 마스터 노드에 FAILOVER_AUTH_REQUEST 패킷을 통해 투표를 요청
- 요청을 받은 마스터 노드는 FAILOVER_AUTH_ACK 패킷으로 긍정적인 응답을 보내서 투표에 동의함을 알림
- 마스터들은 동시에 다른 복제본 승격을 방지하기 위해서 `NODE_TIMEOUT \* 2` 시간동안 다른 복제본에게 투표가 불가능함
  - Epoch 값이 작은 노드에게 온 응답의 경우는 무시해서 거를 수 있음
- 가장 많은 ACK를 받은 복제본이 승격됨
  - `NODE_TIMEOUT * 2` 동안 과반수 이상 마스터에게 응답이 안오면 페일오버는 취소됨
  - `NODE_TIMEOUT * 4` 만큼 지연 이후에 다시 새로운 투표를 시도할 수 있음

### 마스터가 FAIL이 된 이후

- 짧은 딜레이를 가지고나서 투표를 시작하게됨

```
DELAY = 500ms + 랜덤지연시간(0~500ms) + SLAVE_RANK * 1000ms
```
