# 해시슬롯을 이용한 데이터 샤딩

- 클러스터 구조에서 모든 데이터는 해시슬롯에 저장됨
- 총 16384개의 해시슬롯을 가지고 3개의 마스터가 있다면 1개당 16384/3의 슬롯을 가짐
  - 0 ~ 5460, 5461 ~ 10922, 10923 ~ 16383
- 입력되는 모든 키는 1개의 해시슬롯이 저장됨
  - CRC16 암호화한 값을 16384로 나눈 나머지 값을 사용해서 해시슬롯이 결정됨
- 해시슬롯은 마스터 내부에서 자유롭게 이동이 가능하고. 이러한 특성으로 클러스터 내부 마스터 추가/삭제는 굉장히 간단함

<br/>

# 해시태그

- 클러스터를 사용할 때는 다중 키 커맨드 사용이 불가능함
  - `MGET user1:name user2:name` 같은 커맨드
- 해시태그를 사용하면 다중 키 커맨드 사용이 가능함
  - 키에 대괄호를 사용하면 전체 키가 아닌 대괄호 사이 값을 이용해서 해시할 수 있음
  - `user:{123}:profile`, `user:{123}:profile`
  - 위 2개의 값은 대괄호 사이 123 이라는 동일한 값을 갖고있어서 같은 해시슬롯에 저장되는게 보장됨
- 다중 커맨드를 사용하고 싶다면 해시태그를 사용하면 되지만 하나의 해시슬롯에 데이터가 몰릴수도 있으니 키의 분배에 대한 모니터링이 필요할수도 있음

### 해시태그가 저장되는 예시

| 키                   | 해시되는 값 |
| -------------------- | ----------- |
| {user1000}.followers | user1000    |
| user{}id             | user{}id    |
| user{{name}}id       | {name       |
| user{name}{id}       | name        |

<br/>

# 자동 재구성

- 센티널과 마찬가지로 복제와 페일오버를 통해서 고가용성 확보가 가능함
- 센티널은 별도의 인스턴스가 있지만, 클러스터는 레디스끼리 감시한다는 차이점이 있음

### 자동 페일오버

- 프로세스
  - A 마스터에 장애 발생시 AA 복제본은 다른 마스터 노드에게 페일오버를 해도될지 투표요청
  - 다른 마스터 노드는 A가 비정상이라고 생각하면 투표가 가능하며, 과반수가 동의하면 AA는 마스터로 승격함
  - AA도 장애가 발생하면 데이터 정합성을 위해서 전체 상태가 fail로 변함
- 가용성이 중요한 서비스라면 아무 마스터 노드에 자동 복제본 마이그레이션을 위해 복제본을 하나 더 추가하는것을 권장함

### 자동 복제본 마이그레이션

- A, AA / B, BB / C, CC, CCC가 있다고 가정
- A가 다운되면 CCC가 AA의 복제본으로 변경됨, 이를 자동 복제본 마이그레이션이라고 부름
- 일부 설정에 의해서 컨트롤이 가능함
  - `cluster-allow-replica-migration`
    - 기본값인 yes로 자동 복제본 마이그레이션 수행여부
  - `cluster-migration-barrier`
    - 복제본을 최소 몇개 가지고있는지에 대한 설정
    - 2로 지정된 경우 위 상황에서 CCC는 AA의 복제본으로 변경되지 않음
