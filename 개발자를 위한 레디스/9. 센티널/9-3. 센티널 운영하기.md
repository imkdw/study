# 패스워드 인증

- 마스터, 복제본에 requirepass, masterauth를 지정한 경우 센티널 설정파일에도 비밀번호 지정이 필요함
- 언제든지 하위에 있는 복제본 노드가 마스터가 될 수 있으므로 모든 노드는 동일한 비밀번호를 사용해야함

### 비밀번호 설정

```
sentinel auth-pass <master-name> <password>
```

<br/>

# 복제본 우선순위

- 각 인스턴스는 replica-priority 파라미터를 가지고 있음
- 센티널은 이 값이 낮을수록 먼저 마스터로 승격시킴
- 0~100 사이의 값을 가지며 0인 경우 절대 마스터로 승격되지 않음

<br/>

# 운영 중 센티널 정보 변경

- 센티널 실행 도중에도 모니터링할 마스터를 추가/제거/변경이 가능함
- 마스터를 모니터링하는 센티널이 여러대면 각 센티널에 모두 설정해야함
- 해당 설정은 다른 센티널로 전파되지 않음

### 새로운 마스터를 모니터링 하도록 변경

```
SENTINEL MONITOR <master-name> <ip> <port> <quorum>
```

### 더 이상 특정 마스터를 모니터링하지 않도록 변경

```
SENTINEL REMOVE <master-name>
```

### 특정 마스터의 파라미터 변경

```
SENTINEL SET <master-name> down-after-milliseconds <milliseconds>
```

<br/>

# 센티널 초기화

- 센티널은 비정상인 노드에 대해서도 맘대로 모니터링을 멈추지 않음

### 모니터링 중단

```
SENTINEL RESET <master-name>
```

<br/>

# 센티널 노드의 추가/제거

- 마스터를 모니터링 하도록 설정한 인스턴스를 실행하면, 자동 검색 매커니즘에 의해서 기존 실행중이던 다른 센티널의 known-list에 추가됨
- 여러대의 센티널을 추가하는 경우는 약 10초의 텀을 두고 실행하는게 안전함
- `SENTINEL MASTER <master-name>` 명령어를 통해서 잘 추가됬는지 확인해주면 좋음
- 인스턴스에서 오랫동안 응답이 없어도 known-list에서 지워지지 않으므로 직접 제거해야함

<br/>

# 센티널의 자동 페일오버 과정

- 센티널은 최소 3개 이상의 인스턴스가 동시에 동작하는 분산시스템임
- 여러개의 센티널 노드가 레디스를 감시하기 때문에 오탐을 줄일 수 있음

### 마스터의 장애 상황 감지

- 마스터의 핑 요청에 대한 유효한 응답은 +PONG, -LOADING, -MASTERDOWN이며 다른 값은 유효하지 않다고 판단함

### sdown(subjectly down), odown(objectly down) 실패 상태로 전환

- 상태 전환 프로세스
  - 센티널이 마스터 노드에 대한 응답이 늦어지면 일단 sdown 상태로 플래깅
  - 이후 다른 센티널들에게 장애 사실을 전파함
    - `SENTINEL is-master-down-by-addr <ip> <port> <epoch> <*>` 커맨드 전달
  - 전파를 받은 센티널들은 마스터노드 장애 인지여부를 응답
  - 쿼럼값 이상의 센티널에서 마스터노드의 장애를 인지했다면 상태를 odown으로 플래깅
- 센티널은 마스터 노드에 대해서만 odown 상태를 가짐
- 복제본 노드에 장애가 발생하면 sdown으로 플래깅하고, 해당 노드는 마스터로 승격되지 않음

### 에포크 증가

- 센티널은 에포크라는 개념을 이용해서 각 마스터에서 발생한 페일오버 버전을 관리
- 동일한 에포크 값을 이용해서 페일오버가 진행되는 동안 모든 센티널 노드가 같은 작업을 시도한다는것을 보장할 수 있음

### 센티널 리더 선출

- 페일오버 과정동안 에포크를 증가시킨 센티널은 다른 센티널 노드에게 리더를 정하기 위한 투표메세지를 보냄
- 다른 센티널 노드에서는 자신의 에포크랑 비교해서 작으면 증가시키고 투표하겠다는 응답을 보냄
- 에포크가 동일하면 이미 리더로 선출한 센티널의 id를 응답해줌

### 복제본 선정 후 마스터로 승격

- 과반수 이상 센티널이 페일오버에 동의하면, 리더 센티널은 페일어보를 시도하기 위해 마스터로 승격이 가능한 복제본을 선정
  - replica-priority가 낮은 복제본
  - 마스터로부터 더 많은 데이터를 수신한 복제본
  - 2번까지 동일하면 runID가 사전 순으로 작은 복제본
    - 별 의미는 없고 임의로 하나를 결정하는 방식
- 선정된 복제본에는 slaveof no one 커맨드로 기존 마스터랑 연결을 끊음

### 복제 연결 변경

- 새로운 마스터로 승격할 복제본이 선정되면 각 인스턴스에 replicaof 명령어를 날려서 새로운 마스터를 연결시킴

### 장애조치 완료

- 페일오버과정이 끝나면 센티널은 새로운 마스터를 모니터링하기 시작함

<br/>

# 스플릿 브레인 현상

- 네트워크 파티션 이슈로 인해 분산환경의 데이터가 끊어짐
- 끊긴 두 부분이 동기화되지 않고 각각을 정상적인 서비스라고 인식하는 현상
- 복제본에 2개의 마스터가 생기는 현상임
